<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Mongoose Connecting to MongoDB v4.13.20</title><link rel="apple-touch-icon" sizes="57x57" href="images/favicon/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="images/favicon/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="images/favicon/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="images/favicon/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="images/favicon/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="images/favicon/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="images/favicon/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="images/favicon/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="images/favicon/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="images/favicon/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png"><link href="http://fonts.googleapis.com/css?family=Anonymous+Pro:400,700|Droid+Sans+Mono|Open+Sans:400,700|Linden+Hill|Quattrocento:400,700|News+Cycle:400,700|Antic+Slab|Cabin+Condensed:400,700" rel="stylesheet" type="text/css"><link href="css/default.css" rel="stylesheet" type="text/css"><link href="css/guide.css" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="57x57" href="images/favicon/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="images/favicon/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="images/favicon/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="images/favicon/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="images/favicon/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="images/favicon/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="images/favicon/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="images/favicon/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="images/favicon/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="images/favicon/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png"><link rel="manifest" href="images/favicon/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="images/favicon/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"></head><body><a id="forkbanner" href="http://github.com/Automattic/mongoose"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a><div id="links"><div id="header"><h1><a href="../index.html"><div class="mongoose">Mongoose</div></a></h1></div><ul><li class="home"><a href="../index.html">home</a></li><li class="faq"><a href="./faq.html">FAQ</a></li><li class="plugins"><a href="http://plugins.mongoosejs.com">plugins</a></li><li class="changelog"><a href="http://github.com/Automattic/mongoose/tree/master/History.md">change log</a></li><li class="support"><a href="../index.html#support">support</a></li><li class="fork"><a href="http://github.com/Automattic/mongoose">fork</a></li><li class="guide"><a href="./guide.html">guide</a><ul><li class="double"><a href="./guide.html">schemas</a><ul><li class="schematypes"><a href="./schematypes.html"><span>schema</span>types</a></li><li class="custom-schema-types"><a href="./customschematypes.html">custom schema types</a></li><li class="advanced-schemas"><a href="./advanced_schemas.html">advanced usage</a></li></ul></li><li><a href="./models.html">models</a></li><li class="double"><a href="./documents.html">documents</a><ul><li class="subdocs"><a href="./subdocs.html">sub docs</a></li><li class="defaults"><a href="./defaults.html">defaults</a></li></ul></li><li><a href="./queries.html">queries</a></li><li><a href="./validation.html">validation</a></li><li><a href="./middleware.html">middleware</a></li><li><a href="./populate.html">population</a></li><li><a href="./connections.html">connections</a></li><li><a href="./plugins.html">plugins</a></li><li><a href="./promises.html">promises</a></li><li><a href="./discriminators.html">discriminators</a></li><li><a href="https://github.com/Automattic/mongoose/blob/master/CONTRIBUTING.md">contributing</a></li><li><a href="./harmony.html">ES2015 integration</a></li><li><a href="./browser.html">schemas in the browser</a></li><li><a href="./compatibility.html">MongoDB Version Compatibility</a></li><li><a href="https://github.com/Automattic/mongoose/wiki/3.6-Release-Notes">3.6 release notes</a></li><li><a href="https://github.com/Automattic/mongoose/wiki/3.8-Release-Notes">3.8 release notes</a></li><li><a href="https://github.com/Automattic/mongoose/wiki/4.0-Release-Notes">4.0 release notes</a></li></ul></li><li class="api"><a href="./api.html">API docs</a></li><li class="quickstart"><a href="./index.html">quick start</a></li><li class="contrib"><a href="http://github.com/Automattic/mongoose/contributors">contributors</a></li><li class="prior"><a href="./prior.html">prior releases</a></li></ul></div><div id="content"><div class="module"><gcse:search></gcse:search><h2>Connections</h2><p>You can connect to MongoDB with the <code>mongoose.connect()</code> method.</p><pre><code class="javascript">mongoose.connect(<span class="string">'mongodb://localhost/myapp'</span>);
</code></pre><p>This is the minimum needed to connect the <code>myapp</code> database running locally
on the default port (27017). If the local connection fails then try using
127.0.0.1 instead of localhost. Sometimes issues may arise when the local
hostname has been changed.</p>

<p>You can also specify several more parameters in the <code>uri</code>:</p><pre><code class="javascript">mongoose.connect(<span class="string">'mongodb://username:password@host:port/database?options...'</span>);
</code></pre><p>See the <a href="http://docs.mongodb.org/manual/reference/connection-string/">mongodb connection string spec</a> for more detail.</p><h3 id="buffering">Operation Buffering</h3><p>Mongoose lets you start using your models immediately, without waiting for
mongoose to establish a connection to MongoDB.</p><pre><code class="javascript">mongoose.connect(<span class="string">'mongodb://localhost/myapp'</span>);
<span class="keyword">var</span> MyModel = mongoose.model(<span class="string">'Test'</span>, <span class="keyword">new</span> Schema({ name: String }));
<span class="comment">// Works</span>
MyModel.findOne(<span class="keyword">function</span>(error, result) { <span class="comment">/* ... */</span> });
</code></pre><p>That&#39;s because mongoose buffers model function calls internally. This
buffering is convenient, but also a common source of confusion. Mongoose
will <em>not</em> throw any errors by default if you use a model without
connecting.</p><pre><code class="javascript"><span class="keyword">var</span> MyModel = mongoose.model(<span class="string">'Test'</span>, <span class="keyword">new</span> Schema({ name: String }));
<span class="comment">// Will just hang until mongoose successfully connects</span>
MyModel.findOne(<span class="keyword">function</span>(error, result) { <span class="comment">/* ... */</span> });

setTimeout(<span class="keyword">function</span>() {
  mongoose.connect(<span class="string">'mongodb://localhost/myapp'</span>);
}, <span class="number">60000</span>);
</code></pre><p>To disable buffering, turn off the <a href="./guide.html#bufferCommands"><code>bufferCommands</code> option on your schema</a>.
If you have <code>bufferCommands</code> on and your connection is hanging, try turning
<code>bufferCommands</code> off to see if you haven&#39;t opened a connection properly.</p><h3 id="options">Options</h3><p>The <code>connect</code> method also accepts an <code>options</code> object which will be passed on to the underlying MongoDB driver.</p><pre><code class="javascript">mongoose.connect(uri, options);
</code></pre><p>A full list of options can be found on the <a href="http://mongodb.github.io/node-mongodb-native/2.2/api/MongoClient.html#connect">MongoDB Node.js driver docs for <code>connect()</code></a>.
Mongoose passes options to the driver without modification, modulo three exceptions that are explained below.</p>

<ul><li><code>useMongoClient</code>    - This is a mongoose-specific option (not passed to the MongoDB driver) that opts in to mongoose 4.11&#39;s new connection logic. If you are writing a new application, you <strong>should</strong> set this to <code>true</code>.</li><li><code>user</code>/<code>pass</code>       - The username and password for authentication. These options are mongoose-specific, they are equivalent to the MongoDB driver&#39;s <code>auth.user</code> and <code>auth.password</code> options.</li><li><code>autoIndex</code>         - By default, mongoose will automatically build indexes defined in your schema when it connects. This is great for development, but not ideal for large production deployments, because index builds can cause performance degradation. If you set <code>autoIndex</code> to false, mongoose will not automatically build indexes for <strong>any</strong> model associated with this connection.</li></ul>

<p>Below are some of the options that are important for tuning mongoose.</p>

<ul><li><code>autoReconnect</code>     - The underlying MongoDB driver will automatically try to reconnect when it loses connection to MongoDB. Unless you are an extremely advanced user that wants to manage their own connection pool, do <strong>not</strong> set this option to <code>false</code>.</li><li><code>reconnectTries</code>    - If you&#39;re connected to a single server or mongos proxy (as opposed to a replica set), the MongoDB driver will try to reconnect every <code>reconnectInterval</code> milliseconds for <code>reconnectTries</code> times, and give up afterward. When the driver gives up, the mongoose connection emits a <code>reconnectFailed</code> event. This option does nothing for replica set connections.</li><li><code>reconnectInterval</code> - See <code>reconnectTries</code></li><li><code>promiseLibrary</code>    - sets the <a href="http://mongodb.github.io/node-mongodb-native/2.1/api/MongoClient.html">underlying driver&#39;s promise library</a></li><li><code>poolSize</code>          - The maximum number of sockets the MongoDB driver will keep open for this connection. By default, <code>poolSize</code> is 5. Keep in mind that, as of MongoDB 3.4, MongoDB only allows one operation per socket at a time, so you may want to increase this if you find you have a few slow queries that are blocking faster queries from proceeding.</li><li><code>bufferMaxEntries</code>  - The MongoDB driver also has its own buffering mechanism that kicks in when the driver is disconnected. Set this option to 0 and set <code>bufferCommands</code> to <code>false</code> on your schemas if you want your database operations to fail immediately when the driver is not connected, as opposed to waiting for reconnection.</li></ul>

<p>Example:</p><pre><code class="javascript"><span class="keyword">var</span> options = {
  useMongoClient: <span class="literal">true</span>,
  autoIndex: <span class="literal">false</span>, <span class="comment">// Don't build indexes</span>
  reconnectTries: Number.MAX_VALUE, <span class="comment">// Never stop trying to reconnect</span>
  reconnectInterval: <span class="number">500</span>, <span class="comment">// Reconnect every 500ms</span>
  poolSize: <span class="number">10</span>, <span class="comment">// Maintain up to 10 socket connections</span>
  <span class="comment">// If not connected, return errors immediately rather than waiting for reconnect</span>
  bufferMaxEntries: <span class="number">0</span>
};
mongoose.connect(uri, options);
</code></pre><h3 id="callback">Callback</h3><p>The <code>connect()</code> function also accepts a callback parameter and returns a <a href="./promises.html">promise</a>.</p><pre><code class="javascript">mongoose.connect(uri, options, <span class="keyword">function</span>(error) {
  <span class="comment">// Check error in initial connection. There is no 2nd param to the callback.</span>
});

<span class="comment">// Or using promises</span>
mongoose.connect(uri, options).then(
  () => { <span class="comment">/** ready to use. The `mongoose.connect()` promise resolves to undefined. */</span> },
  err => { <span class="comment">/** handle initial connection error */</span> }
);
</code></pre><h4 id="connection-string-options">Connection String Options</h4><p>You can also specify options in your connection string as <a href="https://en.wikipedia.org/wiki/Query_string">parameters in the query string</a> portion of the URI.</p><pre><code class="javascript">mongoose.connect(<span class="string">'mongodb://localhost:27017/test?connectTimeoutMS=1000'</span>, { useMongoClient: <span class="literal">true</span> });
<span class="comment">// The above is equivalent to:</span>
mongoose.connect(<span class="string">'mongodb://localhost:27017/test'</span>, {
  useMongoClient: <span class="literal">true</span>,
  connectTimeoutMS: <span class="number">1000</span>
});</code></pre><p>The disadvantage of putting options in the query string is that query
string options are harder to read. The advantage is that you only need a
single configuration option, the URI, rather than separate options for
<code>socketTimeoutMS</code>, <code>connectTimeoutMS</code>, etc. Best practice is to put options
that likely differ between development and production, like <code>replicaSet</code>
or <code>ssl</code>, in the connection string, and options that should remain constant,
like <code>connectTimeoutMS</code> or <code>poolSize</code>, in the options object.</p>

<p>The MongoDB docs have a full list of <a href="https://docs.mongodb.com/manual/reference/connection-string/">supported connection string options</a></p><h4 id="keepAlive">A note about keepAlive</h4><div class="important"><p>For long running applications, it is often prudent to enable <code>keepAlive</code>
with a number of milliseconds. Without it, after some period of time
you may start to see <code>&quot;connection closed&quot;</code> errors for what seems like
no reason. If so, after
<a href="http://tldp.org/HOWTO/TCP-Keepalive-HOWTO/overview.html">reading this</a>,
you may decide to enable <code>keepAlive</code>:</p></div><pre><code class="javascript">options.server.socketOptions = options.replset.socketOptions = { keepAlive: <span class="number">120</span> };
mongoose.connect(uri, options);
</code></pre><h3 id="replicaset_connections">Replica Set Connections</h3><p>To connect to a replica set you pass a comma delimited list of hosts to
connect to rather than a single host.</p><pre><code class="javascript">mongoose.connect(<span class="string">'mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]'</span> [, options]);
</code></pre><p>To connect to a single node replica set, specify the <code>replicaSet</code> option.</p><pre><code class="javascript">mongoose.connect(<span class="string">'mongodb://host1:port1/?replicaSet=rsName'</span>);
</code></pre><h3 id="mongos_connections">Multi-mongos support</h3><p>High availability over multiple <code>mongos</code> instances is also supported.
Pass a connection string for your <code>mongos</code> instances. If you are not using
the <code>useMongoClient</code> option, you must also set the <code>mongos</code> option:</p><pre><code class="javascript">mongoose.connect(<span class="string">'mongodb://mongosA:27501,mongosB:27501'</span>, { mongos: <span class="literal">true</span> }, cb);</code></pre><p>With <code>useMongoClient</code>, you do not need to set the <code>mongos</code> option. You also
do <strong>not</strong> need to use <code>mongos</code> or <code>useMongoClient</code> in mongoose 5.x.</p><pre><code class="javascript">mongoose.connect(<span class="string">'mongodb://mongosA:27501,mongosB:27501'</span>, { useMongoClient: <span class="literal">true</span> }, cb);
</code></pre><h3 id="multiple_connections">Multiple connections</h3><p>So far we&#39;ve seen how to connect to MongoDB using Mongoose&#39;s default connection. At times we may need multiple connections open to Mongo, each with different read/write settings, or maybe just to different databases for example. In these cases we can utilize <code>mongoose.createConnection()</code> which accepts all the arguments already discussed and returns a fresh connection for you.</p><pre><code class="javascript"><span class="keyword">var</span> conn = mongoose.createConnection(<span class="string">'mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]'</span>, options);
</code></pre><p>This <a href="./api.html#connection_Connection">connection</a> object is then used to
create and retrieve <a href="./api.html#model_Model">models</a>. Models are
<strong>always</strong> scoped to a single connection.</p><h3 id="connection_pools">Connection pools</h3><p>Each <code>connection</code>, whether created with <code>mongoose.connect</code> or <code>mongoose.createConnection</code> are all backed by an internal configurable connection pool defaulting to a maximum size of 5. Adjust the pool size using your connection options:</p><pre><code class="javascript"><span class="comment">// single server</span>
<span class="keyword">var</span> uri = <span class="string">'mongodb://localhost/test'</span>;
mongoose.createConnection(uri, { server: { poolSize: <span class="number">4</span> }});

<span class="comment">// for a replica set</span>
mongoose.createConnection(uri, { replset: { poolSize: <span class="number">4</span> }});

<span class="comment">// passing the option in the URI works with single or replica sets</span>
<span class="keyword">var</span> uri = <span class="string">'mongodb://localhost/test?poolSize=4'</span>;
mongoose.createConnection(uri);
</code></pre><h3 id="use-mongo-client">The `useMongoClient` Option</h3><p>Mongoose&#39;s default connection logic is deprecated as of 4.11.0. Please opt
in to the new connection logic using the <code>useMongoClient</code> option, but
make sure you test your connections first if you&#39;re upgrading an existing
codebase!</p><pre><code class="javascript"><span class="comment">// Using `mongoose.connect`...</span>
<span class="keyword">var</span> promise = mongoose.connect(<span class="string">'mongodb://localhost/myapp'</span>, {
  useMongoClient: <span class="literal">true</span>,
  <span class="comment">/* other options */</span>
});
<span class="comment">// Or `createConnection`</span>
<span class="keyword">var</span> promise = mongoose.createConnection(<span class="string">'mongodb://localhost/myapp'</span>, {
  useMongoClient: <span class="literal">true</span>,
  <span class="comment">/* other options */</span>
});
promise.then(<span class="keyword">function</span>(db) {
  <span class="comment">/* Use `db`, for instance `db.model()`
});
// Or, if you already have a connection
connection.openUri('mongodb://localhost/myapp', { /* options */</span> });</code></pre><p>The parameters to <code>openUri()</code> are passed transparently to the
<a href="http://mongodb.github.io/node-mongodb-native/2.2/api/MongoClient.html#connect">underlying MongoDB driver&#39;s <code>MongoClient.connect()</code> function</a>.
Please see the <a href="http://mongodb.github.io/node-mongodb-native/2.2/api/MongoClient.html#connect">driver documentation for this function</a> for options.
The same is true for <code>connect()</code> and <code>createConnection()</code> if <code>useMongoClient</code> is <code>true</code>.</p><p>You may see the following deprecation warning with <code>useMongoClient</code>:</p>

<p><code>
the server/replset/mongos options are deprecated, all their options are supported at the top level of the options object
</code></p>

<p>In older version of the MongoDB driver you had to specify distinct options for server connections, replica set connections, and mongos connections:</p><pre><code class="javascript">mongoose.connect(myUri, {
  server: {
    socketOptions: {
      socketTimeoutMS: <span class="number">0</span>,
      keepAlive: <span class="literal">true</span>
    },
    reconnectTries: <span class="number">30</span>
  },
  replset: {
    socketOptions: {
      socketTimeoutMS: <span class="number">0</span>,
      keepAlive: <span class="literal">true</span>
    },
    reconnectTries: <span class="number">30</span>
  },
  mongos: {
    socketOptions: {
      socketTimeoutMS: <span class="number">0</span>,
      keepAlive: <span class="literal">true</span>
    },
    reconnectTries: <span class="number">30</span>
  }
});</code></pre><p>With <code>useMongoClient</code> you can instead declare these options at the top level, without all that extra nesting. <a href="http://mongodb.github.io/node-mongodb-native/2.2/api/MongoClient.html">Here&#39;s the list of all supported options</a>.</p><pre><code class="javascript"><span class="comment">// Equivalent to the above code</span>
mongoose.connect(myUri, {
  socketTimeoutMS: <span class="number">0</span>,
  keepAlive: <span class="literal">true</span>,
  reconnectTries: <span class="number">30</span>
});
</code></pre><p>This deprecation is because the <a href="https://www.npmjs.com/package/mongodb">MongoDB driver</a>
has deprecated an API that is critical to mongoose&#39;s connection logic to
support MongoDB 3.6, see <a href="https://github.com/Automattic/mongoose/issues/5304">this github issue</a>
and <a href="http://thecodebarbarian.com/mongoose-4.11-use-mongo-client.html">this blog post</a>
for more details.</p><h3 id="next">Next Up</h3><p>Now that we&#39;ve covered <code>connections</code>, let&#39;s take a look at how we can break pieces of our functionality out into reusable and shareable <a href="/docs/plugins.html">plugins</a>.</p></div></div><script>document.body.className = 'load';</script><script>;(function() {
  var cx = '012173159455227967368:uvscsuqjovs';
  var gcse = document.createElement('script');
  gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol === 'https:' ? 'https:' : 'http:') +
      '//www.google.com/cse/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();</script><script type="text/javascript">!function(name,path,ctx){
  var latest,prev=name!=='Keen'&&window.Keen?window.Keen:false;ctx[name]=ctx[name]||{ready:function(fn){var h=document.getElementsByTagName('head')[0],s=document.createElement('script'),w=window,loaded;s.onload=s.onerror=s.onreadystatechange=function(){if((s.readyState&&!(/^c|loade/.test(s.readyState)))||loaded){return}s.onload=s.onreadystatechange=null;loaded=1;latest=w.Keen;if(prev){w.Keen=prev}else{try{delete w.Keen}catch(e){w.Keen=void 0}}ctx[name]=latest;ctx[name].ready(fn)};s.async=1;s.src=path;h.parentNode.insertBefore(s,h)}}
}('KeenAsync','https://d26b395fwzu5fz.cloudfront.net/keen-tracking-1.1.3.min.js',this);

KeenAsync.ready(function(){
  // Configure a client instance
  var client = new KeenAsync({
    projectId: '59aad9cbc9e77c0001ce1b32',
    writeKey: '4B38B0046086885E425D368BFAEAD8FD0D4F2DC2FA2F936FDE058D79508AEFAD9886BC020B96520823BB9C8241D9D9BCFDC0EF52E6033BD89D06E4B24FC13AE955896BF443406269A84DD009CEB5862DCEC944874DB2107FD648DA91ADC1E6DE'
  });
  
  client.recordEvent('pageView', {
    host: window.location.host,
    pathname: window.location.pathname,
    hash: window.location.hash
  });
});</script></body></html>