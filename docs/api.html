<html>
	<head>
		<title>Mongooose</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
		<style>body {
    margin: 0;
    padding: 0;
    font: 14px/1.5 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    color: #252519;
}
a {
    color: #252519;
}
a:hover {
    text-decoration: underline;
    color: #19469D;
}
p {
    margin: 12px 0;
}
h1, h2, h3 {
    margin: 0;
    padding: 0;
}
table#source {
    width: 100%;
    border-collapse: collapse;
}
table#source td:first-child {
    padding: 30px 40px 30px 40px;
    vertical-align: top;
}
table#source td:first-child,
table#source td:first-child pre {
    width: 450px;
}
table#source td:last-child {
    padding: 30px 0 30px 40px;
    border-left: 1px solid #E5E5EE;
    background: #F5F5FF;
}
table#source tr {
    border-bottom: 1px solid #E5E5EE;
}
table#source tr.filename {
    padding-top: 40px;
    border-top: 1px solid #E5E5EE;
}
table#source tr.filename td:first-child {
    text-transform: capitalize;
}
table#source tr.filename td:last-child {
    font-size: 12px;
}
table#source tr.filename h2 {
    margin: 0;
    padding: 0;
    cursor: pointer;
}
table#source tr.code h1,
table#source tr.code h2,
table#source tr.code h3 {
    margin-top: 30px;
    font-family: "Lucida Grande", "Helvetica Nueue", Arial, sans-serif;
    font-size: 18px;
}
table#source tr.code h2 {
    font-size: 16px;
}
table#source tr.code h3 {
    font-size: 14px;
}
table#source tr.code ul {
    margin: 15px 0 15px 35px;
    padding: 0;
}
table#source tr.code ul li {
    margin: 0;
    padding: 1px 0;
}
table#source tr.code ul li p {
    margin: 0;
    padding: 0;
}
table#source tr.code td:first-child pre {
    padding: 20px;
}
#ribbon {
    position: fixed;
    top: 0;
    right: 0;
}
code .string { color: #219161; }
code .regexp { color: #219161; }
code .keyword { color: #954121; }
code .number { color: #19469D; }
code .comment { color: #bbb; }
code .this { color: #19469D; }</style>
		<script>
			$(function(){
				$('tr.code').hide();
				$('tr.filename').toggle(function(){
					$(this).nextUntil('.filename').fadeIn();
				}, function(){
					$(this).nextUntil('.filename').fadeOut();
				});
			});
		</script>
	</head>
	<body>
<table id="source"><tbody><tr><td><h1>Mongooose</h1><p>Expressive MongoDB for Node.JS</p></td><td></td></tr><tr class="filename"><td><h2 id="lib/mongoose/collection.js"><a href="#">collection</a></h2></td><td>lib/mongoose/collection.js</td></tr><tr class="code">
<td class="docs">
<p>Collection constructor</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  collection name</p></li><li><p><strong>param</strong>: <em>Collection</em>  connection object</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Collection</span> (<span class="variable">name</span>, <span class="variable">conn</span>) {
  <span class="this">this</span>.<span class="variable">name</span> = <span class="variable">name</span>;
  <span class="this">this</span>.<span class="variable">conn</span> = <span class="variable">conn</span>;
  <span class="this">this</span>.<span class="variable">conn</span>.<span class="variable">on</span>(<span class="string">'open'</span>, <span class="this">this</span>.<span class="variable">onOpen</span>.<span class="variable">bind</span>(<span class="this">this</span>));
  <span class="this">this</span>.<span class="variable">conn</span>.<span class="variable">on</span>(<span class="string">'close'</span>, <span class="this">this</span>.<span class="variable">onClose</span>.<span class="variable">bind</span>(<span class="this">this</span>));
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">conn</span>.<span class="variable">readyState</span> == <span class="number integer">1</span>) <span class="this">this</span>.<span class="variable">onOpen</span>();
  <span class="this">this</span>.<span class="variable">queue</span> = [];
  <span class="this">this</span>.<span class="variable">buffer</span> = <span class="variable">true</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>The collection name</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">name</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>The Connection instance</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">conn</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Called when the database connects</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">onOpen</span> = <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;
  <span class="this">this</span>.<span class="variable">buffer</span> = <span class="variable">false</span>;
  <span class="variable">self</span>.<span class="variable">doQueue</span>();
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Called when the database disconnects</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">onClose</span> = <span class="keyword">function</span> () {
  <span class="this">this</span>.<span class="variable">buffer</span> = <span class="variable">true</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds a callback to the queue</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  method name</p></li><li><p><strong>param</strong>: <em>Array</em>  arguments</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">addQueue</span> = <span class="keyword">function</span> (<span class="variable">name</span>, <span class="variable">args</span>) {
  <span class="this">this</span>.<span class="variable">queue</span>.<span class="variable">push</span>([<span class="variable">name</span>, <span class="variable">args</span>]);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Executes the current queue</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">doQueue</span> = <span class="keyword">function</span> () {
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="this">this</span>.<span class="variable">queue</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++){
    <span class="this">this</span>[<span class="this">this</span>.<span class="variable">queue</span>[<span class="variable">i</span>][<span class="number integer">0</span>]].<span class="variable">apply</span>(<span class="this">this</span>, <span class="this">this</span>.<span class="variable">queue</span>[<span class="variable">i</span>][<span class="number integer">1</span>]);
  }
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Ensure index function</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">ensureIndex</span> = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Collection#ensureIndex unimplemented by driver'</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>FindAndModify command</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">findAndModify</span> = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Collection#findAndModify unimplemented by driver'</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>FindOne command</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">findOne</span> = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Collection#findOne unimplemented by driver'</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Find command</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">find</span> = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Collection#find unimplemented by driver'</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Insert command</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">insert</span> = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Collection#insert unimplemented by driver'</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Update command</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">save</span> = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Collection#save unimplemented by driver'</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Insert command</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">update</span> = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Collection#update unimplemented by driver'</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>getIndexes command</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">getIndexes</span> = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Collection#getIndexes unimplemented by driver'</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">Collection</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/connection.js"><a href="#">connection</a></h2></td><td>lib/mongoose/connection.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">url</span> = <span class="variable">require</span>(<span class="string">'url'</span>)
  , <span class="variable">utils</span> = <span class="variable">require</span>(<span class="string">'./utils'</span>)
  , <span class="class">EventEmitter</span> = <span class="variable">utils</span>.<span class="class">EventEmitter</span>
  , <span class="variable">driver</span> = <span class="variable">global</span>.<span class="class">MONGOOSE_DRIVER_PATH</span> || <span class="string">'./drivers/node-mongodb-native'</span>
  , <span class="class">Model</span> = <span class="variable">require</span>(<span class="string">'./model'</span>)
  , <span class="class">Collection</span>  = <span class="variable">require</span>(<span class="variable">driver</span> + <span class="string">'/collection'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Connection constructor. For practical reasons, a Connection equals a Db</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Mongoose</em>  mongoose base</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Connection</span> (<span class="variable">base</span>) {
  <span class="this">this</span>.<span class="variable">base</span> = <span class="variable">base</span>;
  <span class="this">this</span>.<span class="variable">collections</span> = {};
  <span class="this">this</span>.<span class="variable">models</span> = {};
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherit from EventEmitter.</p>

<p> </p>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">EventEmitter</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Connection ready state:
 0 = Disconnected
 1 = Connected
 2 = Connecting
 3 = Disconnecting</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">readyState</span> = <span class="number integer">0</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>A hash of the collections associated with this connection</p>

<ul><li><p><strong>param</strong>: <em>text</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">collections</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>The mongodb.Db instance, set when the connection is opened</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">db</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Establishes the connection</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  mongodb://uri</p></li><li><p><strong>return</strong>: <em>Connection</em>  self</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">open</span> = <span class="keyword">function</span> (<span class="variable">host</span>, <span class="variable">database</span>, <span class="variable">port</span>, <span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>
    , <span class="variable">uri</span>;

  <span class="comment">// if we've been supplied an uri</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable">database</span> != <span class="string">'string'</span>){
    <span class="variable">uri</span> = <span class="variable">url</span>.<span class="variable">parse</span>(<span class="variable">host</span>);
    <span class="variable">host</span> = <span class="variable">uri</span>.<span class="variable">hostname</span>;
    <span class="variable">port</span> = <span class="variable">uri</span>.<span class="variable">port</span> || <span class="number integer">27017</span>;
    <span class="variable">callback</span> = <span class="variable">database</span>;
    <span class="variable">database</span> = <span class="variable">uri</span>.<span class="variable">pathname</span>.<span class="variable">replace</span>(<span class="regexp">/\/</span>/<span class="variable">g</span>, <span class="string">''</span>);
  } <span class="keyword">else</span> {
    <span class="variable">callback</span> = <span class="variable">callback</span> || <span class="variable">port</span>;
    <span class="variable">port</span> = <span class="keyword">typeof</span> <span class="variable">port</span> == <span class="string">'number'</span> ? <span class="variable">port</span> : <span class="number integer">27017</span>;
  }
  
  <span class="comment">// make sure we can open</span>
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">readyState</span> != <span class="number integer">0</span>){
    <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="variable">callback</span>)
      <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Trying to open unclosed connection'</span>));
    <span class="keyword">return</span> <span class="this">this</span>;
  }

  <span class="comment">// handle authentication</span>
  <span class="keyword">if</span> (<span class="variable">uri</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">uri</span>.<span class="variable">auth</span>){
    <span class="keyword">var</span> <span class="variable">auth</span> = <span class="variable">uri</span>.<span class="variable">auth</span>.<span class="variable">split</span>(<span class="string">':'</span>);
    <span class="this">this</span>.<span class="variable">user</span> = <span class="variable">auth</span>[<span class="number integer">0</span>];
    <span class="this">this</span>.<span class="variable">pass</span> = <span class="variable">auth</span>[<span class="number integer">1</span>];
  } <span class="keyword">else</span> 
    <span class="this">this</span>.<span class="variable">user</span> = <span class="this">this</span>.<span class="variable">pass</span> = <span class="variable">undefined</span>;
  
  <span class="keyword">if</span> (!<span class="variable">host</span>) {
    <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="variable">callback</span>)
      <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Please provide a valid hostname.'</span>));
    <span class="keyword">return</span> <span class="this">this</span>;
  }

  <span class="keyword">if</span> (!<span class="variable">database</span>) {
    <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="variable">callback</span>)
      <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Please provide a database to connect to.'</span>));
    <span class="keyword">return</span> <span class="this">this</span>;
  }

  <span class="this">this</span>.<span class="variable">name</span> = <span class="variable">database</span>;
  <span class="this">this</span>.<span class="variable">host</span> = <span class="variable">host</span>;
  <span class="this">this</span>.<span class="variable">port</span> = <span class="variable">port</span>;

  <span class="comment">// signal connecting</span>
  <span class="this">this</span>.<span class="variable">readyState</span> = <span class="number integer">2</span>;
  <span class="this">this</span>.<span class="variable">emit</span>(<span class="string">'opening'</span>);

  <span class="comment">// open connection</span>
  <span class="this">this</span>.<span class="variable">doOpen</span>(<span class="keyword">function</span>(<span class="variable">err</span>){
    <span class="keyword">if</span> (<span class="variable">err</span>) {
      <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable">callback</span> == <span class="string">'function'</span>) <span class="variable">callback</span>(<span class="variable">err</span>);
    } <span class="keyword">else</span> {
      <span class="variable">self</span>.<span class="variable">onOpen</span>();
      <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable">callback</span> == <span class="string">'function'</span>) <span class="variable">callback</span>(<span class="keyword">null</span>);
    }
  });

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Called when the connection is opened</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">onOpen</span> = <span class="keyword">function</span> () {
  <span class="this">this</span>.<span class="variable">readyState</span> = <span class="number integer">1</span>;
  <span class="this">this</span>.<span class="variable">emit</span>(<span class="string">'open'</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Closes the connection</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  optional callback</p></li><li><p><strong>return</strong>: <em>Connection</em>  self</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">close</span> = <span class="keyword">function</span> (<span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="keyword">switch</span> (<span class="this">this</span>.<span class="variable">readyState</span>){
    <span class="keyword">case</span> <span class="number integer">0</span>: <span class="comment">// disconnected</span>
      <span class="variable">callback</span>(<span class="keyword">null</span>);
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number integer">1</span>: <span class="comment">// connected </span>
      <span class="this">this</span>.<span class="variable">readyState</span> = <span class="number integer">3</span>;
      <span class="this">this</span>.<span class="variable">doClose</span>(<span class="keyword">function</span>(<span class="variable">err</span>){
        <span class="keyword">if</span> (<span class="variable">err</span>){
          <span class="keyword">if</span> (<span class="variable">callback</span>) <span class="variable">callback</span>(<span class="variable">err</span>);
        } <span class="keyword">else</span> {
          <span class="variable">self</span>.<span class="variable">onClose</span>();
          <span class="keyword">if</span> (<span class="variable">callback</span>) <span class="variable">callback</span>(<span class="keyword">null</span>);
        }
      });
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number integer">2</span>: <span class="comment">// connecting</span>
      <span class="this">this</span>.<span class="variable">once</span>(<span class="string">'open'</span>, <span class="keyword">function</span>(){
        <span class="variable">self</span>.<span class="variable">close</span>(<span class="variable">callback</span>);
      });
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number integer">3</span>: <span class="comment">// disconnecting</span>
      <span class="this">this</span>.<span class="variable">once</span>(<span class="string">'close'</span>, <span class="keyword">function</span> () {
        <span class="variable">callback</span>(<span class="keyword">null</span>);
      });
      <span class="keyword">break</span>;
  }

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Called when the connection closes</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">onClose</span> = <span class="keyword">function</span> () {
  <span class="this">this</span>.<span class="variable">readyState</span> = <span class="number integer">0</span>;
  <span class="this">this</span>.<span class="variable">emit</span>(<span class="string">'close'</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Retrieves a collection, creating it if not cached.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  collection name</p></li><li><p><strong>return</strong>: <em>Collection</em>  collection instance</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">collection</span> = <span class="keyword">function</span> (<span class="variable">name</span>) {
  <span class="keyword">if</span> (!(<span class="variable">name</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">collections</span>))
    <span class="this">this</span>.<span class="variable">collections</span>[<span class="variable">name</span>] = <span class="keyword">new</span> <span class="class">Collection</span>(<span class="variable">name</span>, <span class="this">this</span>);
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">collections</span>[<span class="variable">name</span>];
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Defines a model or retrieves it</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  model name</p></li><li><p><strong>param</strong>: <em>Schema</em>  schema object</p></li><li><p><strong>param</strong>: <em>String</em>  collection name (optional, induced from model name)</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">model</span> = <span class="keyword">function</span> (<span class="variable">name</span>, <span class="variable">collection</span>) {
  <span class="variable">collection</span> || (<span class="variable">collection</span> = <span class="variable">utils</span>.<span class="variable">toCollectionName</span>(<span class="variable">name</span>));
  <span class="comment">// look up models for the collection</span>
  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">models</span>[<span class="variable">collection</span>])
    <span class="this">this</span>.<span class="variable">models</span>[<span class="variable">collection</span>] = {};

  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">models</span>[<span class="variable">collection</span>][<span class="variable">name</span>]){
    <span class="keyword">var</span> <span class="variable">model</span> = <span class="this">this</span>.<span class="variable">base</span>.<span class="variable">model</span>(<span class="variable">name</span>, <span class="keyword">null</span>, <span class="variable">collection</span>, <span class="variable">true</span>)
      , <span class="class">Model</span>;
    
    <span class="keyword">if</span> (<span class="variable">model</span>.<span class="variable">prototype</span>.<span class="variable">connection</span> != <span class="this">this</span>){
      <span class="keyword">function</span> <span class="class">Model</span> (){
        <span class="variable">model</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
      };

      <span class="class">Model</span>.<span class="variable">__proto__</span> = <span class="variable">model</span>;
      <span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="variable">model</span>.<span class="variable">prototype</span>;
      <span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">db</span> = <span class="this">this</span>;
      <span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">collection</span> = <span class="this">this</span>.<span class="variable">collection</span>(<span class="variable">collection</span>);
      <span class="class">Model</span>.<span class="variable">init</span>();
    }

    <span class="this">this</span>.<span class="variable">models</span>[<span class="variable">collection</span>][<span class="variable">name</span>] = <span class="class">Model</span> || <span class="variable">model</span>;
  }
  
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">models</span>[<span class="variable">collection</span>][<span class="variable">name</span>];
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">Connection</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/drivers/node-mongodb-native/collection.js"><a href="#">collection</a></h2></td><td>lib/mongoose/drivers/node-mongodb-native/collection.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">Collection</span> = <span class="variable">require</span>(<span class="string">'../../collection'</span>)
  , <span class="class">MongoCollection</span> = <span class="variable">require</span>(<span class="string">'../../../../support/node-mongodb-native/lib/mongodb/'</span>).<span class="class">Collection</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Native collection</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">NativeCollection</span> () {
  <span class="class">Collection</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherit from Collection.
 </p>
</td>
<td class="code">
<pre><code><span class="class">NativeCollection</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">Collection</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Called when the connection opens</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">NativeCollection</span>.<span class="variable">prototype</span>.<span class="variable">onOpen</span> = <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;
  <span class="this">this</span>.<span class="variable">conn</span>.<span class="variable">db</span>.<span class="variable">collection</span>(<span class="this">this</span>.<span class="variable">name</span>, <span class="keyword">function</span>(<span class="variable">err</span>, <span class="variable">collection</span>){
    <span class="keyword">if</span> (!<span class="variable">err</span>){
      <span class="variable">self</span>.<span class="variable">collection</span> = <span class="variable">collection</span>;
      <span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">onOpen</span>.<span class="variable">call</span>(<span class="variable">self</span>);
    }
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Called when the connection closes</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">NativeCollection</span>.<span class="variable">prototype</span>.<span class="variable">onClose</span> = <span class="keyword">function</span> () {
  <span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">onClose</span>.<span class="variable">call</span>(<span class="this">this</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Copy the collection methods and make them subject to queues
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="class">MongoCollection</span>.<span class="variable">prototype</span>)
  (<span class="keyword">function</span>(<span class="variable">i</span>){
    <span class="class">NativeCollection</span>.<span class="variable">prototype</span>[<span class="variable">i</span>] = <span class="keyword">function</span> () {
      <span class="comment">// BENCHMARKME: is it worth caching the prototype methods? probably</span>
      <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">buffer</span>){
        <span class="keyword">var</span> <span class="variable">collection</span> = <span class="this">this</span>.<span class="variable">collection</span>
          , <span class="variable">args</span> = <span class="variable">arguments</span>
          , <span class="variable">self</span> = <span class="this">this</span>;

        <span class="variable">process</span>.<span class="variable">nextTick</span>(<span class="keyword">function</span>(){
          <span class="variable">collection</span>[<span class="variable">i</span>].<span class="variable">apply</span>(<span class="variable">collection</span>, <span class="variable">args</span>);
        });
      } <span class="keyword">else</span>
        <span class="this">this</span>.<span class="variable">addQueue</span>(<span class="variable">i</span>, <span class="variable">arguments</span>);
    };
  })(<span class="variable">i</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Implement getIndexes</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">NativeCollection</span>.<span class="variable">prototype</span>.<span class="variable">getIndexes</span> = <span class="class">NativeCollection</span>.<span class="variable">prototype</span>.<span class="variable">indexInformation</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Override signature of ensureIndex. -native one is not standard.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  spec</p></li><li><p><strong>param</strong>: <em>Object</em>  options</p></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">oldEnsureIndex</span> = <span class="class">MongoCollection</span>.<span class="variable">prototype</span>.<span class="variable">ensureIndex</span>;

<span class="keyword">function</span> <span class="variable">noop</span> () {};

<span class="class">MongoCollection</span>.<span class="variable">prototype</span>.<span class="variable">ensureIndex</span> = <span class="keyword">function</span>(<span class="variable">fields</span>, <span class="variable">options</span>, <span class="variable">fn</span>){
  <span class="comment">// if the spec is an array, use -native (old way)</span>
  <span class="keyword">if</span> (<span class="variable">fields</span>.<span class="variable">constructor</span> != <span class="class">Object</span>)
    <span class="keyword">return</span> <span class="variable">oldEnsureIndex</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);

  <span class="variable">fn</span> = <span class="variable">fn</span> || <span class="variable">noop</span>;
  
  <span class="comment">// transform fields dict into lame array</span>
  <span class="keyword">var</span> <span class="variable">fieldsArr</span> = [];
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">fields</span>)
    <span class="variable">fieldsArr</span>.<span class="variable">push</span>([<span class="variable">i</span>, <span class="variable">fields</span>[<span class="variable">i</span>]]);

  <span class="keyword">if</span> (<span class="variable">options</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">options</span>).<span class="variable">length</span>){
    <span class="keyword">if</span> (<span class="variable">options</span>.<span class="variable">unique</span>)
      <span class="keyword">return</span> <span class="variable">oldEnsureIndex</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">fieldsArr</span>, <span class="variable">true</span>, <span class="variable">fn</span>);
    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">fn</span> != <span class="variable">noop</span>)
      <span class="variable">fn</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'This driver only implements unique indexes'</span>));
  } <span class="keyword">else</span> {
    <span class="variable">oldEnsureIndex</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">fieldsArr</span>, <span class="variable">fn</span>);
  }
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">NativeCollection</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/drivers/node-mongodb-native/connection.js"><a href="#">connection</a></h2></td><td>lib/mongoose/drivers/node-mongodb-native/connection.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">Connection</span> = <span class="variable">require</span>(<span class="string">'../../connection'</span>)
  , <span class="variable">mongo</span> = <span class="variable">require</span>(<span class="string">'../../../../support/node-mongodb-native/lib/mongodb/'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Connection for mongodb-native driver</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">NativeConnection</span>() {
  <span class="class">Connection</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from Connection.
 </p>
</td>
<td class="code">
<pre><code><span class="class">NativeConnection</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">Connection</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Opens the connection</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">NativeConnection</span>.<span class="variable">prototype</span>.<span class="variable">doOpen</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">db</span>)
    <span class="this">this</span>.<span class="variable">db</span> = <span class="keyword">new</span> <span class="variable">mongo</span>.<span class="class">Db</span>(<span class="this">this</span>.<span class="variable">name</span>, <span class="keyword">new</span> <span class="variable">mongo</span>.<span class="class">Server</span>(<span class="this">this</span>.<span class="variable">host</span>, <span class="this">this</span>.<span class="variable">port</span>));
  <span class="this">this</span>.<span class="variable">db</span>.<span class="variable">open</span>(<span class="variable">fn</span>);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Closes the connection</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">NativeConnection</span>.<span class="variable">prototype</span>.<span class="variable">doClose</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="this">this</span>.<span class="variable">db</span>.<span class="variable">close</span>();
  <span class="keyword">if</span> (<span class="variable">fn</span>) <span class="variable">fn</span>();
  <span class="keyword">return</span> <span class="this">this</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">NativeConnection</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/document.js"><a href="#">document</a></h2></td><td>lib/mongoose/document.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">EventEmitter</span> = <span class="variable">require</span>(<span class="string">'events'</span>).<span class="class">EventEmitter</span>
  , <span class="class">MongooseError</span> = <span class="variable">require</span>(<span class="string">'./error'</span>)
  , <span class="class">Schema</span> = <span class="variable">require</span>(<span class="string">'./schema'</span>)
  , <span class="class">SchemaType</span> = <span class="variable">require</span>(<span class="string">'./schematype'</span>)
  , <span class="class">VirtualType</span> = <span class="variable">require</span>(<span class="string">'./virtualtype'</span>)
  , <span class="class">ArrayType</span> = <span class="variable">require</span>(<span class="string">'./types/array'</span>)
  , <span class="class">MixedSchema</span> = <span class="variable">require</span>(<span class="string">'./schema/mixed'</span>)
  , <span class="class">DocumentArraySchema</span> = <span class="variable">require</span>(<span class="string">'./schema/documentarray'</span>)
  , <span class="variable">utils</span> = <span class="variable">require</span>(<span class="string">'./utils'</span>)
  , <span class="variable">clone</span> = <span class="variable">utils</span>.<span class="variable">clone</span>
  , <span class="class">ActiveRoster</span> = <span class="variable">utils</span>.<span class="class">StateMachine</span>.<span class="variable">ctor</span>(<span class="string">'require'</span>, <span class="string">'modify'</span>, <span class="string">'init'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Document constructor.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  values to set</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Document</span> (<span class="variable">obj</span>) {
  <span class="this">this</span>.<span class="variable">doc</span> = <span class="this">this</span>.<span class="variable">buildDoc</span>();
  <span class="this">this</span>.<span class="variable">activePaths</span> = <span class="keyword">new</span> <span class="class">ActiveRoster</span>();
  <span class="this">this</span>.<span class="variable">saveError</span> = <span class="keyword">null</span>;
  <span class="keyword">if</span> (<span class="variable">obj</span>) <span class="this">this</span>.<span class="variable">set</span>(<span class="variable">obj</span>);
  <span class="this">this</span>.<span class="variable">pres</span> = {};
  <span class="this">this</span>.<span class="variable">registerHooks</span>();
  <span class="this">this</span>.<span class="variable">doQueue</span>();
  <span class="this">this</span>.<span class="variable">isNew</span> = <span class="variable">true</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherit from EventEmitter.
 </p>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">EventEmitter</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Base Mongoose instance for the model. Set by the Mongoose instance upon
pre-compilation.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">base</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Document schema as a nested structure.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">schema</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Whether the document is new.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">isNew</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Builds the default doc structure</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">buildDoc</span> = <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">doc</span> = {}
    , <span class="variable">self</span> = <span class="this">this</span>;

  <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">eachPath</span>( <span class="keyword">function</span> (<span class="variable">i</span>, <span class="variable">type</span>) {
    <span class="keyword">var</span> <span class="variable">path</span> = <span class="variable">i</span>.<span class="variable">split</span>(<span class="string">'.'</span>)
      , <span class="variable">len</span> = <span class="variable">path</span>.<span class="variable">length</span>;

    <span class="variable">path</span>.<span class="variable">reduce</span>( <span class="keyword">function</span> (<span class="variable">ref</span>, <span class="variable">piece</span>, <span class="variable">i</span>) {
      <span class="keyword">if</span> (<span class="variable">i</span> === <span class="variable">len</span>-<span class="number integer">1</span>)
        <span class="variable">ref</span>[<span class="variable">piece</span>] = <span class="variable">type</span>.<span class="variable">getDefault</span>(<span class="variable">self</span>);
      <span class="keyword">else</span>
        <span class="keyword">return</span> <span class="variable">ref</span>[<span class="variable">piece</span>] || (<span class="variable">ref</span>[<span class="variable">piece</span>] = {});
    }, <span class="variable">doc</span>);
  });

  <span class="keyword">return</span> <span class="variable">doc</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inits (hydrates) the document.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  document returned by mongo</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">init</span> = <span class="keyword">function</span> (<span class="variable">doc</span>, <span class="variable">fn</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;
  <span class="this">this</span>.<span class="variable">isNew</span> = <span class="variable">false</span>;

  <span class="keyword">function</span> <span class="variable">init</span> (<span class="variable">obj</span>, <span class="variable">doc</span>, <span class="variable">prefix</span>) {
    <span class="variable">prefix</span> = <span class="variable">prefix</span> || <span class="string">''</span>;

    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">obj</span>){
      <span class="keyword">var</span> <span class="variable">path</span> = <span class="variable">prefix</span> + <span class="variable">i</span>
        , <span class="variable">schema</span> = <span class="variable">self</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">path</span>);

      <span class="keyword">if</span> (!<span class="variable">schema</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">obj</span>[<span class="variable">i</span>].<span class="variable">constructor</span> == <span class="class">Object</span>){ <span class="comment">// assume nested object</span>
        <span class="variable">doc</span>[<span class="variable">i</span>] = {};
        <span class="variable">init</span>(<span class="variable">obj</span>[<span class="variable">i</span>], <span class="variable">doc</span>[<span class="variable">i</span>], <span class="variable">path</span> + <span class="string">'.'</span>);
      } <span class="keyword">else</span> {
        <span class="keyword">if</span> (<span class="variable">obj</span>[<span class="variable">i</span>] !== <span class="keyword">null</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">obj</span>[<span class="variable">i</span>] !== <span class="variable">undefined</span>) {
          <span class="keyword">var</span> <span class="variable">schema</span> = <span class="variable">self</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">path</span>);

          <span class="keyword">if</span> (<span class="variable">schema</span>)
            <span class="variable">self</span>.<span class="keyword">try</span>(<span class="keyword">function</span>(){
              <span class="variable">doc</span>[<span class="variable">i</span>] = <span class="variable">schema</span>.<span class="variable">cast</span>(<span class="variable">obj</span>[<span class="variable">i</span>], <span class="variable">self</span>);
            });
          <span class="keyword">else</span>
            <span class="variable">doc</span>[<span class="variable">i</span>] = <span class="variable">obj</span>[<span class="variable">i</span>];
        }

        <span class="comment">// mark as hydrated</span>
        <span class="variable">self</span>.<span class="variable">activePaths</span>.<span class="variable">init</span>(<span class="variable">path</span>);
      }
    }
  };

  <span class="variable">init</span>(<span class="variable">doc</span>, <span class="variable">self</span>.<span class="variable">doc</span>);

  <span class="keyword">if</span> (<span class="variable">fn</span>)
    <span class="variable">fn</span>(<span class="keyword">null</span>);

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Registers a middleware that is executed before a method.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  method name</p></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">pre</span> = <span class="keyword">function</span> (<span class="variable">method</span>, <span class="variable">fn</span>) {
  <span class="keyword">if</span> (!(<span class="variable">method</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">pres</span>))
    <span class="this">this</span>.<span class="variable">pres</span>[<span class="variable">method</span>] = {
        <span class="variable">serial</span>: []
      , <span class="variable">parallel</span>: []
    };
  <span class="this">this</span>.<span class="variable">pres</span>[<span class="variable">method</span>][<span class="variable">fn</span>.<span class="variable">length</span> == <span class="number integer">1</span> ? <span class="string">'serial'</span> : <span class="string">'parallel'</span>].<span class="variable">push</span>(<span class="variable">fn</span>);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets a path, or many paths</p>

<h2>Examples</h2>

<pre><code>// path, value
doc.set(path, value)

// object
doc.set({
    path  : value
  , path2 : {
       path  : value
    }
}</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String | Object</em>  key path, or object</p></li><li><p><strong>param</strong>: <em>Object</em>  value, or undefined if first parameter is an object</p></li><li><p><strong>param</strong>: <em>Boolean</em>  whether to apply transformations: cast, setters (true) </p></li><li><p><strong>param</strong>: <em>Boolean</em>  whether to mark dirty (true)</p></li><li><p><strong>param</strong>: <em>Boolean</em>  whether this is an initialization</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">set</span> = <span class="keyword">function</span> (<span class="variable">path</span>, <span class="variable">val</span>) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable">path</span> != <span class="string">'string'</span>){
    <span class="keyword">var</span> <span class="variable">prefix</span> = <span class="variable">val</span> ? <span class="variable">val</span> + <span class="string">'.'</span> : <span class="string">''</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">path</span>){
      <span class="keyword">if</span> (!(<span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">prefix</span> + <span class="variable">i</span>) <span class="variable">instanceof</span> <span class="class">MixedSchema</span>)
        &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">path</span>[<span class="variable">i</span>].<span class="variable">constructor</span> == <span class="class">Object</span>) {
        <span class="this">this</span>.<span class="variable">set</span>(<span class="variable">path</span>[<span class="variable">i</span>], <span class="variable">prefix</span> + <span class="variable">i</span>);
      } <span class="keyword">else</span> {
        <span class="this">this</span>.<span class="variable">set</span>(<span class="variable">prefix</span> + <span class="variable">i</span>, <span class="variable">path</span>[<span class="variable">i</span>]);
      }
    }
  } <span class="keyword">else</span> {
    <span class="comment">// TODO: do actual checking to see if the value changed</span>
    <span class="keyword">var</span> <span class="variable">schema</span> = <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">path</span>)
      , <span class="variable">parts</span> = <span class="variable">path</span>.<span class="variable">split</span>(<span class="string">'.'</span>)
      , <span class="variable">obj</span> = <span class="this">this</span>.<span class="variable">doc</span>
      , <span class="variable">self</span> = <span class="this">this</span>;

    <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">pathType</span>(<span class="variable">path</span>) === <span class="string">'virtual'</span>) {
      <span class="variable">schema</span> = <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">virtualpath</span>(<span class="variable">path</span>);
      <span class="variable">schema</span>.<span class="variable">applySetters</span>(<span class="variable">val</span>, <span class="this">this</span>);
      <span class="keyword">return</span> <span class="this">this</span>;
    }

    <span class="this">this</span>.<span class="variable">activePaths</span>.<span class="variable">modify</span>(<span class="variable">path</span>);

    <span class="keyword">if</span> ( (!<span class="variable">schema</span> || <span class="variable">val</span> === <span class="keyword">null</span> || <span class="variable">val</span> === <span class="variable">undefined</span>) || 
      <span class="this">this</span>.<span class="keyword">try</span>(<span class="keyword">function</span>(){
        <span class="variable">val</span> = <span class="variable">schema</span>.<span class="variable">applySetters</span>(<span class="variable">schema</span>.<span class="variable">cast</span>(<span class="variable">val</span>, <span class="variable">self</span>), <span class="variable">self</span>);
      })
    ){
      <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">parts</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++){
        <span class="keyword">if</span> (<span class="variable">i</span> + <span class="number integer">1</span> == <span class="variable">l</span>)
          <span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">i</span>]] = <span class="variable">val</span>;
        <span class="keyword">else</span> {
          <span class="variable">obj</span> = <span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">i</span>]];
        }
      }
    }
  }

  <span class="keyword">return</span> <span class="this">this</span>;
};

<span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">_markModified</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="this">this</span>.<span class="variable">activePaths</span>.<span class="variable">modify</span>(<span class="variable">path</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Gets a raw value from a path (no getters)</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">getValue</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="keyword">var</span> <span class="variable">parts</span> = <span class="variable">path</span>.<span class="variable">split</span>(<span class="string">'.'</span>)
    , <span class="variable">obj</span> = <span class="this">this</span>.<span class="variable">doc</span>;

  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">parts</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>-<span class="number integer">1</span>; <span class="variable">i</span>++) {
    <span class="variable">obj</span> = <span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">i</span>]];
    <span class="keyword">if</span> (!<span class="variable">obj</span>) <span class="keyword">return</span> <span class="variable">obj</span>;
  }
  <span class="keyword">return</span> <span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">l</span>-<span class="number integer">1</span>]];
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets a raw value for a path (no casting, setters, transformations)</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>param</strong>: <em>Object</em>  value</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">setValue</span> = <span class="keyword">function</span> (<span class="variable">path</span>, <span class="variable">val</span>) {
  <span class="keyword">var</span> <span class="variable">parts</span> = <span class="variable">path</span>.<span class="variable">split</span>(<span class="string">'.'</span>)
    , <span class="variable">obj</span> = <span class="this">this</span>.<span class="variable">doc</span>;

  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">parts</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>-<span class="number integer">1</span>; <span class="variable">i</span>++) <span class="variable">obj</span> = <span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">i</span>]];
  <span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">l</span>-<span class="number integer">1</span>]] = <span class="variable">val</span>;

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Triggers casting on a specific path</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">doCast</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="keyword">var</span> <span class="variable">schema</span> = <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">path</span>);
  <span class="keyword">if</span> (<span class="variable">schema</span>)
    <span class="this">this</span>.<span class="variable">setValue</span>(<span class="variable">path</span>, <span class="this">this</span>.<span class="variable">getValue</span>(<span class="variable">path</span>));
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Gets a path</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  key path</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">get</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="keyword">var</span> <span class="variable">obj</span>
    , <span class="variable">schema</span> = <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">path</span>) || <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">virtualpath</span>(<span class="variable">path</span>)
    , <span class="variable">pieces</span> = <span class="variable">path</span>.<span class="variable">split</span>(<span class="string">'.'</span>);

  <span class="variable">obj</span> = <span class="this">this</span>.<span class="variable">doc</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">pieces</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++)
    <span class="variable">obj</span> = <span class="variable">obj</span>[<span class="variable">pieces</span>[<span class="variable">i</span>]];
  
  <span class="keyword">if</span> (<span class="variable">schema</span>)
    <span class="variable">obj</span> = <span class="variable">schema</span>.<span class="variable">applyGetters</span>(<span class="variable">obj</span>, <span class="this">this</span>);
    <span class="comment">// TODO Cache obj</span>

  <span class="keyword">return</span> <span class="variable">obj</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Commits a path, marking as modified if needed. Useful for mixed keys</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">commit</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="comment">// TODO: do actual checking to see if the value changed</span>
  <span class="this">this</span>.<span class="variable">activePaths</span>.<span class="variable">modify</span>(<span class="variable">path</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Captures an exception that will be bubbled to <code>save</code></p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  function to execute</p></li><li><p><strong>param</strong>: <em>Object</em>  scope</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="keyword">try</span> = <span class="keyword">function</span> (<span class="variable">fn</span>, <span class="variable">scope</span>) {
  <span class="keyword">var</span> <span class="variable">res</span>;
  <span class="keyword">try</span> {
    <span class="variable">fn</span>.<span class="variable">call</span>(<span class="variable">scope</span>);
    <span class="variable">res</span> = <span class="variable">true</span>;
  } <span class="keyword">catch</span>(<span class="variable">e</span>){
    <span class="this">this</span>.<span class="variable">error</span>(<span class="variable">e</span>);
    <span class="variable">res</span> = <span class="variable">false</span>;
  };
  <span class="keyword">return</span> <span class="variable">res</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Checks if a path is modified</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">isModified</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="keyword">return</span> (<span class="variable">path</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">activePaths</span>.<span class="variable">states</span>.<span class="variable">modify</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Checks if a certain path was initialized</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">isInit</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="keyword">return</span> (<span class="variable">path</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">activePaths</span>.<span class="variable">states</span>.<span class="variable">init</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Validation middleware</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  next</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">validate</span> = <span class="keyword">function</span> (<span class="variable">next</span>) {
  <span class="keyword">var</span> <span class="variable">total</span> = <span class="number integer">0</span>
    , <span class="variable">self</span> = <span class="this">this</span>
    , <span class="variable">validating</span> = {}
    , <span class="variable">didErr</span> = <span class="variable">false</span>;

  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">activePaths</span>.<span class="variable">some</span>(<span class="string">'init'</span>, <span class="string">'modify'</span>)) <span class="keyword">return</span> <span class="variable">next</span>();

  <span class="keyword">function</span> <span class="variable">validatePath</span> (<span class="variable">path</span>) {
    <span class="keyword">if</span> (<span class="variable">validating</span>[<span class="variable">path</span>]) <span class="keyword">return</span>;
    <span class="variable">total</span>++;
    <span class="variable">process</span>.<span class="variable">nextTick</span>(<span class="keyword">function</span>(){
      <span class="variable">self</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">path</span>).<span class="variable">doValidate</span>(<span class="variable">self</span>.<span class="variable">getValue</span>(<span class="variable">path</span>), <span class="keyword">function</span>(<span class="variable">err</span>){
        <span class="keyword">if</span> (<span class="variable">err</span>) {
          <span class="variable">didErr</span> = <span class="variable">true</span>;
          <span class="keyword">return</span> <span class="variable">next</span>(<span class="variable">err</span>);
        }
        --<span class="variable">total</span> || <span class="variable">next</span>();
      }, <span class="variable">self</span>);
    });
    <span class="variable">validating</span>[<span class="variable">path</span>] = <span class="variable">true</span>;
  }

  <span class="this">this</span>.<span class="variable">activePaths</span>.<span class="variable">forEach</span>(<span class="string">'init'</span>, <span class="string">'modify'</span>, <span class="keyword">function</span> (<span class="variable">path</span>) {
    <span class="keyword">if</span> (!<span class="variable">didErr</span>) <span class="variable">validatePath</span>(<span class="variable">path</span>);
  });

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Returns if the document has been modified</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>Boolean</em> </p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">__defineGetter__</span>(<span class="string">'modified'</span>, <span class="keyword">function</span> () {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">activePaths</span>.<span class="variable">some</span>(<span class="string">'modified'</span>);
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>We override the schema setter to compile accessors</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">compile</span> (<span class="variable">tree</span>, <span class="variable">proto</span>, <span class="variable">prefix</span>) {
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">tree</span>)
    <span class="variable">define</span>(<span class="variable">i</span>, ((<span class="variable">tree</span>[<span class="variable">i</span>].<span class="variable">constructor</span> == <span class="class">Object</span>
               &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">tree</span>[<span class="variable">i</span>]).<span class="variable">length</span>)
               &<span class="variable">amp</span>;&<span class="variable">amp</span>; (!<span class="variable">tree</span>[<span class="variable">i</span>].<span class="variable">type</span> || <span class="variable">tree</span>[<span class="variable">i</span>].<span class="variable">__nested</span>)
               ? <span class="variable">tree</span>[<span class="variable">i</span>]
               : <span class="keyword">null</span>)
            , <span class="variable">proto</span>
            , <span class="variable">prefix</span>);
};

<span class="keyword">function</span> <span class="variable">define</span> (<span class="variable">prop</span>, <span class="variable">subprops</span>, <span class="variable">prototype</span>, <span class="variable">prefix</span>) {
  <span class="keyword">var</span> <span class="variable">prefix</span> = <span class="variable">prefix</span> || <span class="string">''</span>
    , <span class="variable">path</span> = (<span class="variable">prefix</span> ? <span class="variable">prefix</span> + <span class="string">'.'</span> : <span class="string">''</span>) + <span class="variable">prop</span>;

  <span class="keyword">if</span> (<span class="variable">subprops</span>) {
    <span class="comment">// if prop hasn't been defined</span>
    <span class="variable">prototype</span>.<span class="variable">__defineGetter__</span>(<span class="variable">prop</span>, <span class="keyword">function</span> () {
      <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">__getters</span>)
        <span class="this">this</span>.<span class="variable">__getters</span> = {};

      <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">__getters</span>[<span class="variable">path</span>]){
        <span class="keyword">var</span> <span class="variable">nested</span> = <span class="keyword">function</span>(){};
        <span class="variable">nested</span>.<span class="variable">prototype</span> = <span class="this">this</span>;
        <span class="variable">compile</span>(<span class="variable">subprops</span>, <span class="variable">nested</span>.<span class="variable">prototype</span>, <span class="variable">path</span>);
        <span class="this">this</span>.<span class="variable">__getters</span>[<span class="variable">path</span>] = <span class="keyword">new</span> <span class="variable">nested</span>();
      }

      <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">__getters</span>[<span class="variable">path</span>];
    });
  } <span class="keyword">else</span> {
    <span class="variable">prototype</span>.<span class="variable">__defineGetter__</span>(<span class="variable">prop</span>, <span class="keyword">function</span> () {
      <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">get</span>(<span class="variable">path</span>);
    });

    <span class="variable">prototype</span>.<span class="variable">__defineSetter__</span>(<span class="variable">prop</span>, <span class="keyword">function</span> (<span class="variable">v</span>) {
      <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">set</span>(<span class="variable">path</span>, <span class="variable">v</span>);
    });
  }
};

<span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">__defineSetter__</span>(<span class="string">'schema'</span>, <span class="keyword">function</span> (<span class="variable">schema</span>) {
  <span class="variable">compile</span>(<span class="variable">schema</span>.<span class="variable">tree</span>, <span class="this">this</span>);
  <span class="this">this</span>.<span class="variable">_schema</span> = <span class="variable">schema</span>;
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>We override the schema getter to return the internal reference</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">__defineGetter__</span>(<span class="string">'schema'</span>, <span class="keyword">function</span> () {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">_schema</span>;
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Register default hooks</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">registerHooks</span> = <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="this">this</span>.<span class="variable">pre</span>(<span class="string">'save'</span>, <span class="keyword">function</span> <span class="variable">checkForExistingErrors</span> (<span class="variable">next</span>) {
    <span class="keyword">if</span> (<span class="variable">self</span>.<span class="variable">saveError</span>){
      <span class="variable">next</span>(<span class="variable">self</span>.<span class="variable">saveError</span>);
      <span class="variable">self</span>.<span class="variable">saveError</span> = <span class="keyword">null</span>;
    } <span class="keyword">else</span> {
      <span class="variable">next</span>();
    }
  });

  <span class="this">this</span>.<span class="variable">pre</span>(<span class="string">'save'</span>, <span class="keyword">function</span> <span class="variable">validation</span> (<span class="variable">next</span>) {
    <span class="keyword">return</span> <span class="variable">self</span>.<span class="variable">validate</span>.<span class="variable">call</span>(<span class="variable">self</span>, <span class="variable">next</span>);
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Registers an error
## TODO handle multiple</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Error</em>  error</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">error</span> = <span class="keyword">function</span> (<span class="variable">err</span>) {
  <span class="this">this</span>.<span class="variable">saveError</span> = <span class="variable">err</span>;
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Executes methods queued from the Schema definition</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">doQueue</span> = <span class="keyword">function</span> () {
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">schema</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">callQueue</span>)
    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">callQueue</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++)
      <span class="this">this</span>[<span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">callQueue</span>[<span class="variable">i</span>][<span class="number integer">0</span>]].<span class="variable">apply</span>(<span class="this">this</span>, <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">callQueue</span>[<span class="variable">i</span>][<span class="number integer">1</span>]);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Gets the document</p>

<ul><li><p><strong>todo</strong>: <em>Should</em>
we apply getters?
## </p></li><li><p><strong>return</strong>: <em>Object</em>  plain object</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">toObject</span> = <span class="keyword">function</span> () {
  <span class="keyword">return</span> <span class="variable">clone</span>(<span class="this">this</span>.<span class="variable">doc</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Returns a JSON string for the document</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>String</em>  JSON representation</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">toJSON</span> = <span class="keyword">function</span> () {
  <span class="keyword">return</span> <span class="class">JSON</span>.<span class="variable">stringify</span>(<span class="this">this</span>.<span class="variable">toObject</span>());
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Wrap methods for hooks. Should be called on implemented classes (eg: Model)
Takes multiple method names as arguments.</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">noop</span> () {};

<span class="class">Document</span>.<span class="variable">registerHooks</span> = <span class="keyword">function</span> () {
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">arguments</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++){
    <span class="this">this</span>.<span class="variable">prototype</span>[<span class="variable">arguments</span>[<span class="variable">i</span>]] = (<span class="keyword">function</span>(<span class="variable">methodName</span>, <span class="variable">oldFn</span>){
      <span class="keyword">return</span> <span class="keyword">function</span> () {
        <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>
          , <span class="variable">args</span> = <span class="variable">arguments</span>;

        <span class="keyword">function</span> <span class="variable">error</span> (<span class="variable">err</span>){
          <span class="keyword">var</span> <span class="variable">lastArg</span> = <span class="variable">args</span>[<span class="variable">args</span>.<span class="variable">length</span>-<span class="number integer">1</span>];
          <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable">lastArg</span> == <span class="string">'function'</span>)
            <span class="variable">lastArg</span>.<span class="variable">call</span>(<span class="variable">self</span>, <span class="variable">err</span>);
        }
        <span class="keyword">var</span> <span class="variable">pres</span> = <span class="this">this</span>.<span class="variable">pres</span>[<span class="variable">methodName</span>];
        <span class="keyword">if</span> (!<span class="variable">pres</span>) <span class="keyword">return</span> <span class="variable">oldFn</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">args</span>);

        <span class="keyword">var</span> <span class="variable">pres</span> = <span class="this">this</span>.<span class="variable">pres</span>[<span class="variable">methodName</span>]
          , <span class="variable">chain</span> = <span class="variable">pres</span>.<span class="variable">serial</span>.<span class="variable">map</span>(<span class="keyword">function</span> (<span class="variable">fn</span>, <span class="variable">i</span>) {
              <span class="keyword">return</span> <span class="keyword">function</span> (<span class="variable">err</span>) {
                <span class="keyword">if</span> (<span class="variable">arguments</span>.<span class="variable">callee</span>.<span class="variable">_hookCalled</span>) <span class="keyword">return</span>;

                <span class="keyword">if</span> (<span class="variable">err</span> <span class="variable">instanceof</span> <span class="class">Error</span>)
                  <span class="variable">error</span>(<span class="variable">err</span>);
                <span class="keyword">else</span>
                  <span class="variable">fn</span>.<span class="variable">call</span>(<span class="variable">self</span>, <span class="variable">chain</span>[<span class="variable">i</span>+<span class="number integer">1</span>] || <span class="variable">parallel</span>);

                <span class="variable">arguments</span>.<span class="variable">callee</span>.<span class="variable">_hookCalled</span> = <span class="variable">true</span>;
              };
            });

        <span class="variable">chain</span>.<span class="variable">length</span> ? <span class="variable">chain</span>[<span class="number integer">0</span>]() : <span class="variable">parallel</span>();

        <span class="keyword">function</span> <span class="variable">parallel</span> (<span class="variable">err</span>) {
          <span class="keyword">if</span> (<span class="variable">err</span> <span class="variable">instanceof</span> <span class="class">Error</span>)
            <span class="keyword">return</span> <span class="variable">error</span>(<span class="variable">err</span>);

          <span class="comment">// chain determines execution, callbacks completeness</span>
          <span class="keyword">var</span> <span class="variable">complete</span> = <span class="variable">pres</span>.<span class="variable">parallel</span>.<span class="variable">length</span>;
          <span class="keyword">if</span> (!<span class="variable">complete</span>) <span class="keyword">return</span> <span class="variable">oldFn</span>.<span class="variable">apply</span>(<span class="variable">self</span>, <span class="variable">args</span>);
            
          <span class="keyword">function</span> <span class="variable">done</span> (<span class="variable">err</span>) {
            <span class="keyword">if</span> (<span class="variable">err</span> <span class="variable">instanceof</span> <span class="class">Error</span>)
              <span class="keyword">return</span> <span class="variable">error</span>(<span class="variable">err</span>);
            --<span class="variable">complete</span> || <span class="variable">oldFn</span>.<span class="variable">apply</span>(<span class="variable">self</span>, <span class="variable">args</span>);
          }

          <span class="keyword">var</span> <span class="variable">chain</span> = <span class="variable">pres</span>.<span class="variable">parallel</span>.<span class="variable">map</span>(<span class="keyword">function</span> (<span class="variable">fn</span>, <span class="variable">i</span>) {
            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="variable">err</span>) {
              <span class="keyword">if</span> (<span class="variable">arguments</span>.<span class="variable">callee</span>.<span class="variable">_hookCalled</span>) <span class="keyword">return</span>;
              <span class="keyword">if</span> (<span class="variable">err</span>) <span class="keyword">return</span> <span class="variable">error</span>(<span class="variable">err</span>);
              <span class="variable">fn</span>.<span class="variable">call</span>(<span class="variable">self</span>, <span class="variable">chain</span>[<span class="variable">i</span>+<span class="number integer">1</span>] || <span class="variable">noop</span>, <span class="keyword">function</span> (<span class="variable">err</span>) {
                <span class="keyword">if</span> (<span class="variable">arguments</span>.<span class="variable">callee</span>.<span class="variable">_hookCalled</span>) <span class="keyword">return</span>;
                <span class="variable">done</span>(<span class="variable">err</span>);
                <span class="variable">arguments</span>.<span class="variable">callee</span>.<span class="variable">_hookCalled</span> = <span class="variable">true</span>;
              });
              <span class="variable">arguments</span>.<span class="variable">callee</span>.<span class="variable">_hookCalled</span> = <span class="variable">true</span>;
            };
          });
          
          <span class="variable">chain</span>[<span class="number integer">0</span>]();
        }
      };
    })(<span class="variable">arguments</span>[<span class="variable">i</span>], <span class="this">this</span>.<span class="variable">prototype</span>[<span class="variable">arguments</span>[<span class="variable">i</span>]]);
  }
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">Document</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Document Error</p>

<ul><li><p><strong>param</strong>: <em>text</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">DocumentError</span> () {
  <span class="class">MongooseError</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">msg</span>);
  <span class="class">MongooseError</span>.<span class="variable">captureStackTrace</span>(<span class="this">this</span>, <span class="variable">arguments</span>.<span class="variable">callee</span>);
  <span class="this">this</span>.<span class="variable">name</span> = <span class="string">'DocumentError'</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from MongooseError.
 </p>
</td>
<td class="code">
<pre><code><span class="class">DocumentError</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">MongooseError</span>.<span class="variable">prototype</span>;

<span class="variable">exports</span>.<span class="class">Error</span> = <span class="class">DocumentError</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/drivers/node-mongodb-native/objectid.js"><a href="#">objectid</a></h2></td><td>lib/mongoose/drivers/node-mongodb-native/objectid.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">ObjectId</span> = <span class="variable">require</span>(<span class="string">'../../../../support/node-mongodb-native/lib/mongodb/'</span>).<span class="class">ObjectID</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Constructor export</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="variable">exports</span> = <span class="class">ObjectId</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Creates an ObjectID for this driver</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  hex string or ObjectId</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">fromString</span> = <span class="keyword">function</span>(<span class="variable">str</span>){
  <span class="keyword">return</span> <span class="class">ObjectId</span>.<span class="variable">createFromHexString</span>(<span class="variable">str</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Gets an ObjectId and converts it to string.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>ObjectId</em>  -native objectid</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">toString</span> = <span class="keyword">function</span>(<span class="variable">oid</span>){
  <span class="keyword">return</span> <span class="variable">oid</span>.<span class="variable">toHexString</span>();
};
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/error.js"><a href="#">error</a></h2></td><td>lib/mongoose/error.js</td></tr><tr class="code">
<td class="docs">
<p>Mongoose error</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">MongooseError</span> (<span class="variable">msg</span>) {
  <span class="class">Error</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">msg</span>);
  <span class="class">Error</span>.<span class="variable">captureStackTrace</span>(<span class="this">this</span>, <span class="variable">arguments</span>.<span class="variable">callee</span>);
  <span class="this">this</span>.<span class="variable">name</span> = <span class="string">'MongooseError'</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from Error.
 </p>
</td>
<td class="code">
<pre><code><span class="class">MongooseError</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">Error</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">MongooseError</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/index.js"><a href="#">index</a></h2></td><td>lib/mongoose/index.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">Schema</span> = <span class="variable">require</span>(<span class="string">'./schema'</span>)
  , <span class="class">SchemaType</span> = <span class="variable">require</span>(<span class="string">'./schematype'</span>)
  , <span class="class">VirtualType</span> = <span class="variable">require</span>(<span class="string">'./virtualtype'</span>)
  , <span class="class">SchemaTypes</span> = <span class="class">Schema</span>.<span class="class">Types</span>
  , <span class="class">Types</span> = <span class="variable">require</span>(<span class="string">'./types'</span>)
  , <span class="class">Query</span> = <span class="variable">require</span>(<span class="string">'./query'</span>)
  , <span class="class">Promise</span> = <span class="variable">require</span>(<span class="string">'./promise'</span>)
  , <span class="class">Model</span> = <span class="variable">require</span>(<span class="string">'./model'</span>)
  , <span class="variable">utils</span> = <span class="variable">require</span>(<span class="string">'./utils'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Mongoose constructor. Most apps will only use one instance.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Mongoose</span> () {
  <span class="this">this</span>.<span class="variable">connections</span> = [];
  <span class="this">this</span>.<span class="variable">plugins</span> = [];
  <span class="this">this</span>.<span class="variable">models</span> = {};
  <span class="this">this</span>.<span class="variable">modelSchemas</span> = {};
  <span class="this">this</span>.<span class="variable">options</span> = {};
  <span class="this">this</span>.<span class="variable">createConnection</span>(); <span class="comment">// default connection</span>
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets/gets mongoose options</p>

<h2>Examples</h2>

<p>   mongoose.set('test') // returns the 'test' value
   mongoose.set('test', value) // sets the 'test' value</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  key</p></li><li><p><strong>param</strong>: <em>String</em>  value</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Mongoose</span>.<span class="variable">prototype</span>.<span class="variable">set</span> =
<span class="class">Mongoose</span>.<span class="variable">prototype</span>.<span class="variable">get</span> = <span class="keyword">function</span> (<span class="variable">key</span>, <span class="variable">value</span>) {
  <span class="keyword">if</span> (<span class="variable">arguments</span>.<span class="variable">length</span> == <span class="number integer">1</span>)
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">options</span>[<span class="variable">key</span>];
  <span class="this">this</span>.<span class="variable">options</span>[<span class="variable">key</span>] = <span class="variable">value</span>;
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Creates a Connection instance.</p>

<h2>Examples</h2>

<p>   // with mongodb:// URI
   db = mongoose.createConnection('mongodb://localhost:port/database');</p>

<p>   // with [host, database_name[, port] signature 
   db = mongoose.createConnection('localhost', 'database', port)</p>

<p>   // initialize now, connect later
   db = mongoose.createConnection();
   db.open('localhost', 'database', port);</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  mongodb:// URI</p></li><li><p><strong>return</strong>: <em>Connection</em>  the created Connection object</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Mongoose</span>.<span class="variable">prototype</span>.<span class="variable">createConnection</span> = <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">conn</span> = <span class="keyword">new</span> <span class="class">Connection</span>(<span class="this">this</span>);
  <span class="this">this</span>.<span class="variable">connections</span>.<span class="variable">push</span>(<span class="variable">conn</span>);
  <span class="keyword">if</span> (<span class="variable">arguments</span>.<span class="variable">length</span>)
    <span class="variable">conn</span>.<span class="variable">open</span>.<span class="variable">apply</span>(<span class="variable">conn</span>, <span class="variable">arguments</span>);
  <span class="keyword">return</span> <span class="variable">conn</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Connects the default mongoose connection</p>

<h2></h2>

<ul><li><p><strong>see</strong>: <em>Mongoose#createConnection</em> </p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Mongoose</span>.<span class="variable">prototype</span>.<span class="variable">connect</span> = <span class="keyword">function</span> (){
  <span class="this">this</span>.<span class="variable">connection</span>.<span class="variable">open</span>.<span class="variable">apply</span>(<span class="this">this</span>.<span class="variable">connection</span>, <span class="variable">arguments</span>);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Disconnects from all connections.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  optional callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Mongoose</span>.<span class="variable">prototype</span>.<span class="variable">disconnect</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="keyword">var</span> <span class="variable">count</span> = <span class="this">this</span>.<span class="variable">connections</span>.<span class="variable">length</span>;
  <span class="this">this</span>.<span class="variable">connections</span>.<span class="variable">forEach</span>(<span class="keyword">function</span>(<span class="variable">conn</span>){
    <span class="variable">conn</span>.<span class="variable">close</span>(<span class="keyword">function</span>(<span class="variable">err</span>){
      <span class="keyword">if</span> (<span class="variable">err</span>) <span class="keyword">return</span> <span class="variable">fn</span>(<span class="variable">err</span>);
      <span class="keyword">if</span> (<span class="variable">fn</span>)
        --<span class="variable">count</span> || <span class="variable">fn</span>();
    });
  });
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Defines a model or retrieves it</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  model name</p></li><li><p><strong>param</strong>: <em>Schema</em>  schema object</p></li><li><p><strong>param</strong>: <em>String</em>  collection name (optional, induced from model name)</p></li><li><p><strong>param</strong>: <em>Boolean</em>  whether to skip initialization (defaults to false)</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Mongoose</span>.<span class="variable">prototype</span>.<span class="variable">model</span> = <span class="keyword">function</span> (<span class="variable">name</span>, <span class="variable">schema</span>, <span class="variable">collection</span>, <span class="variable">skipInit</span>) {
  <span class="comment">// normalize collection</span>
  <span class="keyword">if</span> (!(<span class="variable">schema</span> <span class="variable">instanceof</span> <span class="class">Schema</span>)){
    <span class="variable">collection</span> = <span class="variable">schema</span>;
    <span class="variable">schema</span> = <span class="variable">false</span>;
  }

  <span class="variable">collection</span> = <span class="variable">collection</span> || <span class="variable">utils</span>.<span class="variable">toCollectionName</span>(<span class="variable">name</span>);
  
  <span class="comment">// look up models for the collection</span>
  <span class="keyword">if</span> (<span class="variable">schema</span>){
    <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">modelSchemas</span>[<span class="variable">name</span>]) {
      <span class="this">this</span>.<span class="variable">modelSchemas</span>[<span class="variable">name</span>] = <span class="variable">schema</span>;
      <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="this">this</span>.<span class="variable">plugins</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++)
        <span class="variable">schema</span>.<span class="variable">plugin</span>(<span class="this">this</span>.<span class="variable">plugins</span>[<span class="variable">i</span>]);
    }
  } <span class="keyword">else</span> {
    <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">modelSchemas</span>[<span class="variable">name</span>])
      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="variable">t</span> <span class="variable">been</span> <span class="variable">registered</span> <span class="keyword">for</span> <span class="variable">model</span> &<span class="variable">quot</span>;<span class="string">' + name + '</span>&<span class="variable">quot</span>;.\<span class="variable">n</span>'
                    + <span class="string">'Use Mongoose.define(name, schema)'</span>);

    <span class="keyword">var</span> <span class="variable">conn</span> = <span class="this">this</span>.<span class="variable">connection</span>
      , <span class="variable">model</span>;

    <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">models</span>[<span class="variable">collection</span>])
      <span class="this">this</span>.<span class="variable">models</span>[<span class="variable">collection</span>] = {};

    <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">models</span>[<span class="variable">collection</span>][<span class="variable">name</span>]){
      <span class="variable">model</span> = <span class="class">Model</span>.<span class="variable">compile</span>(<span class="variable">name</span>
                          , <span class="this">this</span>.<span class="variable">modelSchemas</span>[<span class="variable">name</span>]
                          , <span class="variable">collection</span>
                          , <span class="variable">conn</span>
                          , <span class="this">this</span>);

      <span class="keyword">if</span> (!<span class="variable">skipInit</span>)
        <span class="variable">model</span>.<span class="variable">init</span>();

      <span class="this">this</span>.<span class="variable">models</span>[<span class="variable">collection</span>][<span class="variable">name</span>] = <span class="variable">model</span>;
    };

    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">models</span>[<span class="variable">collection</span>][<span class="variable">name</span>];
  }
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Declares a plugin executed on Schemas. Equivalent to calling <code>.plugin(fn)</code>
on each Schema you create.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  plugin callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Mongoose</span>.<span class="variable">prototype</span>.<span class="variable">plugin</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="this">this</span>.<span class="variable">plugins</span>.<span class="variable">push</span>(<span class="variable">fn</span>);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Default connection</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Mongoose</span>.<span class="variable">prototype</span>.<span class="variable">__defineGetter__</span>(<span class="string">'connection'</span>, <span class="keyword">function</span>(){
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">connections</span>[<span class="number integer">0</span>];
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Compat flag.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">compat</span> = <span class="variable">false</span>;

<span class="variable">exports</span>.<span class="variable">__defineGetter__</span>(<span class="string">'compat'</span>, <span class="keyword">function</span>(){
  <span class="keyword">return</span> <span class="variable">compat</span>;
});

<span class="variable">exports</span>.<span class="variable">__defineSetter__</span>(<span class="string">'compat'</span>, <span class="keyword">function</span>(<span class="variable">v</span>){
  <span class="variable">compat</span> = <span class="variable">v</span>;
  <span class="keyword">if</span> (<span class="variable">v</span>) <span class="variable">require</span>(<span class="string">'./compat'</span>);
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Driver depentend APIs
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">driver</span> = <span class="variable">global</span>.<span class="class">MONGOOSE_DRIVER_PATH</span> || <span class="string">'./drivers/node-mongodb-native'</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Connection</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">Connection</span> = <span class="variable">require</span>(<span class="variable">driver</span> + <span class="string">'/connection'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Collection</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">Collection</span> = <span class="variable">require</span>(<span class="variable">driver</span> + <span class="string">'/collection'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Export default singleton.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="variable">exports</span> = <span class="keyword">new</span> <span class="class">Mongoose</span>();</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Collection</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">Collection</span> = <span class="class">Collection</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Connection</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">Connection</span> = <span class="class">Connection</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Exports Mongoose version</p>

<ul><li><p><strong>param</strong>: <em>version</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">version</span> = <span class="string">'1.0.0'</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Export Mongoose constructor</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">Mongoose</span> = <span class="class">Mongoose</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Export Schema constructor</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">Schema</span> = <span class="class">Schema</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Export SchemaType constructor.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">SchemaType</span> = <span class="class">SchemaType</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Export VirtualType constructor.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">VirtualType</span> = <span class="class">VirtualType</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Export Schema types</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">SchemaTypes</span> = <span class="class">SchemaTypes</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Export types</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">Types</span> = <span class="class">Types</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Export Query</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">Query</span> = <span class="class">Query</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Export Promise</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">Promise</span> = <span class="class">Promise</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Export MongooseError</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">Error</span> = <span class="variable">require</span>(<span class="string">'./error'</span>);
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/model.js"><a href="#">model</a></h2></td><td>lib/mongoose/model.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">Document</span> = <span class="variable">require</span>(<span class="string">'./document'</span>)
  , <span class="class">DocumentArray</span> = <span class="variable">require</span>(<span class="string">'./types/documentarray'</span>)
  , <span class="class">MongooseError</span> = <span class="variable">require</span>(<span class="string">'./error'</span>)
  , <span class="class">Query</span> = <span class="variable">require</span>(<span class="string">'./query'</span>).<span class="class">Query</span>
  , <span class="class">FindQuery</span> = <span class="variable">require</span>(<span class="string">'./query'</span>).<span class="class">FindQuery</span>
  , <span class="class">EventEmitter</span> = <span class="variable">require</span>(<span class="string">'./utils'</span>).<span class="class">EventEmitter</span>
  , <span class="class">Promise</span> = <span class="variable">require</span>(<span class="string">'./promise'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Model constructor</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  values to set</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Model</span> (<span class="variable">doc</span>) {
  <span class="class">Document</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">doc</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from Document.
 </p>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">Document</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Connection the model uses. Set by the Connection or if absent set to the
default mongoose connection;</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">db</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Collection the model uses. Set by Mongoose instance</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">collection</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Model name.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">name</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Saves the document.</p>

<ul><li><p><strong>see</strong>: <em>Model</em>
#registerHooks
## </p></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">save</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">isNew</span>) {
    <span class="comment">// send entire doc</span>
    <span class="this">this</span>.<span class="variable">collection</span>.<span class="variable">insert</span>(<span class="this">this</span>.<span class="variable">toObject</span>(), <span class="variable">fn</span>);
    <span class="this">this</span>.<span class="variable">isNew</span> = <span class="variable">false</span>;
  } <span class="keyword">else</span> {
    <span class="comment">// send delta</span>
    <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>
      , <span class="variable">delta</span>
      , <span class="variable">useSet</span> = <span class="this">this</span>.<span class="variable">options</span>[<span class="string">'use$SetOnSave'</span>];

    <span class="variable">delta</span> = <span class="this">this</span>.<span class="variable">activePaths</span>.<span class="variable">map</span>(<span class="string">'modify'</span>, <span class="keyword">function</span> (<span class="variable">path</span>) {
      <span class="keyword">return</span> { <span class="variable">path</span>: <span class="variable">path</span>, <span class="variable">value</span>: <span class="variable">self</span>.<span class="variable">getValue</span>(<span class="variable">path</span>), <span class="variable">schema</span>: <span class="variable">self</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">path</span>) };
    }).<span class="variable">reduce</span>( <span class="keyword">function</span> (<span class="variable">delta</span>, <span class="variable">data</span>) {
      <span class="keyword">var</span> <span class="variable">type</span> = <span class="variable">data</span>.<span class="variable">value</span>
        , <span class="variable">schema</span> = <span class="variable">data</span>.<span class="variable">schema</span>;

      <span class="comment">// a MongooseArray or MongooseNumber</span>
      <span class="keyword">if</span> (<span class="variable">type</span>.<span class="variable">_path</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">type</span>.<span class="variable">doAtomics</span>) {
        <span class="variable">type</span>.<span class="variable">_atomics</span>.<span class="variable">forEach</span>( <span class="keyword">function</span> (<span class="variable">op</span>) {
          <span class="keyword">var</span> <span class="variable">obj</span> = <span class="variable">delta</span>[<span class="variable">op</span>[<span class="number integer">0</span>]] = <span class="variable">delta</span>[<span class="variable">op</span>[<span class="number integer">0</span>]] || {};
          <span class="keyword">if</span> (<span class="variable">op</span>[<span class="number integer">0</span>] === <span class="string">'$pull'</span> || <span class="variable">op</span>[<span class="number integer">0</span>] === <span class="string">'$push'</span>) {
            <span class="keyword">if</span> (<span class="variable">op</span>[<span class="number integer">1</span>].<span class="variable">constructor</span> !== <span class="class">Object</span>) {
              <span class="variable">op</span>[<span class="number integer">1</span>] = <span class="variable">schema</span>.<span class="variable">cast</span>(<span class="variable">op</span>[<span class="number integer">1</span>])[<span class="number integer">0</span>];
            }
          }
          <span class="variable">obj</span>[<span class="variable">type</span>.<span class="variable">_path</span>] = <span class="variable">op</span>[<span class="number integer">1</span>].<span class="variable">toObject</span>
            ? <span class="variable">op</span>[<span class="number integer">1</span>].<span class="variable">toObject</span>() <span class="comment">// If the value is an array</span>
            : <span class="class">Array</span>.<span class="variable">isArray</span>(<span class="variable">op</span>[<span class="number integer">1</span>])
              ? <span class="variable">op</span>[<span class="number integer">1</span>].<span class="variable">map</span>( <span class="keyword">function</span> (<span class="variable">mem</span>) { 
                  <span class="keyword">return</span> <span class="variable">mem</span>.<span class="variable">toObject</span>
                    ? <span class="variable">mem</span>.<span class="variable">toObject</span>()
                    : <span class="variable">mem</span>.<span class="variable">valueOf</span>
                      ? <span class="variable">mem</span>.<span class="variable">valueOf</span>()
                      : <span class="variable">mem</span>;
                })
              : <span class="variable">op</span>[<span class="number integer">1</span>].<span class="variable">valueOf</span>
                ? <span class="variable">op</span>[<span class="number integer">1</span>].<span class="variable">valueOf</span>() <span class="comment">// Numbers</span>
                : <span class="variable">op</span>[<span class="number integer">1</span>];
        });
      } <span class="keyword">else</span> {
        <span class="comment">// normalize MongooseArray or MongooseNumber</span>
        <span class="keyword">if</span> (<span class="variable">type</span>.<span class="variable">_path</span>)
          <span class="variable">type</span> = <span class="variable">type</span>.<span class="variable">valueOf</span>();

        <span class="keyword">if</span> (<span class="variable">useSet</span>) {
          <span class="keyword">if</span> (!(<span class="string">'$set'</span> <span class="keyword">in</span> <span class="variable">delta</span>))
            <span class="variable">delta</span>[<span class="string">'$set'</span>] = {};

          <span class="variable">delta</span>[<span class="string">'$set'</span>][<span class="variable">data</span>.<span class="variable">path</span>] = <span class="variable">type</span>;
        } <span class="keyword">else</span>
          <span class="variable">delta</span>[<span class="variable">data</span>.<span class="variable">path</span>] = <span class="variable">type</span>;
      }

      <span class="keyword">return</span> <span class="variable">delta</span>;
    }, {});

    <span class="keyword">if</span> (<span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">delta</span>).<span class="variable">length</span>)
      <span class="this">this</span>.<span class="variable">collection</span>.<span class="variable">update</span>({ <span class="variable">_id</span>: <span class="this">this</span>.<span class="variable">doc</span>.<span class="variable">_id</span> }, <span class="variable">delta</span>, {}, <span class="variable">fn</span>);
    <span class="keyword">else</span>
      <span class="variable">fn</span>(<span class="keyword">null</span>);
    <span class="comment">// TODO Clear 'modify'('dirty') cache</span>
  }
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Remove the document</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  callback</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">remove</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">removing</span> || <span class="this">this</span>.<span class="variable">removed</span>) <span class="keyword">return</span> <span class="this">this</span>;

  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">removing</span>) {
    <span class="keyword">var</span> <span class="variable">promise</span> = <span class="this">this</span>.<span class="variable">removing</span> = <span class="keyword">new</span> <span class="class">Promise</span>(<span class="variable">fn</span>)
      , <span class="variable">self</span> = <span class="this">this</span>;

    <span class="this">this</span>.<span class="variable">collection</span>.<span class="variable">remove</span>({ <span class="variable">_id</span>: <span class="this">this</span>.<span class="variable">doc</span>.<span class="variable">_id</span> }, <span class="keyword">function</span> (<span class="variable">err</span>) {
      <span class="keyword">if</span> (<span class="variable">err</span>) <span class="keyword">return</span> <span class="variable">promise</span>.<span class="variable">error</span>(<span class="variable">err</span>);
      <span class="variable">promise</span>.<span class="variable">complete</span>();
      <span class="variable">self</span>.<span class="variable">emit</span>(<span class="string">'remove'</span>);
    });
  }

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Register hooks override</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">registerHooks</span> = <span class="keyword">function</span> () {
  <span class="comment">// make sure to pass along all the errors from subdocuments</span>
  <span class="this">this</span>.<span class="variable">pre</span>(<span class="string">'save'</span>, <span class="keyword">function</span> (<span class="variable">next</span>) {
    <span class="comment">// we keep the error semaphore to make sure we don't</span>
    <span class="comment">// call `save` unnecessarily (we only need 1 error)</span>
    <span class="keyword">var</span> <span class="variable">subdocs</span> = <span class="number integer">0</span>
      , <span class="variable">error</span> = <span class="variable">false</span>
      , <span class="variable">self</span> = <span class="this">this</span>;

    <span class="keyword">var</span> <span class="variable">arrays</span> = <span class="this">this</span>.<span class="variable">activePaths</span>
      .<span class="variable">map</span>(<span class="string">'init'</span>, <span class="string">'modify'</span>, <span class="keyword">function</span> (<span class="variable">i</span>) {
        <span class="keyword">return</span> <span class="variable">self</span>.<span class="variable">getValue</span>(<span class="variable">i</span>);
      })
      .<span class="variable">filter</span>(<span class="keyword">function</span> (<span class="variable">val</span>) {
        <span class="keyword">return</span> (<span class="variable">val</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">val</span> <span class="variable">instanceof</span> <span class="class">DocumentArray</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">val</span>.<span class="variable">length</span>);
      });

    <span class="keyword">if</span> (!<span class="variable">arrays</span>.<span class="variable">length</span>) <span class="keyword">return</span> <span class="variable">next</span>();

    <span class="variable">arrays</span>.<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">array</span>) {
      <span class="variable">subdocs</span> += <span class="variable">array</span>.<span class="variable">length</span>;
      <span class="variable">array</span>.<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">value</span>) {
        <span class="keyword">if</span> (!<span class="variable">error</span>)
          <span class="variable">value</span>.<span class="variable">save</span>(<span class="keyword">function</span> (<span class="variable">err</span>) {
            <span class="keyword">if</span> (!<span class="variable">error</span>) {
              <span class="keyword">if</span> (<span class="variable">err</span>) {
                <span class="variable">error</span> = <span class="variable">true</span>;
                <span class="variable">next</span>(<span class="variable">err</span>);
              } <span class="keyword">else</span>
                --<span class="variable">subdocs</span> || <span class="variable">next</span>();
            }
          });
      });
    });
  });

  <span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">registerHooks</span>.<span class="variable">call</span>(<span class="this">this</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Access the options defined in the schema</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">__defineGetter__</span>(<span class="string">'options'</span>, <span class="keyword">function</span> () {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">schema</span> ? <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">options</span> : {};
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Give the constructor the ability to emit events.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="class">EventEmitter</span>.<span class="variable">prototype</span>)
  <span class="class">Model</span>[<span class="variable">i</span>] = <span class="class">EventEmitter</span>.<span class="variable">prototype</span>[<span class="variable">i</span>];</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Called when the model compiles</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">init</span> = <span class="keyword">function</span> () {
  <span class="comment">// build indexes</span>
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>
    , <span class="variable">indexes</span> = <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">indexes</span>
    , <span class="variable">count</span> = <span class="variable">indexes</span>.<span class="variable">length</span>;

  <span class="variable">indexes</span>.<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">index</span>) {
    <span class="variable">self</span>.<span class="variable">collection</span>.<span class="variable">ensureIndex</span>(<span class="variable">index</span>[<span class="number integer">0</span>], <span class="variable">index</span>[<span class="number integer">1</span>], <span class="keyword">function</span>(){
      --<span class="variable">count</span> || <span class="variable">self</span>.<span class="variable">emit</span>(<span class="string">'index'</span>);
    });
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Document schema </p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">schema</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Database instance the model uses.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">db</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Collection the model uses.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">collection</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Define properties that access the prototype.
 </p>
</td>
<td class="code">
<pre><code>[<span class="string">'db'</span>, <span class="string">'collection'</span>, <span class="string">'schema'</span>, <span class="string">'options'</span>].<span class="variable">forEach</span>(<span class="keyword">function</span>(<span class="variable">prop</span>){
  <span class="class">Model</span>.<span class="variable">__defineGetter__</span>(<span class="variable">prop</span>, <span class="keyword">function</span>(){
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">prototype</span>[<span class="variable">prop</span>];
  });
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Register hooks for some methods.
 </p>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">registerHooks</span>.<span class="variable">call</span>(<span class="class">Model</span>, <span class="string">'save'</span>, <span class="string">'remove'</span>, <span class="string">'init'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="variable">exports</span> = <span class="class">Model</span>;

<span class="class">Model</span>.<span class="variable">remove</span> = <span class="keyword">function</span> (<span class="variable">query</span>, <span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;
  <span class="this">this</span>.<span class="variable">query</span>(<span class="variable">query</span>, {}, <span class="variable">callback</span>, <span class="keyword">function</span> () {
    <span class="keyword">var</span> <span class="variable">casted</span> = <span class="variable">self</span>.<span class="variable">castQuery</span>(<span class="this">this</span>.<span class="variable">query</span>)
      , <span class="variable">queryComplete</span> = <span class="this">this</span>.<span class="variable">queryComplete</span>.<span class="variable">bind</span>(<span class="this">this</span>);
    <span class="variable">self</span>.<span class="variable">collection</span>.<span class="variable">remove</span>(<span class="variable">casted</span>, <span class="variable">queryComplete</span>);
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Creates a query for the signature <code>query, options, callback</code></p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  query</p></li><li><p><strong>param</strong>: <em>Object</em>  options for the query</p></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>param</strong>: <em>Function</em>  function to be called when query executes</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">query</span> = <span class="keyword">function</span> (<span class="variable">query</span>, <span class="variable">options</span>, <span class="variable">callback</span>, <span class="variable">onExecute</span>) {
  <span class="comment">// determine callback for `query, fields, callback, options` signature</span>
  <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="variable">options</span>) {
    <span class="variable">callback</span> = <span class="variable">options</span>;
    <span class="variable">options</span> = {};
  }

  <span class="keyword">if</span> (!<span class="variable">options</span>)
    <span class="variable">options</span> = {};

  <span class="comment">// merge query defaults from schema options</span>
  <span class="keyword">if</span> (!(<span class="string">'safe'</span> <span class="keyword">in</span> <span class="variable">options</span>))
    <span class="variable">options</span>.<span class="variable">safe</span> = <span class="this">this</span>.<span class="variable">options</span>.<span class="variable">safe</span>;

  <span class="keyword">var</span> <span class="variable">query</span> = <span class="keyword">new</span> <span class="class">Query</span>(<span class="variable">query</span>, <span class="variable">options</span>, <span class="variable">onExecute</span>);

  <span class="keyword">if</span> (<span class="variable">callback</span>) {
    <span class="variable">query</span>.<span class="variable">addBack</span>(<span class="variable">callback</span>);
    <span class="variable">query</span>.<span class="variable">run</span>();
  }

  <span class="keyword">return</span> <span class="variable">query</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Creates a query for the signature <code>query, fields, callback, options</code></p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  query</p></li><li><p><strong>param</strong>: <em>Object</em>  fields to get, or array of fields</p></li><li><p><strong>param</strong>: <em>Object</em>  options for the query</p></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>param</strong>: <em>Function</em>  function to be called when query executes</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">findQuery</span> = <span class="keyword">function</span> (<span class="variable">query</span>, <span class="variable">fields</span>, <span class="variable">options</span>, <span class="variable">callback</span>, <span class="variable">onExecute</span>) {
  <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="variable">fields</span>) {
    <span class="variable">callback</span> = <span class="variable">fields</span>;
    <span class="variable">fields</span> = {};
    <span class="variable">options</span> = {};
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="variable">options</span>) {
    <span class="variable">callback</span> = <span class="variable">options</span>;
    <span class="variable">options</span> = {};
  }

  <span class="keyword">var</span> <span class="variable">query</span> = <span class="keyword">new</span> <span class="class">FindQuery</span>(<span class="variable">query</span>, <span class="variable">fields</span>, <span class="variable">options</span>, <span class="variable">onExecute</span>);
 
  <span class="keyword">if</span> (<span class="variable">callback</span>) {
    <span class="variable">query</span>.<span class="variable">run</span>(<span class="variable">callback</span>);
  }

  <span class="keyword">return</span> <span class="variable">query</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Casts a query</p>

<h2>Examples</h2>

<pre><code>// will return { _id: ObjectId }
castQuery({ _id: '4c40f33a37483d8e14000001' })</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  query</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">castQuery</span> = <span class="keyword">function</span> (<span class="variable">query</span>) {
  <span class="keyword">var</span> <span class="variable">ret</span> = {}
    , <span class="variable">self</span> = <span class="this">this</span>;

  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">query</span>){
    <span class="keyword">if</span> (<span class="variable">query</span>[<span class="variable">i</span>] === <span class="keyword">null</span> || <span class="variable">query</span>[<span class="variable">i</span>] === <span class="variable">undefined</span>)
      <span class="variable">ret</span>[<span class="variable">i</span>] = <span class="variable">query</span>[<span class="variable">i</span>]
    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">query</span>[<span class="variable">i</span>].<span class="variable">constructor</span> == <span class="class">Object</span>) {
      <span class="variable">ret</span>[<span class="variable">i</span>] = <span class="variable">query</span>[<span class="variable">i</span>];
      <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">query</span>[<span class="variable">i</span>]).<span class="variable">filter</span>( <span class="keyword">function</span> (<span class="variable">key</span>) {
        <span class="keyword">return</span> <span class="variable">key</span>.<span class="variable">charAt</span>(<span class="number integer">0</span>) === <span class="string">'$'</span>;
      }).<span class="variable">forEach</span>( <span class="keyword">function</span> (<span class="variable">key</span>) {
        <span class="keyword">var</span> <span class="variable">schema</span> = <span class="variable">self</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">i</span>);

        <span class="keyword">if</span> (<span class="variable">key</span> == <span class="string">'$in'</span>) {
          <span class="comment">// cast array</span>
          <span class="variable">ret</span>[<span class="variable">i</span>][<span class="variable">key</span>] = <span class="variable">ret</span>[<span class="variable">i</span>][<span class="variable">key</span>].<span class="variable">map</span>(<span class="variable">schema</span>.<span class="variable">cast</span>);
        } <span class="keyword">else</span>
          <span class="variable">ret</span>[<span class="variable">i</span>][<span class="variable">key</span>] = <span class="variable">schema</span>.<span class="variable">cast</span>(<span class="variable">query</span>[<span class="variable">i</span>][<span class="variable">key</span>]);

        <span class="comment">// Take care of special case of MongooseNumber,</span>
        <span class="comment">// with resolves scalar via `valueOf`</span>
        <span class="keyword">if</span> (<span class="variable">ret</span>[<span class="variable">i</span>][<span class="variable">key</span>].<span class="variable">_path</span>)
          <span class="variable">ret</span>[<span class="variable">i</span>][<span class="variable">key</span>] = <span class="variable">ret</span>[<span class="variable">i</span>][<span class="variable">key</span>].<span class="variable">valueOf</span>();
      });
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">query</span>[<span class="variable">i</span>].<span class="variable">constructor</span> == <span class="class">RegExp</span> || <span class="class">Array</span>.<span class="variable">isArray</span>(<span class="variable">query</span>[<span class="variable">i</span>]))
      <span class="variable">ret</span>[<span class="variable">i</span>] = <span class="variable">query</span>[<span class="variable">i</span>];
    <span class="keyword">else</span>
      <span class="variable">ret</span>[<span class="variable">i</span>] = <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">i</span>).<span class="variable">cast</span>(<span class="variable">query</span>[<span class="variable">i</span>]);
  }

  <span class="keyword">return</span> <span class="variable">ret</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Finds documents</p>

<h2>Examples</h2>

<p>   // retrieve only certain keys
   MyModel.find({ name: /john/i }, ['name', 'friends'], function () { })</p>

<p>   // pass options
   MyModel.find({ name: /john/i }, [], { skip: 10 } )</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  query</p></li><li><p><strong>param</strong>: <em>Object | Function</em>  (optional) fields to hydrate or callback</p></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">find</span> = <span class="keyword">function</span> (<span class="variable">query</span>, <span class="variable">fields</span>, <span class="variable">options</span>, <span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">findQuery</span>(<span class="variable">query</span>, <span class="variable">fields</span>, <span class="variable">options</span>, <span class="variable">callback</span>, <span class="keyword">function</span> (<span class="variable">query</span>) {
    <span class="keyword">var</span> <span class="variable">q</span> = <span class="this">this</span>
      , <span class="variable">casted</span> = <span class="variable">self</span>.<span class="variable">castQuery</span>(<span class="this">this</span>.<span class="variable">query</span>);

    <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">fields</span>)
      <span class="this">this</span>.<span class="variable">options</span>.<span class="variable">fields</span> = <span class="this">this</span>.<span class="variable">fields</span>;

    <span class="variable">self</span>.<span class="variable">collection</span>.<span class="variable">find</span>(<span class="variable">casted</span>, <span class="this">this</span>.<span class="variable">options</span>, <span class="keyword">function</span> (<span class="variable">err</span>, <span class="variable">cursor</span>) {
      <span class="keyword">if</span> (<span class="variable">err</span>) <span class="keyword">return</span> <span class="variable">q</span>.<span class="variable">queryComplete</span>(<span class="variable">err</span>);

      <span class="variable">cursor</span>.<span class="variable">toArray</span>(<span class="keyword">function</span>(<span class="variable">err</span>, <span class="variable">docs</span>){
        <span class="keyword">if</span> (<span class="variable">err</span>) <span class="keyword">return</span> <span class="variable">q</span>.<span class="variable">queryComplete</span>(<span class="variable">err</span>);

        <span class="keyword">var</span> <span class="variable">arr</span> = []
          , <span class="variable">count</span> = <span class="variable">docs</span>.<span class="variable">length</span>;

        <span class="keyword">if</span> (!<span class="variable">count</span>) <span class="keyword">return</span> <span class="variable">q</span>.<span class="variable">queryComplete</span>(<span class="keyword">null</span>, []);

        <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">docs</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++){
          <span class="variable">arr</span>[<span class="variable">i</span>] = <span class="keyword">new</span> <span class="variable">self</span>();
          <span class="variable">arr</span>[<span class="variable">i</span>].<span class="variable">init</span>(<span class="variable">docs</span>[<span class="variable">i</span>], <span class="keyword">function</span> (<span class="variable">err</span>) {
            <span class="keyword">if</span> (<span class="variable">err</span>) <span class="keyword">return</span> <span class="variable">q</span>.<span class="variable">queryComplete</span>(<span class="variable">err</span>);
            --<span class="variable">count</span> || <span class="variable">q</span>.<span class="variable">queryComplete</span>(<span class="keyword">null</span>, <span class="variable">arr</span>);
          });
        }
      });
    });
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Finds by id</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>ObjectId | Object</em>  objectid, or a value that can be casted to it</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">findById</span> = <span class="keyword">function</span> (<span class="variable">id</span>, <span class="variable">fields</span>, <span class="variable">options</span>, <span class="variable">callback</span>) {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">findOne</span>({ <span class="variable">_id</span>: <span class="variable">id</span> }, <span class="variable">fields</span>, <span class="variable">options</span>, <span class="variable">callback</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Finds one document</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  query</p></li><li><p><strong>param</strong>: <em>Object | Function</em>  (optional) fields to hydrate or callback</p></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">findOne</span> = <span class="keyword">function</span> (<span class="variable">query</span>, <span class="variable">fields</span>, <span class="variable">options</span>, <span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">findQuery</span>(<span class="variable">query</span>, <span class="variable">fields</span>, <span class="variable">options</span>, <span class="variable">callback</span>, <span class="keyword">function</span> () {
    <span class="keyword">var</span> <span class="variable">q</span> = <span class="this">this</span>
      , <span class="variable">casted</span> = <span class="variable">self</span>.<span class="variable">castQuery</span>(<span class="this">this</span>.<span class="variable">query</span>);

    <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">fields</span>)
      <span class="this">this</span>.<span class="variable">options</span>.<span class="variable">fields</span> = <span class="this">this</span>.<span class="variable">fields</span>;

    <span class="variable">self</span>.<span class="variable">collection</span>.<span class="variable">findOne</span>(<span class="variable">casted</span>, <span class="this">this</span>.<span class="variable">options</span>, <span class="keyword">function</span> (<span class="variable">err</span>, <span class="variable">doc</span>) {
      <span class="keyword">if</span> (<span class="variable">err</span>) <span class="keyword">return</span> <span class="variable">q</span>.<span class="variable">queryComplete</span>(<span class="variable">err</span>);

      <span class="keyword">if</span> (!<span class="variable">doc</span>) <span class="keyword">return</span> <span class="variable">q</span>.<span class="variable">queryComplete</span>(<span class="keyword">null</span>, <span class="keyword">null</span>);
      
      <span class="keyword">var</span> <span class="variable">casted</span> = <span class="keyword">new</span> <span class="variable">self</span>();

      <span class="variable">casted</span>.<span class="variable">init</span>(<span class="variable">doc</span>, <span class="keyword">function</span> (<span class="variable">err</span>) {
        <span class="keyword">if</span> (<span class="variable">err</span>) <span class="keyword">return</span> <span class="variable">q</span>.<span class="variable">queryComplete</span>(<span class="variable">err</span>);
        <span class="variable">q</span>.<span class="variable">queryComplete</span>(<span class="keyword">null</span>, <span class="variable">casted</span>);
      });
    });
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Counts documents</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  query</p></li><li><p><strong>param</strong>: <em>Function</em>  optional callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">count</span> = <span class="keyword">function</span> (<span class="variable">query</span>, <span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">query</span>(<span class="variable">query</span>, {}, <span class="variable">callback</span>, <span class="keyword">function</span> () {
    <span class="keyword">var</span> <span class="variable">casted</span> = <span class="variable">self</span>.<span class="variable">castQuery</span>(<span class="this">this</span>.<span class="variable">query</span>);
    <span class="variable">self</span>.<span class="variable">collection</span>.<span class="variable">count</span>(<span class="variable">casted</span>, <span class="this">this</span>.<span class="variable">queryComplete</span>.<span class="variable">bind</span>(<span class="this">this</span>));
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Updates documents.</p>

<h2>Examples</h2>

<pre><code>MyModel.update({ age: { $gt: 18 } }, { oldEnough: true }, fn);
MyModel.update({ name: 'Tobi' }, { ferret: true }, { multi: true }, fn);</code></pre>

<p>Valid options:
 - safe (boolean) safe mode (defaults to value set in schema (false))
 - upsert (boolean) whether to create the doc if it doesn't match (false)
 - multi (boolean) whether multiple documents should be update (false)</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  query</p></li><li><p><strong>param</strong>: _Object] doc</p></li><li><p><strong>para</strong>: <em>m</em>
{Object | Function_  optional options or callback</p></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>return</strong>: <em>Query</em> </p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">update</span> = <span class="keyword">function</span> (<span class="variable">query</span>, <span class="variable">doc</span>, <span class="variable">options</span>, <span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">query</span>(<span class="variable">query</span>, <span class="variable">options</span>, <span class="variable">callback</span>, <span class="keyword">function</span> () {
    <span class="keyword">var</span> <span class="variable">castQuery</span> = <span class="variable">self</span>.<span class="variable">castQuery</span>(<span class="this">this</span>.<span class="variable">query</span>)
      , <span class="variable">castDoc</span> = <span class="variable">self</span>.<span class="variable">castQuery</span>(<span class="variable">doc</span>)
      , <span class="variable">queryComplete</span> = <span class="this">this</span>.<span class="variable">queryComplete</span>.<span class="variable">bind</span>(<span class="this">this</span>);

    <span class="variable">self</span>.<span class="variable">collection</span>.<span class="variable">update</span>(<span class="variable">castQuery</span>, <span class="variable">castDoc</span>, <span class="this">this</span>.<span class="variable">options</span>, <span class="variable">queryComplete</span>);
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Compiler utility.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  model name</p></li><li><p><strong>param</strong>: <em>Schema</em>  schema object</p></li><li><p><strong>param</strong>: <em>String</em>  collection name</p></li><li><p><strong>param</strong>: <em>Connection</em>  connection to use</p></li><li><p><strong>param</strong>: <em>Mongoose</em>  mongoose instance</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Model</span>.<span class="variable">compile</span> = <span class="keyword">function</span> (<span class="variable">name</span>, <span class="variable">schema</span>, <span class="variable">collectionName</span>, <span class="variable">connection</span>, <span class="variable">base</span>) {
  <span class="comment">// generate new class</span>
  <span class="keyword">function</span> <span class="variable">model</span> () {
    <span class="class">Model</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
  };

  <span class="variable">model</span>.<span class="variable">name</span> = <span class="variable">name</span>;
  <span class="variable">model</span>.<span class="variable">__proto__</span> = <span class="class">Model</span>;
  <span class="variable">model</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">Model</span>.<span class="variable">prototype</span>;
  <span class="variable">model</span>.<span class="variable">prototype</span>.<span class="variable">base</span> = <span class="variable">base</span>;
  <span class="variable">model</span>.<span class="variable">prototype</span>.<span class="variable">schema</span> = <span class="variable">schema</span>;
  <span class="variable">model</span>.<span class="variable">prototype</span>.<span class="variable">db</span> = <span class="variable">connection</span>;
  <span class="variable">model</span>.<span class="variable">prototype</span>.<span class="variable">collection</span> = <span class="variable">connection</span>.<span class="variable">collection</span>(<span class="variable">collectionName</span>);

  <span class="comment">// apply methods</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">schema</span>.<span class="variable">methods</span>)
    <span class="variable">model</span>.<span class="variable">prototype</span>[<span class="variable">i</span>] = <span class="variable">schema</span>.<span class="variable">methods</span>[<span class="variable">i</span>];

  <span class="comment">// apply statics</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">schema</span>.<span class="variable">statics</span>)
    <span class="variable">model</span>[<span class="variable">i</span>] = <span class="variable">schema</span>.<span class="variable">statics</span>[<span class="variable">i</span>];

  <span class="keyword">return</span> <span class="variable">model</span>;
};
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/promise.js"><a href="#">promise</a></h2></td><td>lib/mongoose/promise.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">EventEmitter</span> = <span class="variable">require</span>(<span class="string">'./utils'</span>).<span class="class">EventEmitter</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Promise constructor.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  a callback+errback that takes err, ... as signature</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Promise</span> (<span class="variable">back</span>) {
  <span class="this">this</span>.<span class="variable">emitted</span> = {};
  <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="variable">back</span>)
    <span class="this">this</span>.<span class="variable">addBack</span>(<span class="variable">back</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from EventEmitter.
 </p>
</td>
<td class="code">
<pre><code><span class="class">Promise</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">EventEmitter</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds an event or fires the callback right away.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Promise</span>.<span class="variable">prototype</span>.<span class="variable">on</span> = <span class="keyword">function</span> (<span class="variable">event</span>, <span class="variable">callback</span>) {
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">emitted</span>[<span class="variable">event</span>])
    <span class="variable">callback</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="this">this</span>.<span class="variable">emitted</span>[<span class="variable">event</span>]);
  <span class="keyword">else</span>
    <span class="class">EventEmitter</span>.<span class="variable">prototype</span>.<span class="variable">on</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">event</span>, <span class="variable">callback</span>);

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Keeps track of emitted events to run them on <code>on</code></p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Promise</span>.<span class="variable">prototype</span>.<span class="variable">emit</span> = <span class="keyword">function</span> (<span class="variable">event</span>) {
  <span class="comment">// ensures a promise can't be complete() or error() twice</span>
  <span class="keyword">if</span> (<span class="variable">event</span> == <span class="string">'err'</span> || <span class="variable">event</span> == <span class="string">'complete'</span>){
    <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">emitted</span>.<span class="variable">err</span> || <span class="this">this</span>.<span class="variable">emitted</span>.<span class="variable">complete</span>)
      <span class="keyword">return</span> <span class="this">this</span>;
    <span class="this">this</span>.<span class="variable">emitted</span>[<span class="variable">event</span>] = <span class="class">Array</span>.<span class="variable">prototype</span>.<span class="variable">slice</span>.<span class="variable">call</span>(<span class="variable">arguments</span>, <span class="number integer">1</span>);
  }

  <span class="keyword">return</span> <span class="class">EventEmitter</span>.<span class="variable">prototype</span>.<span class="variable">emit</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Shortcut for emitting complete event</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Promise</span>.<span class="variable">prototype</span>.<span class="variable">complete</span> = <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">args</span> = <span class="class">Array</span>.<span class="variable">prototype</span>.<span class="variable">slice</span>.<span class="variable">call</span>(<span class="variable">arguments</span>);
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">emit</span>.<span class="variable">apply</span>(<span class="this">this</span>, [<span class="string">'complete'</span>].<span class="variable">concat</span>(<span class="variable">args</span>));
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Shortcut for emitting err event</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Promise</span>.<span class="variable">prototype</span>.<span class="variable">error</span> = <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">args</span> = <span class="class">Array</span>.<span class="variable">prototype</span>.<span class="variable">slice</span>.<span class="variable">call</span>(<span class="variable">arguments</span>);
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">emit</span>.<span class="variable">apply</span>(<span class="this">this</span>, [<span class="string">'err'</span>].<span class="variable">concat</span>(<span class="variable">args</span>));
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Shortcut for <code>.on('complete', fn)</code></p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Promise</span>.<span class="variable">prototype</span>.<span class="variable">addCallback</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">on</span>(<span class="string">'complete'</span>, <span class="variable">fn</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Shortcut for <code>.on('err', fn)</code></p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Promise</span>.<span class="variable">prototype</span>.<span class="variable">addErrback</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">on</span>(<span class="string">'err'</span>, <span class="variable">fn</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds a single function that's both callback and errback</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Promise</span>.<span class="variable">prototype</span>.<span class="variable">addBack</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="this">this</span>.<span class="variable">on</span>(<span class="string">'err'</span>, <span class="keyword">function</span>(<span class="variable">err</span>){
    <span class="variable">fn</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">err</span>);
  });

  <span class="this">this</span>.<span class="variable">on</span>(<span class="string">'complete'</span>, <span class="keyword">function</span>(){
    <span class="keyword">var</span> <span class="variable">args</span> = <span class="class">Array</span>.<span class="variable">prototype</span>.<span class="variable">slice</span>.<span class="variable">call</span>(<span class="variable">arguments</span>);
    <span class="variable">fn</span>.<span class="variable">apply</span>(<span class="this">this</span>, [<span class="keyword">null</span>].<span class="variable">concat</span>(<span class="variable">args</span>));
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">Promise</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/query.js"><a href="#">query</a></h2></td><td>lib/mongoose/query.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">Promise</span> = <span class="variable">require</span>(<span class="string">'./promise'</span>)
  , <span class="variable">inGroupsOf</span> = <span class="variable">require</span>(<span class="string">'./utils'</span>).<span class="variable">inGroupsOf</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Query constructor</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Query</span> (<span class="variable">query</span>, <span class="variable">options</span>, <span class="variable">onExecute</span>) {
  <span class="class">Promise</span>.<span class="variable">call</span>(<span class="this">this</span>);
  <span class="this">this</span>.<span class="variable">query</span> = <span class="variable">query</span> || {};
  <span class="this">this</span>.<span class="variable">options</span> = <span class="variable">options</span> || {};
  <span class="this">this</span>.<span class="variable">onExecute</span> = <span class="variable">onExecute</span>;
  <span class="this">this</span>.<span class="variable">executed</span> = <span class="variable">false</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from Promise.
 </p>
</td>
<td class="code">
<pre><code><span class="class">Query</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">Promise</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Runs the Query</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  optional back</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Query</span>.<span class="variable">prototype</span>.<span class="variable">exec</span> = 
<span class="class">Query</span>.<span class="variable">prototype</span>.<span class="variable">run</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">executed</span>)
    <span class="keyword">return</span> <span class="this">this</span>;

  <span class="keyword">if</span> (<span class="variable">fn</span>)
    <span class="this">this</span>.<span class="variable">addBack</span>(<span class="variable">fn</span>);

  <span class="this">this</span>.<span class="variable">executed</span> = <span class="variable">true</span>;
  
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">onExecute</span>) {
    <span class="keyword">try</span> {
      <span class="this">this</span>.<span class="variable">onExecute</span>.<span class="variable">call</span>(<span class="this">this</span>);
    } <span class="keyword">catch</span> (<span class="variable">e</span>) {
      <span class="this">this</span>.<span class="variable">queryComplete</span>(<span class="variable">e</span>);
    }
  }

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets an option</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  key</p></li><li><p><strong>param</strong>: <em>Object</em>  optional value</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Query</span>.<span class="variable">prototype</span>.<span class="variable">set</span> = <span class="keyword">function</span> (<span class="variable">key</span>, <span class="variable">value</span>) {
  <span class="keyword">if</span> (<span class="variable">arguments</span>.<span class="variable">length</span> == <span class="number integer">1</span>)
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">options</span>[<span class="variable">key</span>];
  <span class="this">this</span>.<span class="variable">options</span>[<span class="variable">key</span>] = <span class="variable">value</span>;
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Add conditions to query</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  query</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Query</span>.<span class="variable">prototype</span>.<span class="variable">where</span> = <span class="keyword">function</span> (<span class="variable">obj</span>, <span class="variable">value</span>) {
  <span class="keyword">if</span> (<span class="variable">value</span> == <span class="variable">undefined</span>)
    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">obj</span>)
      <span class="this">this</span>.<span class="variable">query</span>[<span class="variable">i</span>] = <span class="variable">obj</span>[<span class="variable">i</span>];
  <span class="keyword">else</span>
    <span class="this">this</span>.<span class="variable">query</span>[<span class="variable">obj</span>] = <span class="variable">value</span>;
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets the <code>skip</code> option</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Number</em>  value</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Query</span>.<span class="variable">prototype</span>.<span class="variable">skip</span> = <span class="keyword">function</span> (<span class="variable">v</span>) {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">set</span>(<span class="string">'skip'</span>, <span class="variable">v</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets the <code>limit</code> option</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Number</em>  value</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Query</span>.<span class="variable">prototype</span>.<span class="variable">limit</span> = <span class="keyword">function</span> (<span class="variable">v</span>) {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">set</span>(<span class="string">'limit'</span>, <span class="variable">v</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets the <code>timeout</code> option</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Number</em>  value</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Query</span>.<span class="variable">prototype</span>.<span class="variable">timeout</span> = <span class="keyword">function</span> (<span class="variable">v</span>) {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">set</span>(<span class="string">'timeout'</span>, <span class="variable">v</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets the sort</p>

<h2>Examples</h2>

<pre><code>query.sort('test', 1)
query.sort('field', -1)
query.sort('field', -1, 'test', 1)</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  fields</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Query</span>.<span class="variable">prototype</span>.<span class="variable">sort</span> = <span class="keyword">function</span> () {
  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">options</span>.<span class="variable">sort</span>)
    <span class="this">this</span>.<span class="variable">options</span>.<span class="variable">sort</span> = [];

  <span class="keyword">var</span> <span class="variable">args</span> = [].<span class="variable">slice</span>.<span class="variable">call</span>(<span class="variable">arguments</span>)
    , <span class="variable">query</span> = <span class="this">this</span>;
  <span class="variable">inGroupsOf</span>(<span class="number integer">2</span>, <span class="variable">args</span>, <span class="keyword">function</span> (<span class="variable">field</span>, <span class="variable">value</span>) {
    <span class="variable">query</span>.<span class="variable">options</span>.<span class="variable">sort</span>.<span class="variable">push</span>([<span class="variable">field</span>, <span class="variable">value</span>]);
  });

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Resolves the promise from a driver response</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Query</span>.<span class="variable">prototype</span>.<span class="variable">queryComplete</span> = <span class="keyword">function</span> (<span class="variable">err</span>) {
  <span class="keyword">if</span> (<span class="variable">err</span>)
    <span class="this">this</span>.<span class="variable">error</span>(<span class="variable">err</span>);
  <span class="keyword">else</span>
    <span class="this">this</span>.<span class="variable">complete</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="class">Array</span>.<span class="variable">prototype</span>.<span class="variable">slice</span>.<span class="variable">call</span>(<span class="variable">arguments</span>, <span class="number integer">1</span>));

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Find Query constructor (for queries that retrieve docs)</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">FindQuery</span> (<span class="variable">query</span>, <span class="variable">fields</span>, <span class="variable">options</span>, <span class="variable">onExecute</span>) {
  <span class="this">this</span>.<span class="variable">fields</span> = <span class="variable">fields</span> || {};
  <span class="class">Query</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">query</span>, <span class="variable">options</span>, <span class="variable">onExecute</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from Query.
 </p>
</td>
<td class="code">
<pre><code><span class="class">FindQuery</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">Query</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Specifies fields to return</p>

<h2>Examples</h2>

<p>   // these three are equivalent
   query.select('field', 'field2')
   query.select({ field: 1, field2: 1 })
   query.select(('field', 'field2');</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">FindQuery</span>.<span class="variable">prototype</span>.<span class="variable">select</span> = <span class="keyword">function</span> () {
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">arguments</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++) {
    <span class="keyword">if</span> (<span class="class">Array</span>.<span class="variable">isArray</span>(<span class="variable">arguments</span>[<span class="variable">i</span>])) {
      <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">a</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">arguments</span>[<span class="variable">i</span>].<span class="variable">length</span>; <span class="variable">a</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">a</span>++)
        <span class="this">this</span>.<span class="variable">fields</span>[<span class="variable">arguments</span>[<span class="variable">i</span>][<span class="variable">a</span>]] = <span class="number integer">1</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'object'</span> == <span class="keyword">typeof</span> <span class="variable">arguments</span>[<span class="variable">i</span>]) {
      <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">a</span> <span class="keyword">in</span> <span class="variable">arguments</span>[<span class="variable">i</span>])
        <span class="this">this</span>.<span class="variable">fields</span>[<span class="variable">a</span>] = <span class="variable">arguments</span>[<span class="variable">i</span>][<span class="variable">a</span>];
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'string'</span> == <span class="keyword">typeof</span> <span class="variable">arguments</span>[<span class="variable">i</span>]) {
      <span class="this">this</span>.<span class="variable">fields</span>[<span class="variable">arguments</span>[<span class="variable">i</span>]] = <span class="number integer">1</span>;
    }
  }
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports
 </p>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">Query</span> = <span class="class">Query</span>;

<span class="variable">exports</span>.<span class="class">FindQuery</span> = <span class="class">FindQuery</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/schema/boolean.js"><a href="#">boolean</a></h2></td><td>lib/mongoose/schema/boolean.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">SchemaType</span> = <span class="variable">require</span>(<span class="string">'../schematype'</span>)
  , <span class="class">CastError</span> = <span class="class">SchemaType</span>.<span class="class">CastError</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Boolean SchemaType constructor.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>param</strong>: <em>Object</em>  options</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">SchemaBoolean</span> (<span class="variable">path</span>, <span class="variable">options</span>) {
  <span class="class">SchemaType</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">path</span>, <span class="variable">options</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from SchemaType.
 </p>
</td>
<td class="code">
<pre><code><span class="class">SchemaBoolean</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">SchemaType</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Required validator for date</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaBoolean</span>.<span class="variable">prototype</span>.<span class="variable">checkRequired</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">return</span> <span class="variable">value</span> === <span class="variable">true</span> || <span class="variable">value</span> === <span class="variable">false</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Casts to boolean</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value to cast</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaBoolean</span>.<span class="variable">prototype</span>.<span class="variable">cast</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">if</span> (<span class="variable">value</span> === <span class="string">'0'</span>) <span class="keyword">return</span> <span class="variable">false</span>;
  <span class="keyword">return</span> !!<span class="variable">value</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">SchemaBoolean</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/schema/array.js"><a href="#">array</a></h2></td><td>lib/mongoose/schema/array.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">SchemaType</span> = <span class="variable">require</span>(<span class="string">'../schematype'</span>)
  , <span class="class">CastError</span> = <span class="class">SchemaType</span>.<span class="class">CastError</span>
  , <span class="class">ArrayNumberSchema</span> = <span class="keyword">function</span> () {}
  , <span class="class">Types</span> = {
        <span class="class">Boolean</span>: <span class="variable">require</span>(<span class="string">'./boolean'</span>)
      , <span class="class">Date</span>: <span class="variable">require</span>(<span class="string">'./date'</span>)
      , <span class="class">Number</span>: <span class="class">ArrayNumberSchema</span>
      , <span class="class">String</span>: <span class="variable">require</span>(<span class="string">'./string'</span>)
      , <span class="class">ObjectId</span>: <span class="variable">require</span>(<span class="string">'./objectid'</span>)
    }
  , <span class="class">MongooseArray</span> = <span class="variable">require</span>(<span class="string">'../types'</span>).<span class="class">Array</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Array SchemaType constructor</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  key</p></li><li><p><strong>param</strong>: <em>SchemaType</em>  cast</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">SchemaArray</span> (<span class="variable">key</span>, <span class="variable">cast</span>, <span class="variable">options</span>) {
  <span class="class">SchemaType</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">key</span>, <span class="variable">options</span>);

  <span class="keyword">if</span> (<span class="variable">cast</span>) {
    <span class="this">this</span>.<span class="variable">caster</span> = <span class="variable">cast</span>.<span class="variable">name</span> <span class="keyword">in</span> <span class="class">Types</span> ? <span class="class">Types</span>[<span class="variable">cast</span>.<span class="variable">name</span>] : <span class="variable">cast</span>;
  }

  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="this">this</span>.<span class="keyword">default</span>(<span class="keyword">function</span>(){
    <span class="keyword">return</span> <span class="keyword">new</span> <span class="class">MongooseArray</span>([], <span class="variable">self</span>.<span class="variable">path</span>, <span class="this">this</span>);
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from SchemaType.
 </p>
</td>
<td class="code">
<pre><code><span class="class">SchemaArray</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">SchemaType</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Check required</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaArray</span>.<span class="variable">prototype</span>.<span class="variable">checkRequired</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">return</span> !!(<span class="variable">value</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">value</span>.<span class="variable">length</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Casts contents</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value</p></li><li><p><strong>param</strong>: <em>Document</em>  document that triggers the casting</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaArray</span>.<span class="variable">prototype</span>.<span class="variable">cast</span> = <span class="keyword">function</span> (<span class="variable">value</span>, <span class="variable">doc</span>) {
  <span class="keyword">if</span> (<span class="class">Array</span>.<span class="variable">isArray</span>(<span class="variable">value</span>)){
    <span class="keyword">if</span> (!(<span class="variable">value</span> <span class="variable">instanceof</span> <span class="class">MongooseArray</span>))
      <span class="variable">value</span> = <span class="keyword">new</span> <span class="class">MongooseArray</span>(<span class="variable">value</span>, <span class="this">this</span>.<span class="variable">path</span>, <span class="variable">doc</span>);

    <span class="keyword">var</span> <span class="variable">caster</span> = <span class="this">this</span>.<span class="variable">caster</span>;

    <span class="keyword">if</span> (<span class="variable">caster</span>)
      <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">value</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++) {
        <span class="keyword">try</span> {
          <span class="variable">value</span>[<span class="variable">i</span>] = <span class="variable">caster</span>.<span class="variable">prototype</span>.<span class="variable">cast</span>.<span class="variable">call</span>(<span class="keyword">null</span>, <span class="variable">value</span>[<span class="variable">i</span>]);
        } <span class="keyword">catch</span>(<span class="variable">e</span>){
          <span class="comment">// rethrow</span>
          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">CastError</span>(<span class="variable">e</span>.<span class="variable">type</span>, <span class="variable">value</span>);
        }
      }

    <span class="keyword">return</span> <span class="variable">value</span>;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">cast</span>([<span class="variable">value</span>], <span class="variable">doc</span>);
  }

  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">CastError</span>(<span class="string">'array'</span>, <span class="variable">value</span>, <span class="variable">caster</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Number casting for arrays (equivalent, but without MongoseNumber)</p>

<ul><li><p><strong>see</strong>: <em>GH</em>
-176
## </p></li><li><p><strong>param</strong>: <em>Object</em>  value</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">ArrayNumberSchema</span>.<span class="variable">prototype</span>.<span class="variable">cast</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">if</span> (!<span class="variable">isNaN</span>(<span class="variable">value</span>)) {
    <span class="keyword">if</span> (<span class="variable">value</span> <span class="variable">instanceof</span> <span class="class">Number</span> || <span class="keyword">typeof</span> <span class="variable">value</span> == <span class="string">'number'</span> ||
       (<span class="variable">value</span>.<span class="variable">toString</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">value</span>.<span class="variable">toString</span>() == <span class="class">Number</span>(<span class="variable">value</span>)))
      <span class="keyword">return</span> <span class="class">Number</span>(<span class="variable">value</span>);
  }
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">CastError</span>(<span class="string">'number'</span>, <span class="variable">value</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">SchemaArray</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/schema/date.js"><a href="#">date</a></h2></td><td>lib/mongoose/schema/date.js</td></tr><tr class="code">
<td class="docs">
<p>Module requirements.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">SchemaType</span> = <span class="variable">require</span>(<span class="string">'../schematype'</span>)
  , <span class="class">CastError</span> = <span class="class">SchemaType</span>.<span class="class">CastError</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Date SchemaType constructor.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  key</p></li><li><p><strong>param</strong>: <em>Object</em>  options</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">SchemaDate</span> (<span class="variable">key</span>, <span class="variable">options</span>) {
  <span class="class">SchemaType</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">key</span>, <span class="variable">options</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from SchemaType.
 </p>
</td>
<td class="code">
<pre><code><span class="class">SchemaDate</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">SchemaType</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Required validator for date</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaDate</span>.<span class="variable">prototype</span>.<span class="variable">checkRequired</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">return</span> <span class="variable">value</span> <span class="variable">instanceof</span> <span class="class">Date</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Casts to date</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value to cast</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaDate</span>.<span class="variable">prototype</span>.<span class="variable">cast</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">if</span> (<span class="variable">value</span> <span class="variable">instanceof</span> <span class="class">Date</span>)
    <span class="keyword">return</span> <span class="variable">value</span>;

  <span class="keyword">var</span> <span class="variable">date</span>;

  <span class="comment">// support for timestamps</span>
  <span class="keyword">if</span> (<span class="variable">value</span> <span class="variable">instanceof</span> <span class="class">Number</span> || <span class="string">'number'</span> == <span class="keyword">typeof</span> <span class="variable">value</span> 
      || <span class="class">String</span>(<span class="variable">value</span>) == <span class="class">Number</span>(<span class="variable">value</span>))
    <span class="variable">date</span> = <span class="keyword">new</span> <span class="class">Date</span>(<span class="class">Number</span>(<span class="variable">value</span>));

  <span class="comment">// support for date strings</span>
  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">value</span>.<span class="variable">toString</span>)
    <span class="variable">date</span> = <span class="keyword">new</span> <span class="class">Date</span>(<span class="variable">value</span>.<span class="variable">toString</span>());

  <span class="keyword">if</span> (<span class="variable">date</span>.<span class="variable">toString</span>() != <span class="string">'Invalid Date'</span>)
    <span class="keyword">return</span> <span class="variable">date</span>;

  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">CastError</span>(<span class="string">'date'</span>, <span class="variable">value</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">SchemaDate</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/schema/documentarray.js"><a href="#">documentarray</a></h2></td><td>lib/mongoose/schema/documentarray.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">SchemaType</span> = <span class="variable">require</span>(<span class="string">'../schematype'</span>)
  , <span class="class">ArrayType</span> = <span class="variable">require</span>(<span class="string">'./array'</span>)
  , <span class="class">MongooseDocumentArray</span> = <span class="variable">require</span>(<span class="string">'../types/documentarray'</span>)
  , <span class="class">Subdocument</span> = <span class="variable">require</span>(<span class="string">'../types/document'</span>)
  , <span class="class">CastError</span> = <span class="class">SchemaType</span>.<span class="class">CastError</span>
  , <span class="class">Document</span> = <span class="variable">require</span>(<span class="string">'../document'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>SubdocsArray SchemaType constructor</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  key</p></li><li><p><strong>param</strong>: <em>Schema</em>  schema</p></li><li><p><strong>param</strong>: <em>Object</em>  options</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">DocumentArray</span> (<span class="variable">key</span>, <span class="variable">schema</span>, <span class="variable">options</span>) {
  <span class="comment">// compile an embedded document for this schema</span>
  <span class="keyword">function</span> <span class="class">EmbeddedDocument</span> () {
    <span class="class">Subdocument</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
  };

  <span class="class">EmbeddedDocument</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">Subdocument</span>.<span class="variable">prototype</span>;
  <span class="class">EmbeddedDocument</span>.<span class="variable">prototype</span>.<span class="variable">schema</span> = <span class="variable">schema</span>;

  <span class="class">ArrayType</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">key</span>, <span class="class">EmbeddedDocument</span>, <span class="variable">options</span>);

  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="this">this</span>.<span class="variable">schema</span> = <span class="variable">schema</span>;
  <span class="this">this</span>.<span class="keyword">default</span>(<span class="keyword">function</span>(){
    <span class="keyword">return</span> <span class="keyword">new</span> <span class="class">MongooseDocumentArray</span>([], <span class="variable">self</span>.<span class="variable">path</span>, <span class="this">this</span>);
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from ArrayType.
 </p>
</td>
<td class="code">
<pre><code><span class="class">DocumentArray</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">ArrayType</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Performs local validations first, then validations on each embedded doc</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">DocumentArray</span>.<span class="variable">prototype</span>.<span class="variable">doValidate</span> = <span class="keyword">function</span> (<span class="variable">array</span>, <span class="variable">fn</span>, <span class="variable">scope</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;
  <span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="variable">doValidate</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">array</span>, <span class="keyword">function</span>(<span class="variable">err</span>){
    <span class="keyword">if</span> (<span class="variable">err</span>) <span class="keyword">return</span> <span class="variable">fn</span>(<span class="variable">err</span>);
    
    <span class="keyword">var</span> <span class="variable">count</span> = <span class="variable">array</span>.<span class="variable">length</span>
      , <span class="variable">error</span> = <span class="variable">false</span>;

    <span class="keyword">if</span> (!<span class="variable">count</span>) <span class="keyword">return</span> <span class="variable">fn</span>();

    <span class="variable">array</span>.<span class="variable">forEach</span>(<span class="keyword">function</span>(<span class="variable">doc</span>, <span class="variable">index</span>){
      <span class="variable">doc</span>.<span class="variable">validate</span>(<span class="keyword">function</span>(<span class="variable">err</span>){
        <span class="keyword">if</span> (<span class="variable">err</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; !<span class="variable">error</span>){
          <span class="comment">// rewrite they key</span>
          <span class="variable">err</span>.<span class="variable">key</span> = <span class="variable">self</span>.<span class="variable">key</span> + <span class="string">'.'</span> + <span class="variable">index</span> + <span class="string">'.'</span> + <span class="variable">err</span>.<span class="variable">key</span>;
          <span class="variable">fn</span>(<span class="variable">err</span>);
          <span class="variable">error</span> = <span class="variable">true</span>;
        } <span class="keyword">else</span> {
          --<span class="variable">count</span> || <span class="variable">fn</span>();
        }
      });
    });
  }, <span class="variable">scope</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Casts contents</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value</p></li><li><p><strong>param</strong>: <em>Document</em>  document that triggers the casting</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">DocumentArray</span>.<span class="variable">prototype</span>.<span class="variable">cast</span> = <span class="keyword">function</span> (<span class="variable">value</span>, <span class="variable">doc</span>) {
  <span class="keyword">if</span> (<span class="class">Array</span>.<span class="variable">isArray</span>(<span class="variable">value</span>)){
    <span class="keyword">if</span> (!(<span class="variable">value</span> <span class="variable">instanceof</span> <span class="class">MongooseDocumentArray</span>))
      <span class="variable">value</span> = <span class="keyword">new</span> <span class="class">MongooseDocumentArray</span>(<span class="variable">value</span>, <span class="this">this</span>.<span class="variable">path</span>, <span class="variable">doc</span>);

    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">value</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++)
      <span class="keyword">if</span> (!(<span class="variable">value</span>[<span class="variable">i</span>] <span class="variable">instanceof</span> <span class="class">Subdocument</span>)){
        <span class="keyword">var</span> <span class="variable">doc</span> = <span class="keyword">new</span> <span class="this">this</span>.<span class="variable">caster</span>(<span class="keyword">null</span>, <span class="variable">value</span>);
        <span class="variable">value</span>[<span class="variable">i</span>] = <span class="variable">doc</span>.<span class="variable">init</span>(<span class="variable">value</span>[<span class="variable">i</span>]);
      }

    <span class="keyword">return</span> <span class="variable">value</span>;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">cast</span>([<span class="variable">value</span>], <span class="variable">doc</span>);
  }

  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">CastError</span>(<span class="string">'documentarray'</span>, <span class="variable">value</span>, <span class="this">this</span>.<span class="variable">caster</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">DocumentArray</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/schema/index.js"><a href="#">index</a></h2></td><td>lib/mongoose/schema/index.js</td></tr><tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">String</span> = <span class="variable">require</span>(<span class="string">'./string'</span>);

<span class="variable">exports</span>.<span class="class">Number</span> = <span class="variable">require</span>(<span class="string">'./number'</span>);

<span class="variable">exports</span>.<span class="class">Boolean</span> = <span class="variable">require</span>(<span class="string">'./boolean'</span>);

<span class="variable">exports</span>.<span class="class">DocumentArray</span> = <span class="variable">require</span>(<span class="string">'./documentarray'</span>);

<span class="variable">exports</span>.<span class="class">Array</span> = <span class="variable">require</span>(<span class="string">'./array'</span>);

<span class="variable">exports</span>.<span class="class">Date</span> = <span class="variable">require</span>(<span class="string">'./date'</span>);

<span class="variable">exports</span>.<span class="class">ObjectId</span> = <span class="variable">require</span>(<span class="string">'./objectid'</span>);

<span class="variable">exports</span>.<span class="class">Mixed</span> = <span class="variable">require</span>(<span class="string">'./mixed'</span>);
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/schema/mixed.js"><a href="#">mixed</a></h2></td><td>lib/mongoose/schema/mixed.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">SchemaType</span> = <span class="variable">require</span>(<span class="string">'../schematype'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Mixed SchemaType constructor.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>param</strong>: <em>Object</em>  options</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">SchemaMixed</span> (<span class="variable">path</span>, <span class="variable">options</span>) {
  <span class="class">SchemaType</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">path</span>, <span class="variable">options</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from SchemaType.
 </p>
</td>
<td class="code">
<pre><code><span class="class">SchemaMixed</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">SchemaType</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Required validator for mixed type</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaMixed</span>.<span class="variable">prototype</span>.<span class="variable">checkRequired</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">return</span> <span class="variable">true</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Noop casting</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value to cast</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaMixed</span>.<span class="variable">prototype</span>.<span class="variable">cast</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">return</span> <span class="variable">value</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">SchemaMixed</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/schema/number.js"><a href="#">number</a></h2></td><td>lib/mongoose/schema/number.js</td></tr><tr class="code">
<td class="docs">
<p>Module requirements.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">SchemaType</span> = <span class="variable">require</span>(<span class="string">'../schematype'</span>)
  , <span class="class">CastError</span> = <span class="class">SchemaType</span>.<span class="class">CastError</span>
  , <span class="class">MongooseNumber</span> = <span class="variable">require</span>(<span class="string">'../types/number'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Number SchemaType constructor.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  key</p></li><li><p><strong>param</strong>: <em>Object</em>  options</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">SchemaNumber</span> (<span class="variable">key</span>, <span class="variable">options</span>) {
  <span class="class">SchemaType</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">key</span>, <span class="variable">options</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from SchemaType.
 </p>
</td>
<td class="code">
<pre><code><span class="class">SchemaNumber</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">SchemaType</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Required validator for number</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaNumber</span>.<span class="variable">prototype</span>.<span class="variable">checkRequired</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">return</span> <span class="keyword">typeof</span> <span class="variable">value</span> == <span class="string">'number'</span> || <span class="variable">value</span> <span class="variable">instanceof</span> <span class="class">Number</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets a maximum number validator</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Number</em>  minimum number</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaNumber</span>.<span class="variable">prototype</span>.<span class="variable">min</span> = <span class="keyword">function</span> (<span class="variable">value</span>, <span class="variable">message</span>) {
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">minValidator</span>)
    <span class="this">this</span>.<span class="variable">validators</span> = <span class="this">this</span>.<span class="variable">validators</span>.<span class="variable">filter</span>(<span class="keyword">function</span>(<span class="variable">v</span>){
      <span class="keyword">return</span> <span class="variable">v</span>[<span class="number integer">1</span>] != <span class="string">'min'</span>;
    });
  <span class="keyword">if</span> (<span class="variable">value</span> != <span class="keyword">null</span>)
    <span class="this">this</span>.<span class="variable">validators</span>.<span class="variable">push</span>([<span class="keyword">function</span>(<span class="variable">v</span>){
      <span class="keyword">return</span> <span class="variable">v</span> &<span class="variable">gt</span>;= <span class="variable">value</span>;
    }, <span class="string">'min'</span>]);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets a maximum number validator</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Number</em>  maximum number</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaNumber</span>.<span class="variable">prototype</span>.<span class="variable">max</span> = <span class="keyword">function</span> (<span class="variable">value</span>, <span class="variable">message</span>) {
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">maxValidator</span>)
    <span class="this">this</span>.<span class="variable">validators</span> = <span class="this">this</span>.<span class="variable">validators</span>.<span class="variable">filter</span>(<span class="keyword">function</span>(<span class="variable">v</span>){
      <span class="keyword">return</span> <span class="variable">v</span>[<span class="number integer">1</span>] != <span class="string">'max'</span>;
    });
  <span class="keyword">if</span> (<span class="variable">value</span> != <span class="keyword">null</span>)
    <span class="this">this</span>.<span class="variable">validators</span>.<span class="variable">push</span>([<span class="this">this</span>.<span class="variable">maxValidator</span> = <span class="keyword">function</span>(<span class="variable">v</span>){
      <span class="keyword">return</span> <span class="variable">v</span> &<span class="variable">lt</span>;= <span class="variable">value</span>;
    }, <span class="string">'max'</span>]);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Casts to number</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value to cast</p></li><li><p><strong>param</strong>: <em>Document</em>  document that triggers the casting</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaNumber</span>.<span class="variable">prototype</span>.<span class="variable">cast</span> = <span class="keyword">function</span> (<span class="variable">value</span>, <span class="variable">doc</span>) {
  <span class="keyword">if</span> (!<span class="variable">isNaN</span>(<span class="variable">value</span>)){
    <span class="keyword">if</span> (<span class="string">'string'</span> === <span class="keyword">typeof</span> <span class="variable">value</span>) <span class="variable">value</span> = <span class="class">Number</span>(<span class="variable">value</span>);
    <span class="keyword">if</span> (<span class="variable">value</span> <span class="variable">instanceof</span> <span class="class">Number</span> || <span class="keyword">typeof</span> <span class="variable">value</span> == <span class="string">'number'</span> ||
       (<span class="variable">value</span>.<span class="variable">toString</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">value</span>.<span class="variable">toString</span>() == <span class="class">Number</span>(<span class="variable">value</span>)))
      <span class="keyword">return</span> <span class="keyword">new</span> <span class="class">MongooseNumber</span>(<span class="variable">value</span>, <span class="this">this</span>.<span class="variable">path</span>, <span class="variable">doc</span>);
  }
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">CastError</span>(<span class="string">'number'</span>, <span class="variable">value</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">SchemaNumber</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/schema/objectid.js"><a href="#">objectid</a></h2></td><td>lib/mongoose/schema/objectid.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">SchemaType</span> = <span class="variable">require</span>(<span class="string">'../schematype'</span>)
  , <span class="class">CastError</span> = <span class="class">SchemaType</span>.<span class="class">CastError</span>
  , <span class="variable">driver</span> = <span class="variable">global</span>.<span class="class">MONGOOSE_DRIVER_PATH</span> || <span class="string">'./../drivers/node-mongodb-native'</span>
  , <span class="variable">oid</span> = <span class="variable">require</span>(<span class="string">'../types/objectid'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>ObjectId SchemaType constructor.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  key</p></li><li><p><strong>param</strong>: <em>Object</em>  options</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">ObjectId</span> (<span class="variable">key</span>, <span class="variable">options</span>) {
  <span class="class">SchemaType</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">key</span>, <span class="variable">options</span>);

  <span class="this">this</span>.<span class="keyword">default</span>(<span class="keyword">function</span>(){
    <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">oid</span>();
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from SchemaType.
 </p>
</td>
<td class="code">
<pre><code><span class="class">ObjectId</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">SchemaType</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Check required</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">ObjectId</span>.<span class="variable">prototype</span>.<span class="variable">checkRequired</span> = <span class="keyword">function</span>(<span class="variable">value</span>){
  <span class="keyword">return</span> <span class="variable">value</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">value</span> <span class="variable">instanceof</span> <span class="variable">oid</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Casts to String </p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">ObjectId</span>.<span class="variable">prototype</span>.<span class="variable">cast</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">if</span> (<span class="variable">value</span> <span class="variable">instanceof</span> <span class="variable">oid</span>)
    <span class="keyword">return</span> <span class="variable">value</span>;
  <span class="keyword">if</span> (<span class="variable">value</span>.<span class="variable">toString</span>)
    <span class="keyword">return</span> <span class="variable">oid</span>.<span class="variable">fromString</span>(<span class="variable">value</span>.<span class="variable">toString</span>());
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">CastError</span>(<span class="string">'object id'</span>, <span class="variable">value</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">ObjectId</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/schema/string.js"><a href="#">string</a></h2></td><td>lib/mongoose/schema/string.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">SchemaType</span> = <span class="variable">require</span>(<span class="string">'../schematype'</span>)
  , <span class="class">CastError</span> = <span class="class">SchemaType</span>.<span class="class">CastError</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>String SchemaType constructor.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  key</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">SchemaString</span> (<span class="variable">key</span>, <span class="variable">options</span>) {
  <span class="this">this</span>.<span class="variable">enumValues</span> = [];
  <span class="this">this</span>.<span class="variable">regExp</span> = <span class="keyword">null</span>;
  <span class="class">SchemaType</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">key</span>, <span class="variable">options</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from SchemaType.
 </p>
</td>
<td class="code">
<pre><code><span class="class">SchemaString</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">SchemaType</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds enumeration values</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>multiple</em>  enumeration values</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaString</span>.<span class="variable">prototype</span>.<span class="keyword">enum</span> = <span class="keyword">function</span>(){
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">arguments</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++){
    <span class="keyword">if</span> (<span class="variable">arguments</span>[<span class="variable">i</span>] == <span class="keyword">null</span>){
      <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">enumValidator</span>){
        <span class="this">this</span>.<span class="variable">enumValidator</span> = <span class="variable">false</span>;
        <span class="this">this</span>.<span class="variable">validators</span> = <span class="this">this</span>.<span class="variable">validators</span>.<span class="variable">filter</span>(<span class="keyword">function</span>(<span class="variable">v</span>){
          <span class="keyword">return</span> <span class="variable">v</span>[<span class="number integer">1</span>] != <span class="string">'enum'</span>;
        });
      }
      <span class="keyword">break</span>;
    } <span class="keyword">else</span>
      <span class="this">this</span>.<span class="variable">enumValues</span>.<span class="variable">push</span>(<span class="this">this</span>.<span class="variable">cast</span>(<span class="variable">arguments</span>[<span class="variable">i</span>]));
  }

  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">enumValidator</span>){
    <span class="keyword">var</span> <span class="variable">values</span> = <span class="this">this</span>.<span class="variable">enumValues</span>;
    <span class="this">this</span>.<span class="variable">enumValidator</span> = <span class="keyword">function</span>(<span class="variable">v</span>){
      <span class="keyword">return</span> ~<span class="variable">values</span>.<span class="variable">indexOf</span>(<span class="variable">v</span>);
    };
    <span class="this">this</span>.<span class="variable">validators</span>.<span class="variable">push</span>([<span class="this">this</span>.<span class="variable">enumValidator</span>, <span class="string">'enum'</span>]);
  }
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets a regexp test</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>RegExp</em>  regular expression to test against</p></li><li><p><strong>param</strong>: <em>String</em>  optional validator message</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaString</span>.<span class="variable">prototype</span>.<span class="variable">match</span> = <span class="keyword">function</span>(<span class="variable">regExp</span>){
  <span class="this">this</span>.<span class="variable">validators</span>.<span class="variable">push</span>([<span class="keyword">function</span>(<span class="variable">v</span>){
    <span class="keyword">return</span> <span class="variable">regExp</span>.<span class="variable">test</span>(<span class="variable">v</span>);
  }, <span class="string">'regexp'</span>]);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Check required</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaString</span>.<span class="variable">prototype</span>.<span class="variable">checkRequired</span> = <span class="keyword">function</span> (<span class="variable">v</span>) {
  <span class="keyword">return</span> (<span class="variable">v</span> <span class="variable">instanceof</span> <span class="class">String</span> || <span class="keyword">typeof</span> <span class="variable">v</span> == <span class="string">'string'</span>) &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">v</span>.<span class="variable">length</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Casts to String</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaString</span>.<span class="variable">prototype</span>.<span class="variable">cast</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">if</span> (<span class="variable">value</span>.<span class="variable">toString</span>) <span class="keyword">return</span> <span class="variable">value</span>.<span class="variable">toString</span>();
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">CastError</span>(<span class="string">'string'</span>, <span class="variable">value</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">SchemaString</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/schema.js"><a href="#">schema</a></h2></td><td>lib/mongoose/schema.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">EventEmitter</span> = <span class="variable">require</span>(<span class="string">'events'</span>).<span class="class">EventEmitter</span>
  , <span class="class">Types</span> = <span class="variable">require</span>(<span class="string">'./schema/index'</span>)
  , <span class="class">VirtualType</span> = <span class="variable">require</span>(<span class="string">'./virtualtype'</span>)
  , <span class="variable">utils</span> = <span class="variable">require</span>(<span class="string">'./utils'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Schema constructor.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  definition</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Schema</span> (<span class="variable">obj</span>, <span class="variable">options</span>) {
  <span class="this">this</span>.<span class="variable">paths</span> = {};
  <span class="this">this</span>.<span class="variable">virtuals</span> = {};
  <span class="this">this</span>.<span class="variable">inherits</span> = {};
  <span class="this">this</span>.<span class="variable">callQueue</span> = [];
  <span class="this">this</span>.<span class="variable">_indexes</span> = [];
  <span class="this">this</span>.<span class="variable">methods</span> = {};
  <span class="this">this</span>.<span class="variable">statics</span> = {};
  <span class="this">this</span>.<span class="variable">tree</span> = {};

  <span class="comment">// set options</span>
  <span class="this">this</span>.<span class="variable">options</span> = <span class="variable">utils</span>.<span class="variable">options</span>({
      <span class="variable">safe</span>: <span class="variable">false</span>
    , <span class="string">'use$SetOnSave'</span>: <span class="variable">true</span>
  }, <span class="variable">options</span>);

  <span class="comment">// build paths</span>
  <span class="keyword">if</span> (<span class="variable">obj</span>)
    <span class="this">this</span>.<span class="variable">add</span>(<span class="variable">obj</span>);

  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">paths</span>[<span class="string">'_id'</span>])
    <span class="this">this</span>.<span class="variable">add</span>({ <span class="variable">_id</span>: <span class="class">ObjectId</span> });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherit from EventEmitter.
 </p>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">EventEmitter</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Schema by paths</p>

<p>Example (embedded doc):
   {
       'test'       : SchemaType,
     , 'test.test'  : SchemaType,
     , 'first_name' : SchemaType
   }</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">paths</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Schema as a tree</p>

<h2>Example</h2>

<p>   {
       '_id'     : ObjectId
     , 'nested'  : {
           'key': String
       }
   }</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">tree</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets the keys</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  keys</p></li><li><p><strong>param</strong>: <em>String</em>  prefix</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">add</span> = <span class="keyword">function</span> (<span class="variable">obj</span>, <span class="variable">prefix</span>) {
  <span class="variable">prefix</span> = <span class="variable">prefix</span> || <span class="string">''</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">obj</span>){
    <span class="comment">// make sure set of keys are in `tree`</span>
    <span class="keyword">if</span> (!<span class="variable">prefix</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; !<span class="this">this</span>.<span class="variable">tree</span>[<span class="variable">i</span>])
      <span class="this">this</span>.<span class="variable">tree</span>[<span class="variable">i</span>] = <span class="variable">obj</span>[<span class="variable">i</span>];

    <span class="keyword">if</span> (<span class="variable">obj</span>[<span class="variable">i</span>].<span class="variable">constructor</span> == <span class="class">Object</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; (!<span class="variable">obj</span>[<span class="variable">i</span>].<span class="variable">type</span> || <span class="variable">obj</span>[<span class="variable">i</span>].<span class="variable">__nested</span>)) {
      <span class="keyword">if</span> (<span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">obj</span>[<span class="variable">i</span>]).<span class="variable">length</span>)
        <span class="this">this</span>.<span class="variable">add</span>(<span class="variable">obj</span>[<span class="variable">i</span>], <span class="variable">i</span> + <span class="string">'.'</span>);
      <span class="keyword">else</span>
        <span class="this">this</span>.<span class="variable">path</span>(<span class="variable">prefix</span> + <span class="variable">i</span>, <span class="variable">obj</span>[<span class="variable">i</span>]); <span class="comment">// mixed type</span>
    } <span class="keyword">else</span>
      <span class="this">this</span>.<span class="variable">path</span>(<span class="variable">prefix</span> + <span class="variable">i</span>, <span class="variable">obj</span>[<span class="variable">i</span>]);
  }
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets a path (if arity 2)
Gets a path (if arity 1)</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>param</strong>: <em>Object</em>  constructor</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">path</span> = <span class="keyword">function</span> (<span class="variable">path</span>, <span class="variable">obj</span>) {
  <span class="keyword">if</span> (<span class="variable">obj</span> == <span class="variable">undefined</span>)
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">paths</span>[<span class="variable">path</span>];

  <span class="keyword">if</span> (<span class="variable">obj</span>.<span class="variable">constructor</span> != <span class="class">Object</span>)
    <span class="variable">obj</span> = { <span class="variable">type</span>: <span class="variable">obj</span> };

  <span class="keyword">var</span> <span class="variable">type</span> = <span class="variable">obj</span>.<span class="variable">type</span> || {}; <span class="comment">// defaults to mixed</span>

  <span class="keyword">if</span> (<span class="variable">type</span>.<span class="variable">constructor</span> == <span class="class">Object</span>)
    <span class="this">this</span>.<span class="variable">paths</span>[<span class="variable">path</span>] = <span class="keyword">new</span> <span class="class">Types</span>.<span class="class">Mixed</span>(<span class="variable">path</span>, <span class="variable">obj</span>);
  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="class">Array</span>.<span class="variable">isArray</span>(<span class="variable">type</span>) || <span class="variable">type</span> == <span class="class">Array</span>){
    <span class="comment">// if it was specified through { type } look for `cast`</span>
    <span class="keyword">var</span> <span class="variable">cast</span> = <span class="variable">type</span> == <span class="class">Array</span> ? <span class="variable">obj</span>.<span class="variable">cast</span> : <span class="variable">type</span>[<span class="number integer">0</span>];

    <span class="keyword">if</span> (<span class="variable">cast</span> <span class="variable">instanceof</span> <span class="class">Schema</span>)
      <span class="this">this</span>.<span class="variable">paths</span>[<span class="variable">path</span>] = <span class="keyword">new</span> <span class="class">Types</span>.<span class="class">DocumentArray</span>(<span class="variable">path</span>, <span class="variable">cast</span>, <span class="variable">obj</span>);
    <span class="keyword">else</span> 
      <span class="this">this</span>.<span class="variable">paths</span>[<span class="variable">path</span>] = <span class="keyword">new</span> <span class="class">Types</span>.<span class="class">Array</span>(<span class="variable">path</span>, <span class="variable">cast</span>, <span class="variable">obj</span>);
  } <span class="keyword">else</span>
    <span class="this">this</span>.<span class="variable">paths</span>[<span class="variable">path</span>] = <span class="keyword">new</span> <span class="class">Types</span>[<span class="variable">type</span>.<span class="variable">name</span>](<span class="variable">path</span>, <span class="variable">obj</span>);

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Iterates through the schema's paths, passing the path string and type object
to the callback.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  callback function - fn(pathstring, type)</p></li><li><p><strong>return</strong>: <em>Schema</em>  this for chaining</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">eachPath</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">k</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">paths</span>)
    <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">paths</span>.<span class="variable">hasOwnProperty</span>(<span class="variable">k</span>))
      <span class="variable">fn</span>(<span class="variable">k</span>, <span class="this">this</span>.<span class="variable">paths</span>[<span class="variable">k</span>]);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Given a path, returns whether it is a real, virtual, or
ad-hoc/undefined path</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>return</strong>: <em>String</em> </p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">pathType</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="keyword">if</span> (<span class="variable">path</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">paths</span>) <span class="keyword">return</span> <span class="string">'real'</span>;
  <span class="keyword">if</span> (<span class="variable">path</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">virtuals</span>) <span class="keyword">return</span> <span class="string">'virtual'</span>;
  <span class="keyword">return</span> <span class="string">'adhocOrUndefined'</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds a method call to the queue</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  method name</p></li><li><p><strong>param</strong>: <em>Array</em>  arguments</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">queue</span> = <span class="keyword">function</span>(<span class="variable">name</span>, <span class="variable">args</span>){
  <span class="this">this</span>.<span class="variable">callQueue</span>.<span class="variable">push</span>([<span class="variable">name</span>, <span class="variable">args</span>]);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Defines a pre for the document</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  method</p></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">pre</span> = <span class="keyword">function</span>(){
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">queue</span>(<span class="string">'pre'</span>, <span class="variable">arguments</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Defines a post for the document</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  method</p></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">post</span> = <span class="keyword">function</span>(<span class="variable">method</span>, <span class="variable">fn</span>){
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">queue</span>(<span class="string">'on'</span>, <span class="variable">arguments</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Registers a plugin for this schema</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  plugin callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">plugin</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="variable">fn</span>(<span class="this">this</span>);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds a method</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  method name</p></li><li><p><strong>param</strong>: <em>Function</em>  handler</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">method</span> = <span class="keyword">function</span> (<span class="variable">name</span>, <span class="variable">fn</span>) {
  <span class="keyword">if</span> (<span class="string">'string'</span> != <span class="keyword">typeof</span> <span class="variable">name</span>)
    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">name</span>)
      <span class="this">this</span>.<span class="variable">methods</span>[<span class="variable">i</span>] = <span class="variable">name</span>[<span class="variable">i</span>];
  <span class="keyword">else</span>
    <span class="this">this</span>.<span class="variable">methods</span>[<span class="variable">name</span>] = <span class="variable">fn</span>;
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Defines a static method</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  name</p></li><li><p><strong>param</strong>: <em>Function</em>  handler</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">static</span> = <span class="keyword">function</span>(<span class="variable">name</span>, <span class="variable">fn</span>) {
  <span class="keyword">if</span> (<span class="string">'string'</span> != <span class="keyword">typeof</span> <span class="variable">name</span>)
    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">name</span>)
      <span class="this">this</span>.<span class="variable">statics</span>[<span class="variable">i</span>] = <span class="variable">name</span>[<span class="variable">i</span>];
  <span class="keyword">else</span>
    <span class="this">this</span>.<span class="variable">statics</span>[<span class="variable">name</span>] = <span class="variable">fn</span>;
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Defines an index (most likely compound)
## Example
   schema.index({ first: 1, last: -1 })</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  field</p></li><li><p><strong>param</strong>: <em>Object</em>  optional options object</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">index</span> = <span class="keyword">function</span> (<span class="variable">fields</span>, <span class="variable">options</span>) {
  <span class="this">this</span>.<span class="variable">_indexes</span>.<span class="variable">push</span>([<span class="variable">fields</span>, <span class="variable">options</span> || {}]);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets/gets an option</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  key</p></li><li><p><strong>param</strong>: <em>Object</em>  optional value</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">set</span> = <span class="keyword">function</span> (<span class="variable">key</span>, <span class="variable">value</span>) {
  <span class="keyword">if</span> (<span class="variable">arguments</span>.<span class="variable">length</span> == <span class="number integer">1</span>)
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">options</span>[<span class="variable">key</span>];
  <span class="this">this</span>.<span class="variable">options</span>[<span class="variable">key</span>] = <span class="variable">value</span>;
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Compiles indexes from fields and schema-level indexes</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">__defineGetter__</span>(<span class="string">'indexes'</span>, <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">index</span>
    , <span class="variable">indexes</span> = []
    , <span class="variable">seenSchemas</span> = [];

  <span class="keyword">function</span> <span class="variable">collectIndexes</span> (<span class="variable">paths</span>, <span class="variable">prefix</span>) {
    <span class="variable">prefix</span> = <span class="variable">prefix</span> || <span class="string">''</span>;

    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">paths</span>){
      <span class="keyword">if</span> (<span class="variable">paths</span>[<span class="variable">i</span>]) {
        <span class="keyword">if</span> (<span class="variable">paths</span>[<span class="variable">i</span>] <span class="variable">instanceof</span> <span class="class">Types</span>.<span class="class">DocumentArray</span>) {
          <span class="comment">// avoid recursion</span>
          <span class="keyword">if</span> (!(~<span class="variable">seenSchemas</span>.<span class="variable">indexOf</span>(<span class="variable">paths</span>[<span class="variable">i</span>].<span class="variable">schema</span>))) {
            <span class="variable">seenSchemas</span>.<span class="variable">push</span>(<span class="variable">paths</span>[<span class="variable">i</span>].<span class="variable">schema</span>);
            <span class="variable">collectIndexes</span>(<span class="variable">paths</span>[<span class="variable">i</span>].<span class="variable">schema</span>.<span class="variable">paths</span>, <span class="variable">i</span> + <span class="string">'.'</span>);
          }
        } <span class="keyword">else</span> {
          <span class="variable">index</span> = <span class="variable">paths</span>[<span class="variable">i</span>].<span class="variable">_index</span>;

          <span class="keyword">if</span> (<span class="variable">index</span> !== <span class="variable">false</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">index</span> !== <span class="keyword">null</span>){
            <span class="keyword">var</span> <span class="variable">field</span> = {};
            <span class="variable">field</span>[<span class="variable">prefix</span> + <span class="variable">i</span>] = <span class="number integer">1</span>;
            <span class="variable">indexes</span>.<span class="variable">push</span>([<span class="variable">field</span>, <span class="variable">index</span>.<span class="variable">constructor</span> == <span class="class">Object</span> ? <span class="variable">index</span> : {} ]);
          }
        }
      }
    }
  }

  <span class="variable">collectIndexes</span>(<span class="this">this</span>.<span class="variable">paths</span>);

  <span class="keyword">return</span> <span class="variable">indexes</span>.<span class="variable">concat</span>(<span class="this">this</span>.<span class="variable">_indexes</span>);
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Retrieves or creates the virtual type with the given name.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  name</p></li><li><p><strong>return</strong>: <em>VirtualType</em> </p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">virtual</span> = <span class="keyword">function</span> (<span class="variable">name</span>) {
  <span class="keyword">var</span> <span class="variable">virtuals</span> = <span class="this">this</span>.<span class="variable">virtuals</span> || (<span class="this">this</span>.<span class="variable">virtuals</span> = {})
  <span class="keyword">return</span> <span class="variable">virtuals</span>[<span class="variable">name</span>] || (<span class="variable">virtuals</span>[<span class="variable">name</span>] = <span class="keyword">new</span> <span class="class">VirtualType</span>()); 
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Fetches the virtual type with the given name.
Should be distinct from virtual because virtual auto-defines a new VirtualType
if the path doesn't exist.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  name</p></li><li><p><strong>return</strong>: <em>VirtualType</em> </p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Schema</span>.<span class="variable">prototype</span>.<span class="variable">virtualpath</span> = <span class="keyword">function</span> (<span class="variable">name</span>) {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">virtuals</span>[<span class="variable">name</span>];
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>ObjectId schema identifier. Not an actual ObjectId, only used for Schemas.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">ObjectId</span> () {
  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'This is an abstract interface. Its only purpose is to mark '</span>
                + <span class="string">'fields as ObjectId in the schema creation.'</span>);
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="variable">exports</span> = <span class="class">Schema</span>;

<span class="variable">exports</span>.<span class="class">Types</span> = <span class="class">Types</span>;

<span class="variable">exports</span>.<span class="class">ObjectId</span> = <span class="class">ObjectId</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/schematype.js"><a href="#">schematype</a></h2></td><td>lib/mongoose/schematype.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">MongooseError</span> = <span class="variable">require</span>(<span class="string">'./error'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>SchemaType constructor</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">SchemaType</span> (<span class="variable">path</span>, <span class="variable">options</span>) {
  <span class="this">this</span>.<span class="variable">path</span> = <span class="variable">path</span>;
  <span class="this">this</span>.<span class="variable">defaultValue</span> = <span class="keyword">null</span>;
  <span class="this">this</span>.<span class="variable">validators</span> = [];
  <span class="this">this</span>.<span class="variable">setters</span> = [];
  <span class="this">this</span>.<span class="variable">getters</span> = [];
  <span class="this">this</span>.<span class="variable">options</span> = <span class="variable">options</span>;
  <span class="this">this</span>.<span class="variable">_index</span> = <span class="keyword">null</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">options</span>)
    <span class="keyword">if</span> (<span class="this">this</span>[<span class="variable">i</span>] &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="this">this</span>[<span class="variable">i</span>]){
      <span class="keyword">var</span> <span class="variable">opts</span> = <span class="class">Array</span>.<span class="variable">isArray</span>(<span class="variable">options</span>[<span class="variable">i</span>]) ? <span class="variable">options</span>[<span class="variable">i</span>] : [<span class="variable">options</span>[<span class="variable">i</span>]];
      <span class="this">this</span>[<span class="variable">i</span>].<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">opts</span>);
    }
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Base schema. Set by Schema when instantiated.</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="variable">base</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets a default</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  default value</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="keyword">default</span> = <span class="keyword">function</span> (<span class="variable">val</span>) {
  <span class="keyword">if</span> (<span class="variable">arguments</span>.<span class="variable">length</span>){
    <span class="this">this</span>.<span class="variable">defaultValue</span> = <span class="variable">val</span>;
    <span class="keyword">return</span> <span class="this">this</span>;
  }
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">defaultValue</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets index. It can be a boolean or a hash of options
## Example
   Schema.path('my.path').index(true);
   Schema.path('my.path').index({ unique: true });</p>

<p>"Direction doesn't matter for single key indexes"
http://www.mongodb.org/display/DOCS/Indexes#Indexes-CompoundKeysIndexes</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  true/</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="variable">index</span> = <span class="keyword">function</span> (<span class="variable">index</span>) {
  <span class="this">this</span>.<span class="variable">_index</span> = <span class="variable">index</span>;
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds an unique index</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Boolean</em> </p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="variable">unique</span> = <span class="keyword">function</span> (<span class="variable">bool</span>) {
  <span class="this">this</span>.<span class="variable">_index</span> = <span class="variable">bool</span> ? { <span class="variable">unique</span>: <span class="variable">true</span> } : <span class="keyword">null</span>;
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds a setter</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  setter</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="variable">set</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="this">this</span>.<span class="variable">setters</span>.<span class="variable">push</span>(<span class="variable">fn</span>);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds a getter</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  getter</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="variable">get</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="this">this</span>.<span class="variable">getters</span>.<span class="variable">push</span>(<span class="variable">fn</span>);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds a validator</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  validator</p></li><li><p><strong>param</strong>: <em>String</em>  optional error message</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="variable">validate</span> = <span class="keyword">function</span>(<span class="variable">obj</span>, <span class="variable">error</span>){
  <span class="this">this</span>.<span class="variable">validators</span>.<span class="variable">push</span>([<span class="variable">obj</span>, <span class="variable">error</span>]);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds a required validator</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Boolean</em>  enable/disable the validator</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="variable">required</span> = <span class="keyword">function</span>(<span class="variable">required</span>){
  <span class="keyword">var</span> <span class="variable">checkRequired</span> = <span class="this">this</span>.<span class="variable">checkRequired</span>.<span class="variable">bind</span>(<span class="this">this</span>);

  <span class="keyword">if</span> (<span class="variable">false</span> === <span class="variable">required</span>){
    <span class="this">this</span>.<span class="variable">validators</span> = <span class="this">this</span>.<span class="variable">validators</span>.<span class="variable">filter</span>(<span class="keyword">function</span>(<span class="variable">v</span>){
      <span class="keyword">return</span> <span class="variable">v</span>[<span class="number integer">0</span>] !== <span class="variable">checkRequired</span>;
    });
  } <span class="keyword">else</span> 
    <span class="this">this</span>.<span class="variable">validators</span>.<span class="variable">push</span>([<span class="variable">checkRequired</span>, <span class="string">'required'</span>]);

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Gets the default value</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  scope for callback defaults</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="variable">getDefault</span> = <span class="keyword">function</span> (<span class="variable">scope</span>) {
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">defaultValue</span> === <span class="variable">undefined</span>)
    <span class="keyword">return</span> <span class="keyword">null</span>;

  <span class="keyword">var</span> <span class="variable">ret</span>;

  <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="this">this</span>.<span class="variable">defaultValue</span>)
    <span class="variable">ret</span> = <span class="this">this</span>.<span class="variable">defaultValue</span>.<span class="variable">call</span>(<span class="variable">scope</span>);
  <span class="keyword">else</span>
    <span class="variable">ret</span> = <span class="this">this</span>.<span class="variable">defaultValue</span>;

  <span class="keyword">if</span> (<span class="variable">ret</span> !== <span class="keyword">null</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">ret</span> !== <span class="variable">undefined</span>)
    <span class="variable">ret</span> = <span class="this">this</span>.<span class="variable">cast</span>(<span class="variable">ret</span>, <span class="variable">scope</span>);

  <span class="keyword">return</span> <span class="variable">ret</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Applies setters</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value</p></li><li><p><strong>param</strong>: <em>Object</em>  scope</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="variable">applySetters</span> = <span class="keyword">function</span> (<span class="variable">value</span>, <span class="variable">scope</span>) {
  <span class="keyword">var</span> <span class="variable">v</span> = <span class="variable">value</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">l</span> = <span class="this">this</span>.<span class="variable">setters</span>.<span class="variable">length</span> - <span class="number integer">1</span>; <span class="variable">l</span> &<span class="variable">gt</span>;= <span class="number integer">0</span>; <span class="variable">l</span>--){
    <span class="variable">v</span> = <span class="this">this</span>.<span class="variable">setters</span>[<span class="variable">l</span>].<span class="variable">call</span>(<span class="variable">scope</span>, <span class="variable">v</span>);
    <span class="keyword">if</span> (<span class="variable">v</span> === <span class="keyword">null</span> || <span class="variable">v</span> === <span class="variable">undefined</span>) <span class="keyword">return</span> <span class="variable">v</span>;
    <span class="variable">v</span> = <span class="this">this</span>.<span class="variable">cast</span>(<span class="variable">v</span>, <span class="variable">scope</span>);
  }
  <span class="keyword">return</span> <span class="variable">v</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Applies getters to a value</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value</p></li><li><p><strong>param</strong>: <em>Object</em>  scope</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="variable">applyGetters</span> = <span class="keyword">function</span> (<span class="variable">value</span>, <span class="variable">scope</span>) {
  <span class="keyword">var</span> <span class="variable">v</span> = <span class="variable">value</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">l</span> = <span class="this">this</span>.<span class="variable">getters</span>.<span class="variable">length</span> - <span class="number integer">1</span>; <span class="variable">l</span> &<span class="variable">gt</span>;= <span class="number integer">0</span>; <span class="variable">l</span>--){
    <span class="variable">v</span> = <span class="this">this</span>.<span class="variable">getters</span>[<span class="variable">l</span>].<span class="variable">call</span>(<span class="variable">scope</span>, <span class="variable">v</span>);
    <span class="keyword">if</span> (<span class="variable">v</span> === <span class="keyword">null</span> || <span class="variable">v</span> === <span class="variable">undefined</span>) <span class="keyword">return</span> <span class="variable">v</span>;
    <span class="variable">v</span> = <span class="this">this</span>.<span class="variable">cast</span>(<span class="variable">v</span>, <span class="variable">scope</span>);
  }
  <span class="keyword">return</span> <span class="variable">v</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Performs a validation</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>param</strong>: <em>Object</em>  scope</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">SchemaType</span>.<span class="variable">prototype</span>.<span class="variable">doValidate</span> = <span class="keyword">function</span> (<span class="variable">value</span>, <span class="variable">fn</span>, <span class="variable">scope</span>) {
  <span class="keyword">var</span> <span class="variable">err</span> = <span class="variable">false</span>
    , <span class="variable">path</span> = <span class="this">this</span>.<span class="variable">path</span>
    , <span class="variable">count</span> = <span class="this">this</span>.<span class="variable">validators</span>.<span class="variable">length</span>;

  <span class="keyword">if</span> (!<span class="variable">count</span>) <span class="keyword">return</span> <span class="variable">fn</span>(<span class="keyword">null</span>);

  <span class="keyword">function</span> <span class="variable">validate</span> (<span class="variable">val</span>, <span class="variable">msg</span>) {
    <span class="keyword">if</span> (<span class="variable">err</span>) <span class="keyword">return</span>;
    <span class="keyword">if</span> (<span class="variable">val</span> === <span class="variable">undefined</span> || <span class="variable">val</span>) {
      --<span class="variable">count</span> || <span class="variable">fn</span>(<span class="keyword">null</span>);
    } <span class="keyword">else</span> {
      <span class="variable">fn</span>(<span class="keyword">new</span> <span class="class">ValidatorError</span>(<span class="variable">path</span>, <span class="variable">msg</span>));
      <span class="variable">err</span> = <span class="variable">true</span>;
    }
  }

  <span class="this">this</span>.<span class="variable">validators</span>.<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">v</span>){
    <span class="keyword">var</span> <span class="variable">validator</span> = <span class="variable">v</span>[<span class="number integer">0</span>]
      , <span class="variable">message</span> = <span class="variable">v</span>[<span class="number integer">1</span>];
    <span class="keyword">if</span> (<span class="variable">validator</span> <span class="variable">instanceof</span> <span class="class">RegExp</span>)
      <span class="variable">validate</span>(<span class="variable">validator</span>.<span class="variable">test</span>(<span class="variable">value</span>), <span class="variable">message</span>);
    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="variable">validator</span>)
      <span class="keyword">if</span> (<span class="number integer">2</span> == <span class="variable">validator</span>.<span class="variable">length</span>)
        <span class="variable">validator</span>.<span class="variable">call</span>(<span class="variable">scope</span>, <span class="variable">value</span>, <span class="keyword">function</span>(<span class="variable">val</span>){
          <span class="variable">validate</span>(<span class="variable">val</span>, <span class="variable">message</span>);
        })
      <span class="keyword">else</span>
        <span class="variable">validate</span>(<span class="variable">validator</span>.<span class="variable">call</span>(<span class="variable">scope</span>, <span class="variable">value</span>), <span class="variable">message</span>);
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Validator error</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>param</strong>: <em>String</em>  msg</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">ValidatorError</span> (<span class="variable">path</span>, <span class="variable">msg</span>) {
  <span class="class">MongooseError</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="string">'Validator &quot;'</span> + <span class="variable">msg</span> + <span class="string">'&quot; failed for path '</span> + <span class="variable">path</span>);
  <span class="class">Error</span>.<span class="variable">captureStackTrace</span>(<span class="this">this</span>, <span class="variable">arguments</span>.<span class="variable">callee</span>);
  <span class="this">this</span>.<span class="variable">name</span> = <span class="string">'ValidatorError'</span>;
  <span class="this">this</span>.<span class="variable">path</span> = <span class="variable">path</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from MongooseError
 </p>
</td>
<td class="code">
<pre><code><span class="class">ValidatorError</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">MongooseError</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Cast error</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">CastError</span> (<span class="variable">type</span>, <span class="variable">path</span>, <span class="variable">type</span>, <span class="variable">value</span>) {
  <span class="class">MongooseError</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="string">'Cast to '</span> + <span class="variable">type</span> + <span class="string">' failed for value &quot;'</span> + <span class="variable">value</span> + <span class="string">'&quot;'</span>);
  <span class="class">Error</span>.<span class="variable">captureStackTrace</span>(<span class="this">this</span>, <span class="variable">arguments</span>.<span class="variable">callee</span>);
  <span class="this">this</span>.<span class="variable">name</span> = <span class="string">'CastError'</span>;
  <span class="this">this</span>.<span class="variable">path</span> = <span class="variable">path</span>;
  <span class="this">this</span>.<span class="variable">type</span> = <span class="variable">type</span>;
  <span class="this">this</span>.<span class="variable">value</span> = <span class="variable">value</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from MongooseError.
 </p>
</td>
<td class="code">
<pre><code><span class="class">CastError</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">MongooseError</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="variable">exports</span> = <span class="class">SchemaType</span>;

<span class="variable">exports</span>.<span class="class">CastError</span> = <span class="class">CastError</span>;

<span class="variable">exports</span>.<span class="class">ValidatorError</span> = <span class="class">ValidatorError</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/types/array.js"><a href="#">array</a></h2></td><td>lib/mongoose/types/array.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">EmbeddedDocument</span> = <span class="variable">require</span>(<span class="string">'./document'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Mongoose Array constructor.
Values always have to be passed to the constructor to initialize, since
otherwise MongooseArray#push will mark the array as modified to the parent.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Array</em>  values</p></li><li><p><strong>param</strong>: <em>String</em>  key path</p></li><li><p><strong>param</strong>: <em>Document</em>  parent document</p></li><li><p><strong>api</strong>: <em>private</em></p></li><li><p><strong>see</strong>: <em>http</em>
://bit.ly/f6CnZU</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">MongooseArray</span> (<span class="variable">values</span>, <span class="variable">path</span>, <span class="variable">doc</span>) {
  <span class="keyword">var</span> <span class="variable">arr</span> = [];
  <span class="variable">arr</span>.<span class="variable">push</span>.<span class="variable">apply</span>(<span class="variable">arr</span>, <span class="variable">values</span>);
  <span class="variable">arr</span>.<span class="variable">__proto__</span> = <span class="class">MongooseArray</span>.<span class="variable">prototype</span>;
  <span class="variable">arr</span>.<span class="variable">_atomics</span> = [];
  <span class="variable">arr</span>.<span class="variable">validators</span> = [];
  <span class="variable">arr</span>.<span class="variable">_path</span> = <span class="variable">path</span>;
  <span class="variable">arr</span>.<span class="variable">_parent</span> = <span class="variable">doc</span>;
  <span class="keyword">if</span> (<span class="variable">doc</span>)
    <span class="variable">arr</span>.<span class="variable">_schema</span> = <span class="variable">doc</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">path</span>);
  <span class="keyword">return</span> <span class="variable">arr</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherit from Array.
 </p>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span> = <span class="keyword">new</span> <span class="class">Array</span>();</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Stores a queue of atomic operations to perform</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.<span class="variable">_atomics</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Parent owner document</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.<span class="variable">_parent</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Casts a member</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.<span class="variable">_cast</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">var</span> <span class="variable">cast</span> = <span class="this">this</span>.<span class="variable">_schema</span>.<span class="variable">caster</span>.<span class="variable">prototype</span>.<span class="variable">cast</span>
    , <span class="variable">doc</span> = <span class="this">this</span>.<span class="variable">_parent</span>;

  <span class="keyword">return</span> <span class="variable">cast</span>.<span class="variable">call</span>(<span class="keyword">null</span>, <span class="variable">value</span>, <span class="variable">doc</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Marks this array as modified</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.<span class="variable">_markModified</span> = <span class="keyword">function</span> () {
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">_parent</span>)
    <span class="this">this</span>.<span class="variable">_parent</span>.<span class="variable">activePaths</span>.<span class="variable">modify</span>(<span class="this">this</span>.<span class="variable">_path</span>);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Register an atomic operation with the parent</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Array</em>  operation</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.<span class="variable">_registerAtomic</span> = <span class="keyword">function</span> (<span class="variable">op</span>) {
  <span class="this">this</span>.<span class="variable">_atomics</span>.<span class="variable">push</span>(<span class="variable">op</span>);
  <span class="this">this</span>.<span class="variable">_markModified</span>();
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Returns true if we have to perform atomics for this, and no normal
operations</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.<span class="variable">__defineGetter__</span>(<span class="string">'doAtomics'</span>, <span class="keyword">function</span> () {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">_atomics</span>.<span class="variable">length</span>;
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Pushes item/s to the array atomically. Overrides Array#push</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">oldPush</span> = <span class="class">MongooseArray</span>.<span class="variable">prototype</span>.<span class="variable">push</span>;

<span class="class">MongooseArray</span>.<span class="variable">prototype</span>.$<span class="variable">push</span> = 
<span class="class">MongooseArray</span>.<span class="variable">prototype</span>.<span class="variable">push</span> = <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>
    , <span class="variable">values</span> = <span class="class">Array</span>.<span class="variable">prototype</span>.<span class="variable">map</span>.<span class="variable">call</span>(<span class="variable">arguments</span>, <span class="keyword">function</span>(<span class="variable">obj</span>){
        <span class="keyword">return</span> <span class="variable">self</span>.<span class="variable">_cast</span>(<span class="variable">obj</span>);
      })
    , <span class="variable">ret</span> = <span class="variable">oldPush</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">values</span>);

  <span class="keyword">if</span> (<span class="number integer">1</span> === <span class="variable">values</span>.<span class="variable">length</span>)
    <span class="this">this</span>.<span class="variable">_registerAtomic</span>([<span class="string">'$push'</span>, <span class="variable">values</span>[<span class="number integer">0</span>]]);
  <span class="keyword">else</span>
    <span class="this">this</span>.<span class="variable">_registerAtomic</span>([<span class="string">'$pushAll'</span>, <span class="variable">values</span>]);

  <span class="keyword">return</span> <span class="variable">ret</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Pushes item/s to the array non-atomically</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.<span class="variable">nonAtomicPush</span> = <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>
    , <span class="variable">values</span> = <span class="class">Array</span>.<span class="variable">prototype</span>.<span class="variable">map</span>.<span class="variable">call</span>(<span class="variable">arguments</span>, <span class="keyword">function</span> (<span class="variable">obj</span>) {
        <span class="keyword">return</span> <span class="variable">self</span>.<span class="variable">_cast</span>(<span class="variable">obj</span>);
      })
    , <span class="variable">ret</span> = <span class="variable">oldPush</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">values</span>);

  <span class="this">this</span>.<span class="variable">_markModified</span>();

  <span class="keyword">return</span> <span class="variable">ret</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Pushes several items at once to the array atomically</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Array</em>  values</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.$<span class="variable">pushAll</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">var</span> <span class="variable">length</span> = <span class="this">this</span>.<span class="variable">length</span>;
  <span class="this">this</span>.<span class="variable">push</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">value</span>);
  <span class="comment">// make sure we access the casted elements</span>
  <span class="this">this</span>.<span class="variable">_registerAtomic</span>([<span class="string">'$pushAll'</span>, <span class="this">this</span>.<span class="variable">slice</span>(<span class="variable">length</span>) ]);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Pops the array atomically</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.$<span class="variable">pop</span> = <span class="keyword">function</span> () {
  <span class="this">this</span>.<span class="variable">_registerAtomic</span>([<span class="string">'$pop'</span>, <span class="string">'1'</span>]);
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">pop</span>();
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Shifts the array</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.$<span class="variable">shift</span> = <span class="keyword">function</span> () {
  <span class="this">this</span>.<span class="variable">_registerAtomic</span>([<span class="string">'$shift'</span>, <span class="string">'-1'</span>]);
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">shift</span>();
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Removes items from an array atomically</p>

<h2>Examples</h2>

<pre><code>doc.array.remove(ObjectId)
doc.array.remove('tag 1', 'tag 2')</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value to remove</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.<span class="variable">remove</span> = <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">args</span> = <span class="class">Array</span>.<span class="variable">prototype</span>.<span class="variable">map</span>.<span class="variable">call</span>(<span class="variable">arguments</span>, <span class="this">this</span>.<span class="variable">_cast</span>, <span class="this">this</span>);
  <span class="keyword">if</span> (<span class="variable">args</span>.<span class="variable">length</span> == <span class="number integer">1</span>)
    <span class="this">this</span>.$<span class="variable">pull</span>(<span class="variable">args</span>[<span class="number integer">0</span>]);
  <span class="keyword">else</span>
    <span class="this">this</span>.$<span class="variable">pullAll</span>(<span class="variable">args</span>);
  <span class="keyword">return</span> <span class="variable">args</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Pulls from the array</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.$<span class="variable">pull</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="this">this</span>.<span class="variable">_registerAtomic</span>([<span class="string">'$pull'</span>, <span class="variable">value</span>]);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Pulls many items from an array</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.$<span class="variable">pullAll</span> = <span class="keyword">function</span> (<span class="variable">values</span>) {
  <span class="keyword">if</span> (<span class="variable">values</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">values</span>.<span class="variable">length</span>)
    <span class="this">this</span>.<span class="variable">_registerAtomic</span>([<span class="string">'$pullAll'</span>, <span class="variable">values</span>]);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Returns an Array</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>Array</em> </p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseArray</span>.<span class="variable">prototype</span>.<span class="variable">toObject</span> = <span class="keyword">function</span> () {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">map</span>( <span class="keyword">function</span> (<span class="variable">doc</span>) {
    <span class="keyword">return</span> <span class="variable">doc</span>;
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">MongooseArray</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/types/document.js"><a href="#">document</a></h2></td><td>lib/mongoose/types/document.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">Document</span> = <span class="variable">require</span>(<span class="string">'../document'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>EmbeddedDocument constructor.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  object from db</p></li><li><p><strong>param</strong>: <em>MongooseDocumentArray</em>  parent array</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">EmbeddedDocument</span> (<span class="variable">obj</span>, <span class="variable">parentArr</span>) {
  <span class="this">this</span>.<span class="variable">parentArray</span> = <span class="variable">parentArr</span>;
  <span class="this">this</span>.<span class="variable">parent</span> = <span class="variable">parentArr</span>.<span class="variable">parent</span>;
  <span class="class">Document</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">obj</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherit from Document</p>

<p> </p>
</td>
<td class="code">
<pre><code><span class="class">EmbeddedDocument</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">Document</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Override save to mark the parent as modified</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">oldSet</span> = <span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">set</span>;

<span class="class">EmbeddedDocument</span>.<span class="variable">prototype</span>.<span class="variable">set</span> = <span class="keyword">function</span> () {
  <span class="this">this</span>.<span class="variable">markModified</span>();
  <span class="keyword">return</span> <span class="variable">oldSet</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Marks parent array as modified</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">EmbeddedDocument</span>.<span class="variable">prototype</span>.<span class="variable">markModified</span> = <span class="keyword">function</span> () {
  <span class="this">this</span>.<span class="variable">parentArray</span>.<span class="variable">_markModified</span>();
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Save the subdocument</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">EmbeddedDocument</span>.<span class="variable">prototype</span>.<span class="variable">save</span> = <span class="keyword">function</span>(<span class="variable">fn</span>) {
  <span class="keyword">if</span> (<span class="variable">fn</span>)
    <span class="variable">fn</span>(<span class="keyword">null</span>);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Remove the subdocument</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">EmbeddedDocument</span>.<span class="variable">prototype</span>.<span class="variable">remove</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">willRemove</span>){
    <span class="this">this</span>.<span class="variable">parentArray</span>.$<span class="variable">pull</span>({ <span class="variable">_id</span>: <span class="this">this</span>.<span class="variable">doc</span>.<span class="variable">_id</span> });
    <span class="this">this</span>.<span class="variable">willRemove</span> = <span class="variable">true</span>;
  }

  <span class="keyword">if</span> (<span class="variable">fn</span>)
    <span class="variable">fn</span>(<span class="keyword">null</span>);

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Register hooks for some methods
 </p>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">registerHooks</span>.<span class="variable">call</span>(<span class="class">EmbeddedDocument</span>, <span class="string">'save'</span>, <span class="string">'remove'</span>, <span class="string">'init'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exxports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">EmbeddedDocument</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/types/documentarray.js"><a href="#">documentarray</a></h2></td><td>lib/mongoose/types/documentarray.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">MongooseArray</span> = <span class="variable">require</span>(<span class="string">'./array'</span>)
  , <span class="variable">driver</span> = <span class="variable">global</span>.<span class="class">MONGOOSE_DRIVER_PATH</span> || <span class="string">'../drivers/node-mongodb-native'</span>
  , <span class="class">ObjectId</span> = <span class="variable">require</span>(<span class="variable">driver</span> + <span class="string">'/objectid'</span>)
  , <span class="class">ObjectIdSchema</span> = <span class="variable">require</span>(<span class="string">'../schema/objectid'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Array of embedded documents
Values always have to be passed to the constructor to initialize, since
otherwise MongooseArray#push will mark the array as modified to the parent.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Array</em>  values</p></li><li><p><strong>param</strong>: <em>String</em>  key path</p></li><li><p><strong>param</strong>: <em>Document</em>  parent document</p></li><li><p><strong>api</strong>: <em>private</em></p></li><li><p><strong>see</strong>: <em>http</em>
://bit.ly/f6CnZU</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">MongooseDocumentArray</span> (<span class="variable">values</span>, <span class="variable">path</span>, <span class="variable">doc</span>) {
  <span class="keyword">var</span> <span class="variable">arr</span> = [];
  <span class="variable">arr</span>.<span class="variable">push</span>.<span class="variable">apply</span>(<span class="variable">arr</span>, <span class="variable">values</span>);
  <span class="variable">arr</span>.<span class="variable">__proto__</span> = <span class="class">MongooseDocumentArray</span>.<span class="variable">prototype</span>;
  <span class="variable">arr</span>.<span class="variable">_atomics</span> = [];
  <span class="variable">arr</span>.<span class="variable">validators</span> = [];
  <span class="variable">arr</span>.<span class="variable">_path</span> = <span class="variable">path</span>;
  <span class="variable">arr</span>.<span class="variable">_parent</span> = <span class="variable">doc</span>;
  <span class="keyword">if</span> (<span class="variable">doc</span>)
    <span class="variable">arr</span>.<span class="variable">_schema</span> = <span class="variable">doc</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">path</span>);
  <span class="keyword">return</span> <span class="variable">arr</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from MongooseArray
 </p>
</td>
<td class="code">
<pre><code><span class="class">MongooseDocumentArray</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">MongooseArray</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Overrides cast</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseDocumentArray</span>.<span class="variable">prototype</span>.<span class="variable">_cast</span> = <span class="keyword">function</span> (<span class="variable">value</span>) {
  <span class="keyword">var</span> <span class="variable">doc</span> = <span class="keyword">new</span> <span class="this">this</span>.<span class="variable">_schema</span>.<span class="variable">caster</span>(<span class="variable">value</span>, <span class="this">this</span>);
  <span class="keyword">return</span> <span class="variable">doc</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Filters items by id</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  id</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseDocumentArray</span>.<span class="variable">prototype</span>.<span class="variable">id</span> = <span class="keyword">function</span>(<span class="variable">id</span>) {
  <span class="keyword">try</span> {
    <span class="keyword">var</span> <span class="variable">casted</span> = <span class="class">ObjectIdSchema</span>.<span class="variable">prototype</span>.<span class="variable">cast</span>.<span class="variable">call</span>(<span class="keyword">null</span>, <span class="variable">id</span>);
  } <span class="keyword">catch</span> (<span class="variable">e</span>) {
    <span class="comment">// cast error</span>
    <span class="keyword">return</span> <span class="keyword">null</span>;
  }

  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="this">this</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++) {
    <span class="keyword">if</span> (<span class="class">ObjectId</span>.<span class="variable">toString</span>(<span class="variable">casted</span>) == <span class="class">ObjectId</span>.<span class="variable">toString</span>(<span class="this">this</span>[<span class="variable">i</span>].<span class="variable">get</span>(<span class="string">'_id'</span>)))
      <span class="keyword">return</span> <span class="this">this</span>[<span class="variable">i</span>];
  }

  <span class="keyword">return</span> <span class="keyword">null</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">MongooseDocumentArray</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/types/index.js"><a href="#">index</a></h2></td><td>lib/mongoose/types/index.js</td></tr><tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="class">Array</span> = <span class="variable">require</span>(<span class="string">'./array'</span>);
<span class="variable">exports</span>.<span class="class">Document</span> = <span class="variable">require</span>(<span class="string">'./document'</span>);
<span class="variable">exports</span>.<span class="class">DocumentArray</span> = <span class="variable">require</span>(<span class="string">'./documentarray'</span>);
<span class="variable">exports</span>.<span class="class">Number</span> = <span class="variable">require</span>(<span class="string">'./number'</span>);
<span class="variable">exports</span>.<span class="class">ObjectId</span> = <span class="variable">require</span>(<span class="string">'./objectid'</span>);
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/types/number.js"><a href="#">number</a></h2></td><td>lib/mongoose/types/number.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">

</td>
</tr>
<tr class="code">
<td class="docs">
<p>MongooseNumber constructor.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value to pass to Number</p></li><li><p><strong>param</strong>: <em>Document</em>  parent document</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">MongooseNumber</span> (<span class="variable">value</span>, <span class="variable">path</span>, <span class="variable">doc</span>) {
  <span class="this">this</span>.<span class="variable">_atomics</span> = [];
  <span class="this">this</span>.<span class="variable">v</span> = <span class="variable">value</span>;
  <span class="this">this</span>.<span class="variable">_path</span> = <span class="variable">path</span>;
  <span class="this">this</span>.<span class="variable">_parent</span> = <span class="variable">doc</span>;
  <span class="class">Number</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">value</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherits from Number.
 </p>
</td>
<td class="code">
<pre><code><span class="class">MongooseNumber</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">Number</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Atomic increment</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseNumber</span>.<span class="variable">prototype</span>.<span class="variable">increment</span> = <span class="keyword">function</span>(<span class="variable">value</span>){
  <span class="variable">value</span> = <span class="class">Number</span>(<span class="variable">value</span>);
  <span class="this">this</span>.<span class="variable">v</span> += (<span class="variable">value</span> || <span class="number integer">1</span>);
  <span class="this">this</span>.<span class="variable">_atomics</span> = [[<span class="string">'$inc'</span>, <span class="variable">value</span> || <span class="number integer">1</span>]];
  <span class="this">this</span>.<span class="variable">_parent</span>.<span class="variable">activePaths</span>.<span class="variable">modify</span>(<span class="this">this</span>.<span class="variable">_path</span>);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Returns true if we have to perform atomics for this, and no normal
operations</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseNumber</span>.<span class="variable">prototype</span>.<span class="variable">__defineGetter__</span>(<span class="string">'doAtomics'</span>, <span class="keyword">function</span> () {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">_atomics</span>.<span class="variable">length</span>;
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Atomic decrement</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseNumber</span>.<span class="variable">prototype</span>.<span class="variable">decrement</span> = <span class="keyword">function</span>(){
  <span class="this">this</span>.<span class="variable">increment</span>(-<span class="number integer">1</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Implement valueOf</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseNumber</span>.<span class="variable">prototype</span>.<span class="variable">valueOf</span> = <span class="keyword">function</span> () {
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">v</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Implement toString</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">MongooseNumber</span>.<span class="variable">prototype</span>.<span class="variable">toString</span> = <span class="keyword">function</span> () {
  <span class="keyword">return</span> <span class="class">String</span>(<span class="this">this</span>.<span class="variable">valueOf</span>());
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">MongooseNumber</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/types/objectid.js"><a href="#">objectid</a></h2></td><td>lib/mongoose/types/objectid.js</td></tr><tr class="code">
<td class="docs">
<p>Access driver.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">driver</span> = <span class="variable">global</span>.<span class="class">MONGOOSE_DRIVER_PATH</span> || <span class="string">'../drivers/node-mongodb-native'</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="variable">require</span>(<span class="variable">driver</span> + <span class="string">'/objectid'</span>);
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/utils.js"><a href="#">utils</a></h2></td><td>lib/mongoose/utils.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">EventEmitter</span> = <span class="variable">require</span>(<span class="string">'events'</span>).<span class="class">EventEmitter</span>
  , <span class="class">ObjectId</span> = <span class="variable">require</span>(<span class="string">'./types/objectid'</span>)</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Produces a collection name from a model name</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  model name</p></li><li><p><strong>return</strong>: <em>String</em>  collection name</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">toCollectionName</span> = <span class="keyword">function</span>(<span class="variable">name</span>) {
  <span class="keyword">return</span> <span class="variable">pluralize</span>(<span class="variable">name</span>.<span class="variable">toLowerCase</span>());
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Pluralization rules.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">rules</span> = [
  [<span class="regexp">/(m)an$/gi</span>, <span class="string">'$1en'</span>],
  [<span class="regexp">/(pe)rson$/gi</span>, <span class="string">'$1ople'</span>],
  [<span class="regexp">/(child)$/gi</span>, <span class="string">'$1ren'</span>],
  [<span class="regexp">/^(ox)$/gi</span>, <span class="string">'$1en'</span>],
  [<span class="regexp">/(ax|test)is$/gi</span>, <span class="string">'$1es'</span>],
  [<span class="regexp">/(octop|vir)us$/gi</span>, <span class="string">'$1i'</span>],
  [<span class="regexp">/(alias|status)$/gi</span>, <span class="string">'$1es'</span>],
  [<span class="regexp">/(bu)s$/gi</span>, <span class="string">'$1ses'</span>],
  [<span class="regexp">/(buffal|tomat|potat)o$/gi</span>, <span class="string">'$1oes'</span>],
  [<span class="regexp">/([ti])um$/gi</span>, <span class="string">'$1a'</span>],
  [<span class="regexp">/sis$/gi</span>, <span class="string">'ses'</span>],
  [<span class="regexp">/(?:([^f])fe|([lr])f)$/gi</span>, <span class="string">'$1$2ves'</span>],
  [<span class="regexp">/(hive)$/gi</span>, <span class="string">'$1s'</span>],
  [<span class="regexp">/([^aeiouy]|qu)y$/gi</span>, <span class="string">'$1ies'</span>],
  [<span class="regexp">/(x|ch|ss|sh)$/gi</span>, <span class="string">'$1es'</span>],
  [<span class="regexp">/(matr|vert|ind)ix|ex$/gi</span>, <span class="string">'$1ices'</span>],
  [<span class="regexp">/([m|l])ouse$/gi</span>, <span class="string">'$1ice'</span>],
  [<span class="regexp">/(quiz)$/gi</span>, <span class="string">'$1zes'</span>],
  [<span class="regexp">/s$/gi</span>, <span class="string">'s'</span>],
  [<span class="regexp">/$/gi</span>, <span class="string">'s'</span>]
];</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Uncountable words.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">uncountables</span> = [
  <span class="string">'advice'</span>,
  <span class="string">'energy'</span>,
  <span class="string">'excretion'</span>,
  <span class="string">'digestion'</span>,
  <span class="string">'cooperation'</span>,
  <span class="string">'health'</span>,
  <span class="string">'justice'</span>,
  <span class="string">'labour'</span>,
  <span class="string">'machinery'</span>,
  <span class="string">'equipment'</span>,
  <span class="string">'information'</span>,
  <span class="string">'pollution'</span>,
  <span class="string">'sewage'</span>,
  <span class="string">'paprer'</span>,
  <span class="string">'money'</span>,
  <span class="string">'species'</span>,
  <span class="string">'series'</span>,
  <span class="string">'rain'</span>,
  <span class="string">'rice'</span>,
  <span class="string">'fish'</span>,
  <span class="string">'sheep'</span>,
  <span class="string">'moose'</span>,
  <span class="string">'deer'</span>,
  <span class="string">'news'</span>
];</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Pluralize function.</p>

<ul><li><p><strong>author</strong>: <em>TJ</em>
Holowaychuk (extracted from <em>ext.js</em>)
## </p></li><li><p><strong>param</strong>: <em>String</em>  string to pluralize</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">pluralize</span> (<span class="variable">str</span>) {
  <span class="keyword">var</span> <span class="variable">rule</span>, <span class="variable">found</span>;
  <span class="keyword">if</span> (!~<span class="variable">uncountables</span>.<span class="variable">indexOf</span>(<span class="variable">str</span>.<span class="variable">lowercase</span>)){
    <span class="variable">found</span> = <span class="variable">rules</span>.<span class="variable">filter</span>(<span class="keyword">function</span>(<span class="variable">rule</span>){
      <span class="keyword">return</span> <span class="variable">str</span>.<span class="variable">match</span>(<span class="variable">rule</span>[<span class="number integer">0</span>]);
    });
    <span class="keyword">if</span> (<span class="variable">found</span>[<span class="number integer">0</span>]) <span class="keyword">return</span> <span class="variable">str</span>.<span class="variable">replace</span>(<span class="variable">found</span>[<span class="number integer">0</span>][<span class="number integer">0</span>], <span class="variable">found</span>[<span class="number integer">0</span>][<span class="number integer">1</span>]);
  }
  <span class="keyword">return</span> <span class="variable">str</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Add <code>once</code> to EventEmitter if absent</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  event name</p></li><li><p><strong>param</strong>: <em>Function</em>  listener</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">Events</span> = <span class="class">EventEmitter</span>;

<span class="keyword">if</span> (!(<span class="string">'once'</span> <span class="keyword">in</span> <span class="class">EventEmitter</span>.<span class="variable">prototype</span>)){
  
  <span class="class">Events</span> = <span class="keyword">function</span> () {
    <span class="class">EventEmitter</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
  };</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherit from EventEmitter.
   </p>
</td>
<td class="code">
<pre><code><span class="class">Events</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">EventEmitter</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Add <code>once</code>.
   </p>
</td>
<td class="code">
<pre><code><span class="class">Events</span>.<span class="variable">prototype</span>.<span class="variable">once</span> = <span class="keyword">function</span> (<span class="variable">type</span>, <span class="variable">listener</span>) {
    <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;
    <span class="variable">self</span>.<span class="variable">on</span>(<span class="variable">type</span>, <span class="keyword">function</span> <span class="variable">g</span>(){
      <span class="variable">self</span>.<span class="variable">removeListener</span>(<span class="variable">type</span>, <span class="variable">g</span>);
      <span class="variable">listener</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
    });
  };

}

<span class="variable">exports</span>.<span class="class">EventEmitter</span> = <span class="class">Events</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Object clone with Mongoose natives support</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  object to clone</p></li><li><p><strong>return</strong>: <em>Object</em>  cloned object</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">clone</span> = <span class="variable">exports</span>.<span class="variable">clone</span> = <span class="keyword">function</span> (<span class="variable">obj</span>) {
  <span class="keyword">if</span> (<span class="variable">obj</span> === <span class="variable">undefined</span> || <span class="variable">obj</span> === <span class="keyword">null</span>)
    <span class="keyword">return</span> <span class="variable">obj</span>;
  <span class="keyword">if</span> (<span class="class">Array</span>.<span class="variable">isArray</span>(<span class="variable">obj</span>))
    <span class="keyword">return</span> <span class="variable">cloneArray</span>(<span class="variable">obj</span>);
  <span class="keyword">if</span> (<span class="variable">obj</span>.<span class="variable">toObject</span>)
    <span class="keyword">return</span> <span class="variable">obj</span>.<span class="variable">toObject</span>();
  <span class="keyword">if</span> (<span class="variable">obj</span>.<span class="variable">constructor</span> == <span class="class">Object</span>)
    <span class="keyword">return</span> <span class="variable">cloneObject</span>(<span class="variable">obj</span>);
  <span class="keyword">if</span> (<span class="variable">obj</span>.<span class="variable">constructor</span> == <span class="class">Date</span> || <span class="variable">obj</span>.<span class="variable">constructor</span> == <span class="class">RegExp</span>
   || <span class="variable">obj</span>.<span class="variable">constructor</span> == <span class="class">Function</span>)
    <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">obj</span>.<span class="variable">constructor</span>(+<span class="variable">obj</span>);
  <span class="keyword">if</span> (<span class="variable">obj</span> <span class="variable">instanceof</span> <span class="class">ObjectId</span>)
    <span class="keyword">return</span> <span class="class">ObjectId</span>.<span class="variable">fromString</span>(<span class="class">ObjectId</span>.<span class="variable">toString</span>(<span class="variable">obj</span>));
  <span class="keyword">if</span> (<span class="variable">obj</span>.<span class="variable">valueOf</span>)
    <span class="keyword">return</span> <span class="variable">obj</span>.<span class="variable">valueOf</span>();
  <span class="keyword">return</span> <span class="variable">obj</span>;
};

<span class="keyword">function</span> <span class="variable">cloneObject</span> (<span class="variable">obj</span>) {
  <span class="keyword">var</span> <span class="variable">ret</span> = {};
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">obj</span>)
    <span class="variable">ret</span>[<span class="variable">i</span>] = <span class="variable">clone</span>(<span class="variable">obj</span>[<span class="variable">i</span>]);
  <span class="keyword">return</span> <span class="variable">ret</span>;
};

<span class="keyword">function</span> <span class="variable">cloneArray</span> (<span class="variable">arr</span>) {
  <span class="keyword">var</span> <span class="variable">ret</span> = [];
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">arr</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++)
    <span class="variable">ret</span>.<span class="variable">push</span>(<span class="variable">clone</span>(<span class="variable">arr</span>[<span class="variable">i</span>]));
  <span class="keyword">return</span> <span class="variable">ret</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Copies and merges options with defaults.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  defaults</p></li><li><p><strong>param</strong>: <em>Object</em>  supplied options</p></li><li><p><strong>return</strong>: <em>Object</em>  new (merged) object</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">options</span> = <span class="keyword">function</span> (<span class="variable">defaults</span>, <span class="variable">opts</span>){
  <span class="keyword">var</span> <span class="variable">opts</span> = <span class="variable">opts</span> || {}
    , <span class="variable">c</span> = <span class="variable">clone</span>(<span class="variable">opts</span>);
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">defaults</span>)
    <span class="keyword">if</span> (!(<span class="variable">i</span> <span class="keyword">in</span> <span class="variable">opts</span>))
      <span class="variable">c</span>[<span class="variable">i</span>] = <span class="variable">clone</span>(<span class="variable">defaults</span>[<span class="variable">i</span>]);
  <span class="keyword">return</span> <span class="variable">c</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Erases an item from an array</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Array</em>  array</p></li><li><p><strong>param</strong>: <em>Object</em>  value</p></li><li><p><strong>return</strong>: <em>undefined</em></p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">erase</span> = <span class="keyword">function</span> (<span class="variable">arr</span>, <span class="variable">item</span>) {
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">arr</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++)
    <span class="keyword">if</span> (<span class="variable">arr</span>[<span class="variable">i</span>] === <span class="variable">item</span>) <span class="variable">arr</span>.<span class="variable">splice</span>(<span class="variable">i</span>, <span class="number integer">1</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Generates a random string</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">random</span> = <span class="keyword">function</span> () {
  <span class="keyword">return</span> <span class="class">Math</span>.<span class="variable">random</span>().<span class="variable">toString</span>().<span class="variable">substr</span>(<span class="number integer">3</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>A StateMachine represents a minimal <code>interface</code> for the
constructors it builds via StateMachine.ctor(...).</p>

<ul><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">StateMachine</span> () {
  <span class="this">this</span>.<span class="variable">paths</span> = {};
  <span class="this">this</span>.<span class="variable">states</span> = {};
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>StateMachine.ctor('state1', 'state2', ...)
A factory method for subclassing StateMachine.
The arguments are a list of states. For each state,
the constructor's prototype gets state transition
methods named after each state. These transition methods
place their path argument into the given state.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  state</p></li><li><p><strong>param</strong>: <em>String</em>  [state]</p></li><li><p><strong>return</strong>: <em>Function</em>  subclass constructor</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">StateMachine</span>.<span class="variable">ctor</span> = <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">states</span> = [].<span class="variable">slice</span>.<span class="variable">call</span>(<span class="variable">arguments</span>);
  <span class="keyword">var</span> <span class="variable">ctor</span> = <span class="keyword">function</span> () {
    <span class="class">StateMachine</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
    <span class="this">this</span>.<span class="variable">stateNames</span> = <span class="variable">states</span>;
    <span class="keyword">var</span> <span class="variable">i</span> = <span class="variable">states</span>.<span class="variable">length</span>
      , <span class="variable">state</span>;
    <span class="keyword">while</span> (<span class="variable">i</span>--) {
      <span class="variable">state</span> = <span class="variable">states</span>[<span class="variable">i</span>];
      <span class="this">this</span>.<span class="variable">states</span>[<span class="variable">state</span>] = {};
    }
  };

  <span class="variable">ctor</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">StateMachine</span>.<span class="variable">prototype</span>;
  <span class="variable">states</span>.<span class="variable">forEach</span>( <span class="keyword">function</span> (<span class="variable">state</span>) {</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Changes the <code>path</code>'s state to <code>state</code>.
     </p>
</td>
<td class="code">
<pre><code><span class="variable">ctor</span>.<span class="variable">prototype</span>[<span class="variable">state</span>] = <span class="keyword">function</span> (<span class="variable">path</span>) {
      <span class="this">this</span>.<span class="variable">_changeState</span>(<span class="variable">path</span>, <span class="variable">state</span>);
    }
  });
  <span class="keyword">return</span> <span class="variable">ctor</span>;
};

<span class="class">StateMachine</span>.<span class="variable">prototype</span> = {</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>This function is wrapped by the state change functions:
- <code>require(path)</code>
- <code>modify(path)</code>
- <code>init(path)</code>
 - <strong>api</strong>: <em>private</em></p>

<p>   </p>
</td>
<td class="code">
<pre><code><span class="variable">_changeState</span>: <span class="keyword">function</span> (<span class="variable">path</span>, <span class="variable">nextState</span>) {
    <span class="keyword">var</span> <span class="variable">prevState</span> = <span class="this">this</span>.<span class="variable">paths</span>[<span class="variable">path</span>]
      , <span class="variable">prevBucket</span> = <span class="this">this</span>.<span class="variable">states</span>[<span class="variable">prevState</span>];
    <span class="keyword">delete</span> <span class="this">this</span>.<span class="variable">paths</span>[<span class="variable">path</span>];
    <span class="keyword">if</span> (<span class="variable">prevBucket</span>) <span class="keyword">delete</span> <span class="variable">prevBucket</span>[<span class="variable">path</span>];

    <span class="this">this</span>.<span class="variable">paths</span>[<span class="variable">path</span>] = <span class="variable">nextState</span>;
    <span class="this">this</span>.<span class="variable">states</span>[<span class="variable">nextState</span>][<span class="variable">path</span>] = <span class="variable">true</span>;
  },

  <span class="variable">stateOf</span>: <span class="keyword">function</span> (<span class="variable">path</span>) {
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">paths</span>[<span class="variable">path</span>];
  },</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Checks to see if at least one path is in the states passed in via <code>arguments</code>
e.g., this.some('required', 'inited')
## </p>

<ul><li><p><strong>param</strong>: <em>String</em>  state that we want to check for.</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">some</span>: <span class="keyword">function</span> () {
    <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;
    <span class="keyword">return</span> <span class="class">Array</span>.<span class="variable">prototype</span>.<span class="variable">some</span>.<span class="variable">call</span>(<span class="variable">arguments</span>.<span class="variable">length</span> ? <span class="variable">arguments</span> : <span class="this">this</span>.<span class="variable">stateNames</span>, <span class="keyword">function</span> (<span class="variable">state</span>) {
      <span class="keyword">return</span> <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">self</span>.<span class="variable">states</span>[<span class="variable">state</span>]).<span class="variable">length</span>;
    });
  },</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>This function builds the functions that get assigned to <code>forEach</code> and <code>map</code>,
since both of those methods share a lot of the same logic.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  iterMethod is either 'forEach' or 'map'</p></li><li><p><strong>return</strong>: <em>Function</em> </p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">_iter</span>: <span class="keyword">function</span> (<span class="variable">iterMethod</span>) {
    <span class="keyword">return</span> <span class="keyword">function</span> () {
      <span class="keyword">var</span> <span class="variable">numArgs</span> = <span class="variable">arguments</span>.<span class="variable">length</span>
        , <span class="variable">states</span> = [].<span class="variable">slice</span>.<span class="variable">call</span>(<span class="variable">arguments</span>, <span class="number integer">0</span>, <span class="variable">numArgs</span>-<span class="number integer">1</span>)
        , <span class="variable">callback</span> = <span class="variable">arguments</span>[<span class="variable">arguments</span>.<span class="variable">length</span>-<span class="number integer">1</span>];
      <span class="keyword">if</span> (!<span class="variable">states</span>.<span class="variable">length</span>) <span class="variable">states</span> = <span class="this">this</span>.<span class="variable">stateNames</span>;
      <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;
      <span class="keyword">var</span> <span class="variable">paths</span> = <span class="variable">states</span>.<span class="variable">reduce</span>( <span class="keyword">function</span> (<span class="variable">paths</span>, <span class="variable">state</span>) {
        <span class="keyword">return</span> <span class="variable">paths</span>.<span class="variable">concat</span>(<span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">self</span>.<span class="variable">states</span>[<span class="variable">state</span>]));
        
      }, []);
      <span class="keyword">return</span> <span class="variable">paths</span>[<span class="variable">iterMethod</span>]( <span class="keyword">function</span> (<span class="variable">path</span>) {
        <span class="keyword">return</span> <span class="variable">callback</span>(<span class="variable">path</span>);
      });
    };
  },</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Iterates over the paths that belong to one of the parameter states.</p>

<p>The function profile can look like:
this.forEach(state1, fn);         // iterates over all paths in state1
this.forEach(state1, state2, fn); // iterates over all paths in state1 or state2
this.forEach(fn);                 // iterates over all paths in all states</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  [state]</p></li><li><p><strong>param</strong>: <em>String</em>  [state]</p></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">forEach</span>: <span class="keyword">function</span> () {
    <span class="this">this</span>.<span class="variable">forEach</span> = <span class="this">this</span>.<span class="variable">_iter</span>(<span class="string">'forEach'</span>);
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">forEach</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
  },</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Maps over the paths that belong to one of the parameter states.</p>

<p>The function profile can look like:
this.forEach(state1, fn);         // iterates over all paths in state1
this.forEach(state1, state2, fn); // iterates over all paths in state1 or state2
this.forEach(fn);                 // iterates over all paths in all states</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  [state]</p></li><li><p><strong>param</strong>: <em>String</em>  [state]</p></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>return</strong>: <em>Array</em> </p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">map</span>: <span class="keyword">function</span> () {
    <span class="this">this</span>.<span class="variable">map</span> = <span class="this">this</span>.<span class="variable">_iter</span>(<span class="string">'map'</span>);
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">map</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
  }
};

<span class="variable">exports</span>.<span class="class">StateMachine</span> = <span class="class">StateMachine</span>;

<span class="variable">exports</span>.<span class="variable">inGroupsOf</span> = <span class="keyword">function</span> <span class="variable">inGroupsOf</span> (<span class="variable">card</span>, <span class="variable">arr</span>, <span class="variable">fn</span>) {
  <span class="keyword">var</span> <span class="variable">group</span> = [];
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">arr</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++) {
    <span class="keyword">if</span> (<span class="variable">i</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">i</span> % <span class="variable">card</span> === <span class="number integer">0</span>) {
      <span class="variable">fn</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">group</span>);
      <span class="variable">group</span>.<span class="variable">length</span> = <span class="number integer">0</span>;
    }
    <span class="variable">group</span>.<span class="variable">push</span>(<span class="variable">arr</span>[<span class="variable">i</span>]);
  }
  <span class="variable">fn</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">group</span>);
};
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/virtualtype.js"><a href="#">virtualtype</a></h2></td><td>lib/mongoose/virtualtype.js</td></tr><tr class="code">
<td class="docs">
<p>VirtualType constructor</p>

<p>This is what mongoose uses to define virtual attributes via
<code>Schema.prototype.virtual</code></p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">VirtualType</span> () {
  <span class="this">this</span>.<span class="variable">getters</span> = [];
  <span class="this">this</span>.<span class="variable">setters</span> = [];
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds a getter</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  fn</p></li><li><p><strong>return</strong>: <em>VirtualType</em>  this</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">VirtualType</span>.<span class="variable">prototype</span>.<span class="variable">get</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="this">this</span>.<span class="variable">getters</span>.<span class="variable">push</span>(<span class="variable">fn</span>);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Adds a setter</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  fn</p></li><li><p><strong>return</strong>: <em>VirtualType</em>  this</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">VirtualType</span>.<span class="variable">prototype</span>.<span class="variable">set</span> = <span class="keyword">function</span> (<span class="variable">fn</span>) {
  <span class="this">this</span>.<span class="variable">setters</span>.<span class="variable">push</span>(<span class="variable">fn</span>);
  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Applies getters</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value</p></li><li><p><strong>param</strong>: <em>Object</em>  scope</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">VirtualType</span>.<span class="variable">prototype</span>.<span class="variable">applyGetters</span> = <span class="keyword">function</span> (<span class="variable">value</span>, <span class="variable">scope</span>) {
  <span class="keyword">var</span> <span class="variable">v</span> = <span class="variable">value</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">l</span> = <span class="this">this</span>.<span class="variable">getters</span>.<span class="variable">length</span> - <span class="number integer">1</span>; <span class="variable">l</span> &<span class="variable">gt</span>;= <span class="number integer">0</span>; <span class="variable">l</span>--){
    <span class="variable">v</span> = <span class="this">this</span>.<span class="variable">getters</span>[<span class="variable">l</span>].<span class="variable">call</span>(<span class="variable">scope</span>, <span class="variable">v</span>);
  }
  <span class="keyword">return</span> <span class="variable">v</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Applies setters</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  value</p></li><li><p><strong>param</strong>: <em>Object</em>  scope</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">VirtualType</span>.<span class="variable">prototype</span>.<span class="variable">applySetters</span> = <span class="keyword">function</span> (<span class="variable">value</span>, <span class="variable">scope</span>) {
  <span class="keyword">var</span> <span class="variable">v</span> = <span class="variable">value</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">l</span> = <span class="this">this</span>.<span class="variable">setters</span>.<span class="variable">length</span> - <span class="number integer">1</span>; <span class="variable">l</span> &<span class="variable">gt</span>;= <span class="number integer">0</span>; <span class="variable">l</span>--){
    <span class="this">this</span>.<span class="variable">setters</span>[<span class="variable">l</span>].<span class="variable">call</span>(<span class="variable">scope</span>, <span class="variable">v</span>);
  }
  <span class="keyword">return</span> <span class="variable">v</span>;
};

<span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">VirtualType</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/mongoose/compat.js"><a href="#">compat</a></h2></td><td>lib/mongoose/compat.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">mongoose</span> = <span class="variable">require</span>(<span class="string">'./'</span>)
  , <span class="class">Mongoose</span> = <span class="variable">mongoose</span>.<span class="class">Mongoose</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Support for old way of defining models.
 - mongoose.model('Name', { definition });
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">oldModel</span> = <span class="class">Mongoose</span>.<span class="variable">prototype</span>.<span class="variable">model</span>;

<span class="class">Mongoose</span>.<span class="variable">prototype</span>.<span class="variable">model</span> = <span class="keyword">function</span>(){
  <span class="variable">oldModel</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
};

</code></pre>
</td>
</tr>	</body>
</html></tbody></table>