<html>
  <head>
    <title>Mongoose ORM</title>
    <style>
      body {
        background: url('/images/bg.png');
        padding: 0 30px 30px;
        margin-top: 0;
      }

      #wrap {
        background: url('/images/pattern.png') no-repeat -134px -211px;
        min-height: 600px;
        padding-top: 30px;
      }

      #page {
        width: 850px;
        margin: auto;
        position: relative;
      }

      #footer {
        font: 13px Helvetica;
        padding-top: 5px;
        border-top: 1px solid #000;
      }

      #content {
        color: #272727;
        font: 14px Courier;
      }

      #content h1, #content h2, #content h3 {
        text-shadow: 0 1px 0 #fff;
      }

      pre {
        background: rgba(255,255,255,.8);
        border: 1px solid #c6c6c6;
        padding: 10px;
        border-radius: 3px
      }

      code {
        background: rgba(255,255,255,.8);
        border: 1px solid #c6c6c6;
        color: #333;
        border-radius: 3px
      }

      pre code {
        border: 0 none;
      }

      form {
        position: absolute;
        right: 0;
        top: 0;
        color: #666;
        font: bold 12px Helvetica;
        text-shadow: 0 1px 0 #fff;
      }

      form img {
        margin-right: 5px
      }

      #google-members-count {
        vertical-align: top;
        line-height: 32px;
      }

      h1 a {
        background: url('/images/logo.png');
        width: 404px;
        height: 47px;
        margin-bottom: 40px;
        text-indent: -500em;
        display: block;
      }

      a {
        color: #2a758a;
        text-shadow: 0 1px 0 #fff;
        text-decoration: none;
      } 

      a:hover {
        opacity: 0.8;
      }

      #menu {
        border-top: 1px solid #1e1e1e;
        border-bottom: 1px solid #e0e0e0;
        margin-top: 10px;
        font: bold 14px Helvetica;
        background: rgba(255,255,255,.2);
      }

      #menu ul {
        margin: 0;
        border-top: 1px solid #e0e0de;
        padding: 13px 0;
        border-bottom: 1px solid #1e1e1e;
        text-align: center;
      }

      #menu ul li {
        list-style-type: none;
        display: inline;
        padding-right: 10px;
      }
    </style>

    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1122274-9']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
      
      function getMembers(data){
        if (!(data && data.query && data.query.results && data.query.results.p)) return;
        var members = document.createElement('span');
        members.id = 'google-members-count';
        members.innerHTML = '('+ data.query.results.p +' members)';
        document.getElementsByTagName('FORM')[0].insertBefore(members, document.getElementById('google-subscribe-input'));
      };

      window.onload = function(){
        // lame jsonp
        var script = document.createElement('script');
        script.src = "http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D%22http%3A%2F%2Fgroups.google.com%2Fgroup%2Fmongoose-orm%2Fabout%22%20and%20xpath%3D'%2F%2Fdiv%5B%40class%3D%5C'maincontbox%5C'%5D%2Ftable%2Ftr%5B1%5D%2Ftd%2Fp%5B1%5D'%0A&format=json&callback=getMembers";
        document.head.appendChild(script);
      };
    </script>
  </head>
  <body>
    <div id="wrap">
      <div id="page">
        <h1><a href="/">Mongoose</a></h1>

        <form action="http://groups.google.com/group/mongoose-orm/boxsubscribe">
         <a href="http://groups.google.com/group/mongoose-orm" id="google-subscribe-link"><img src="/images/groups.png" border="0"></a>
         <span id="google-members-count">&nbsp;</span>
         <div id="google-subscribe-input">
           Email: <input type="text" name="email" id="google-subscribe-email">
           <input type="submit" name="go" value="Subscribe">
         </div>
        </form>

        <div id="menu">
          <ul>
            <li><a href="/docs/model-definition.html">Model Definition</a></li>
            <li><a href="/docs/embedded-documents.html">Embedded documents</a></li>
            <li><a href="/docs/finding-documents.html">Finding documents</a></li>
            <li><a href="/docs/middleware.html">Middleware</a></li>
            <li><a href="/docs/defaults.html">Defaults</a></li>
            <li><a href="/docs/indexes.html">Indexes</a></li>
            <li><a href="/docs/validation.html">Validation</a></li>
            <li><a href="/docs/virtuals.html">Virtuals</a></li>
            <li><a href="/docs/getters-setters.html">Getters / Setters</a></li>
            <li><a href="/docs/api.html">API</a></li>
          </ul>
        </div>

        <div id="content">
          <h1>Middleware</h1>

<p>Middleware are defined at the Schema level and are applied when the methods
<code>init</code> (when a document is initialized with data from MongoDB), <code>save</code>, and
<code>remove</code> are called on a document instance.</p>

<p>There&#39;s two types of middleware, determined by the signature of the function
you define (ie: the parameters your function accepts):</p>

<ul><li><p>Serial
Serial middleware are defined like:</p><pre><code>schema.pre(&#39;save&#39;, function (next) {
  // ...
})</code></pre><p>They&#39;re executed one after the other, when each middleware calls <code>next</code>.</p></li><li><p>Parallel
Parallel middleware offer more fine-grained flow control, and are defined
like</p><pre><code>schema.pre(&#39;remove&#39;, true, function (next, done) {
  // ...
})</code></pre><p>Parallel middleware can <code>next()</code> immediately, but the final argument will be
called when all the parallel middleware have called <code>done()</code>.</p></li></ul>

<h2>Use cases</h2>

<p>Middleware are useful for:</p>

<ul><li>Complex validation</li><li>Removing dependent documents when a certain document is removed (eg:
removing a user removes all his blogposts)</li><li>Asynchronous defaults</li><li>Asynchronous tasks that a certain action triggers. For example:<ul><li>Triggering custom events</li><li>Creating notifications</li><li>Emails</li></ul></li></ul>

<p>and many other things. They&#39;re specially useful for atomizing model logic
and avoiding nested blocks of async code.</p>

<h2>Error handling</h2>

<p>If any middleware calls <code>next</code> or <code>done</code> with an <code>Error</code> instance, the flow is
interrupted, and the error is passed to the function passed as an argument.</p>

<p>For example:</p>

<pre><code>schema.pre(&#39;save&#39;, function (next) {
    // something goes wrong
    next(new Error(&#39;something went wrong&#39;));
});

// later...

myModel.save(function (err) {
  // err can come from a middleware
});</code></pre>
        </div>

        <div id="footer">
          Mongoose by <a href="http://learnboost.com">gradebook</a> <a href="http://github.com/learnboost">LearnBoost Labs</a>. Released under the MIT license - Copyright <a href="http://learnboost.com">LearnBoost 2011</a>
        </div>
      </div>
    </div>
  </body>
</html>
