<html>
  <head>
    <title>Mongoose ORM</title>
    <style>
      body {
        background: url('/images/bg.png');
        padding: 30px;
      }

      #wrap {
        background: url('/images/pattern.png') no-repeat -50px 10px;
        min-height: 600px;
      }

      #page {
        width: 800px;
        margin: auto;
        position: relative;
      }

      #content {
        color: #414141;
        font: 14px Courier;
      }
    
      #content h1, #content h2, #content h3 {
        text-shadow: 0 1px 0 #fff;
      }

      pre {
        background: rgba(255,255,255,.2);
        border: 1px solid #999;
        padding: 10px;
        color: #000;
      }

      form {
        position: absolute;
        right: 0;
        top: 0;
        color: #666;
        font: bold 12px Helvetica;
        text-shadow: 0 1px 0 #fff;
      }

      form img {
        margin-right: 5px
      }

      #google-members-count {
        vertical-align: top;
        line-height: 32px;
      }

      h1 a {
        background: url('/images/logo.png');
        width: 404px;
        height: 47px;
        margin-bottom: 40px;
        text-indent: -500em;
        display: block;
      }

      a {
        color: #2a758a;
        text-shadow: 0 1px 0 #fff;
        text-decoration: none;
      } 

      a:hover {
        opacity: 0.8;
      }

      #menu {
        border-top: 1px solid #1e1e1e;
        border-bottom: 1px solid #e0e0e0;
        margin-top: 10px;
        font: bold 17px Helvetica;
        background: rgba(255,255,255,.2);
      }

      #menu ul {
        margin: 0;
        border-top: 1px solid #e0e0de;
        padding: 13px 0;
        border-bottom: 1px solid #1e1e1e;
        text-align: center;
      }

      #menu ul li {
        list-style-type: none;
        display: inline;
        padding-right: 10px;
      }
    </style>

    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1122274-9']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
      
      function getMembers(data){
        if (!(data && data.query && data.query.results && data.query.results.p)) return;
        var members = document.createElement('span');
        members.id = 'google-members-count';
        members.innerHTML = '('+ data.query.results.p +' members)';
        document.getElementsByTagName('FORM')[0].insertBefore(members, document.getElementById('google-subscribe-input'));
      };

      window.onload = function(){
        // lame jsonp
        var script = document.createElement('script');
        script.src = "http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D%22http%3A%2F%2Fgroups.google.com%2Fgroup%2Fmongoose-orm%2Fabout%22%20and%20xpath%3D'%2F%2Fdiv%5B%40class%3D%5C'maincontbox%5C'%5D%2Ftable%2Ftr%5B1%5D%2Ftd%2Fp%5B1%5D'%0A&format=json&callback=getMembers";
        document.head.appendChild(script);
      };
    </script>
  </head>
  <body>
    <div id="wrap">
      <div id="page">
        <h1><a href="http://mongoosejs.com">Mongoose</a></h1>

        <form action="http://groups.google.com/group/mongoose-orm/boxsubscribe">
         <a href="http://groups.google.com/group/mongoose-orm" id="google-subscribe-link"><img src="/images/groups.png" border="0"></a>
         <span id="google-members-count">&nbsp;</span>
         <div id="google-subscribe-input">
           Email: <input type="text" name="email" id="google-subscribe-email">
           <input type="submit" name="go" value="Subscribe">
         </div>
        </form>

        <div id="menu">
          <ul>
            <li><a href="/docs/api.html">API</a></li>
            <li><a href="/docs/defaults.html">Defaults</a></li>
            <li><a href="/docs/embedded-documents.html">Embedded documents</a></li>
            <li><a href="/docs/indexes.html">Indexes</a></li>
            <li><a href="/docs/middleware.html">Middleware</a></li>
            <li><a href="/docs/model-definition.html">Model Definition</a></li>
            <li><a href="/docs/validation.html">Validation</a></li>
          </ul>
        </div>

        <div id="content">
          <h1>Defining a model</h1>

<p>Models are defined by passing a <code>Schema</code> instance to <code>mongoose.model</code>.</p>

<pre><code>mongoose.model('MyModel', mySchema);
// mySchema is &lt;a Schema&gt;</code></pre>

<p>You can easily access the <code>Schema</code> constructor from the <code>mongoose</code> singleton:</p>

<pre><code>var mongoose = require('mongoose')
  , Schema = mongoose.Schema;

var mySchema = new Schema({
    // my props
});</code></pre>

<p>Models are then accessed from <code>mongoose</code> if you want to use a single
connection:</p>

<pre><code>// connect the `mongoose` instance
mongoose.connect('mongodb://host/db');

var BlogPost = mongoose.model('BlogPost');</code></pre>

<p>Or from a <code>Connection</code> instance if you want to use multiple
databases/connections:</p>

<pre><code>var db = mongoose.createConnection('mongodb://host/db')
  , BlogPost = db.model('BlogPost');</code></pre>

<p><strong>Important</strong>: the actual interaction with the data happens with the <code>Model</code>
that you obtain through <code>mongoose.model</code> or <code>db.model</code>. That's the object that
you can instantiate or that you can call <code>.find()</code>, <code>.findOne()</code>, etc upon.
Don't confuse schemas and actual models!</p>

<h2>Defining your keys</h2>

<p>The <code>Schema</code> constructor receives an object representation of your schemas as
its first parameter. If you want to add more keys later, <code>Schema#add</code> provides
the same functionality.</p>

<p>Unlike older versions of mongoose, defining the data types is now a main part
of defining your models. Your schema is constructed by passing all the
JavaScript natives that you know (Schema, Number, Date) as well as others
exclusive to MongoDb (for example <code>Schema.ObjectId</code>).</p>

<pre><code>var ObjectId = Schema.ObjectId;

var PostSchema = new Schema({
    owner   : ObjectId
  , title   : String
  , date    : Date
});</code></pre>

<h3>Defining documents within documents</h3>

<p>To define an array of documents that follows a certain schema, make the value
an array with the schema constructor inside.</p>

<p>For example, let's assume we want to have a collection of comments within a
blogpost, and we want the to be subject to casting, validation, and other
functionality provided by models:</p>

<pre><code>var Comment = new Schema({
    body  : String
  , date  : Date
});

var Post = new Schema({
    title     : String
  , comments  : [Comment]
});</code></pre>

<p>This will allow you to interact very easily with subdocuments later on. For
more information, refer to the chapter on embedded documents that's part of
this documentation.</p>

<h3>Defining custom options for keys</h3>

<p>Each key that you define is internally mapped to a <code>SchemaType</code>. Bear in mind, a
Schema is not something that you interact directly with, but it's a way to
describe to Mongoose what your want your data to look like, and how you want
it to behave.</p>

<p><code>SchemaType</code>s take care of validation, casting, defaults, and other general
options. Some functionality is exclusive to certain types of <code>SchemaType</code>s, for
example only numbers support <code>min</code> and <code>max</code> values.</p>

<p>In order to customize some of these options directly from the definition of
your model, set your key to an object with the format <code>{ type: {Type}, â€¦ }</code>.</p>

<pre><code>  var Person = new Schema({
      title   : { type: String, required: true }
    , age     : { type: Number, min: 5, max: 20 }
    , meta    : {
          likes : [String]
        , birth : { type: Date, default: Date.now }
      }
  });</code></pre>

<p>Those options are functions that are called on each SchemaType.
If you want to define options later on, you could access a certain key through
the <code>path</code> function:</p>

<pre><code>Person.path('age').max(400);

Person.path('meta.birth').set(function (v) {
  // this is a setter
});

Person.path('title').validate(function (v) {
  return v.length &gt; 50;
});</code></pre>

<p>Some of the options are versatile. <code>default</code> takes a <code>Function</code> or a value.
<code>validate</code> takes a <code>Function</code> or a <code>RegExp</code>. More information on these can be
found in other chapters.</p>

<h2>Beyond keys: Middleware</h2>

<p>Middleware are special user-defined functions that are called transparently
when certain native methods are called on <code>Document</code> instances (<code>init</code>, <code>save</code>
and <code>remove</code>).</p>

<p>Let's say that you want to email a certain user when his document changes.
You'd then define a hook on the User schema like this:</p>

<pre><code>User.pre('save', function (next) {
  email(this.email, 'Your record has changed');
  next();
});</code></pre>

<p>More information about the specifics of middleware can be found in the
appropriate chapter.</p>
        </div>
      </div>
    </div>
  </body>
</html>
