<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Mongoose v5.12.2: Transactions</title><link rel="apple-touch-icon" sizes="57x57" href="images/favicon/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="images/favicon/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="images/favicon/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="images/favicon/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="images/favicon/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="images/favicon/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="images/favicon/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="images/favicon/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="images/favicon/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="images/favicon/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png"><link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans"><link rel="stylesheet" href="/docs/css/github.css"><link rel="stylesheet" href="/docs/css/mongoose5.css"><link rel="apple-touch-icon" sizes="57x57" href="images/favicon/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="images/favicon/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="images/favicon/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="images/favicon/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="images/favicon/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="images/favicon/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="images/favicon/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="images/favicon/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="images/favicon/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="images/favicon/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png"><link rel="manifest" href="images/favicon/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="images/favicon/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/docs/css/inlinecpc.css"><script type="text/javascript" src="/docs/js/native.js"></script></head><body><div id="layout"><div id="mobile-menu"><a class="menu-link" id="menuLink" href="#menu"><span></span></a><div id="mobile-logo-container"><a href="/"><img id="logo" src="/docs/images/mongoose5_62x30_transparent.png"><span class="logo-text">mongoose</span></a></div></div><div id="menu"><div class="pure-menu"><div class="pure-menu-heading" id="logo-container"><a href="/"><img id="logo" src="/docs/images/mongoose5_62x30_transparent.png"><span class="logo-text">mongoose</span></a></div><ul class="pure-menu-list" id="navbar"><li class="pure-menu-horizontal pure-menu-item pure-menu-has-children pure-menu-allow-hover version"><a class="pure-menu-link" href="#">Version 5.12.2</a><ul class="pure-menu-children"><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/4.x">Version 4.13.21</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/3.8.x">Version 3.8.40</a></li></ul></li><li class="pure-menu-item search"><input id="search-input-nav" type="text" placeholder="Search"><button id="search-button-nav"><img src="/docs/images/search.svg"></button></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/index.html">Quick Start</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/guides.html">Guides</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/guide.html">Schemas</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/schematypes.html">SchemaTypes</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/connections.html">Connections</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/models.html">Models</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/documents.html">Documents</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/subdocs.html">Subdocuments</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/queries.html">Queries</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/validation.html">Validation</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/middleware.html">Middleware</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/populate.html">Populate</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/discriminators.html">Discriminators</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/plugins.html">Plugins</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/api.html">API</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/mongoose.html">Mongoose</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/schema.html">Schema</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/connection.html">Connection</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/document.html">Document</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/model.html">Model</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/query.html">Query</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/aggregate.html">Aggregate</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/schematype.html">SchemaType</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/virtualtype.html">VirtualType</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/compatibility.html">Version Compatibility</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/faq.html">FAQ</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/further_reading.html">Further Reading</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/enterprise.html">For Enterprise</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/built-with-mongoose.html" >Built with Mongoose</a></li></ul><div class="cpc-ad"><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=mongoosejscom" id="_carbonads_js"></script></div></div></div><div class="container"><div id="content"><a class="edit-docs-link" href="https://github.com/Automattic/mongoose/blob/master/docs/transactions.pug" target="_blank">
<img src="/docs/images/pencil.svg" />
</a><h1 id="transactions-in-mongoose">Transactions in Mongoose</h1>
<script>
  _native.init("CK7DT53U",{
    targetClass: 'native-inline'
  });
</script>

<div class="native-inline">
  <a href="#native_link#"><span class="sponsor">Sponsor</span> #native_company# â€” #native_desc#</a>
</div>

<p><a href="https://www.mongodb.com/transactions">Transactions</a> are new in MongoDB
4.0 and Mongoose 5.2.0. Transactions let you execute multiple operations
in isolation and potentially undo all the operations if one of them fails.
This guide will get you started using transactions with Mongoose.</p>
<h2 id="getting-started-with-transactions">Getting Started with Transactions</h2>
<p>To create a transaction, you first need to create a session using or <a href="/docs/api/mongoose.html#mongoose_Mongoose-startSession"><code>Mongoose#startSession</code></a>
or <a href="/docs/api/connection.html#connection_Connection-startSession"><code>Connection#startSession()</code></a>.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> mongoose.startSession();</code></pre>
<p>In practice, you should use either the <a href="https://mongodb.github.io/node-mongodb-native/3.2/api/ClientSession.html#withTransaction"><code>session.withTransaction()</code> helper</a>
or Mongoose&#39;s <code>Connection#transaction()</code> function to run a transaction. The <code>session.withTransaction()</code> helper handles:</p>
<ul>
<li>Creating a transaction</li>
<li>Committing the transaction if it succeeds</li>
<li>Aborting the transaction if your operation throws</li>
<li>Retrying in the event of a <a href="https://stackoverflow.com/questions/52153538/what-is-a-transienttransactionerror-in-mongoose-or-mongodb">transient transaction error</a>.</li>
</ul>
<pre><code class="language-javascript">
<span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> Customer.startSession();

<span class="hljs-comment">// The `withTransaction()` function's first parameter is a function</span>
<span class="hljs-comment">// that returns a promise.</span>
<span class="hljs-keyword">await</span> session.withTransaction(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> Customer.create([{ <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span> }], { <span class="hljs-attr">session</span>: session })
});

<span class="hljs-keyword">const</span> count = <span class="hljs-keyword">await</span> Customer.countDocuments();
assert.strictEqual(count, <span class="hljs-number">1</span>);

session.endSession();</code></pre>
<p>For more information on the <code>ClientSession#withTransaction()</code> function, please see
<a href="https://mongodb.github.io/node-mongodb-native/3.2/api/ClientSession.html#withTransaction">the MongoDB Node.js driver docs</a>. </p>
<p>Mongoose&#39;s <code>Connection#transaction()</code> function is a wrapper around <code>withTransaction()</code> that
integrates Mongoose change tracking with transactions. For example, the <code>Connection#transaction()</code>
function handles resetting a document if you <code>save()</code> that document in a transaction that later fails.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> schema = Schema({ <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>, <span class="hljs-attr">arr</span>: [<span class="hljs-built_in">String</span>], <span class="hljs-attr">arr2</span>: [<span class="hljs-built_in">String</span>] });

<span class="hljs-keyword">const</span> Test = db.model(<span class="hljs-string">'Test'</span>, schema);

<span class="hljs-keyword">await</span> Test.createCollection();
<span class="hljs-keyword">let</span> doc = <span class="hljs-keyword">await</span> Test.create({ <span class="hljs-attr">name</span>: <span class="hljs-string">'foo'</span>, <span class="hljs-attr">arr</span>: [<span class="hljs-string">'bar'</span>], <span class="hljs-attr">arr2</span>: [<span class="hljs-string">'foo'</span>] });
doc = <span class="hljs-keyword">await</span> Test.findById(doc);
<span class="hljs-keyword">await</span> db.
  transaction(<span class="hljs-keyword">async</span> (session) =&gt; {
    doc.arr.pull(<span class="hljs-string">'bar'</span>);
    doc.arr2.push(<span class="hljs-string">'bar'</span>);

    <span class="hljs-keyword">await</span> doc.save({ session });
    doc.name = <span class="hljs-string">'baz'</span>;
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Oops'</span>);
  }).
  catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    assert.equal(err.message, <span class="hljs-string">'Oops'</span>);
  });

<span class="hljs-keyword">const</span> changes = doc.getChanges();
assert.equal(changes.$<span class="hljs-keyword">set</span>.name, 'baz');
assert.deepEqual(changes.$pullAll.arr, ['bar']);
assert.deepEqual(changes.$push.arr2, { $each: [<span class="hljs-string">'bar'</span>] });
assert.ok(!changes.$<span class="hljs-keyword">set</span>.arr2);

await doc.save({ session: <span class="hljs-literal">null</span> });

<span class="hljs-keyword">const</span> newDoc = <span class="hljs-keyword">await</span> Test.findById(doc);
assert.equal(newDoc.name, <span class="hljs-string">'baz'</span>);
assert.deepEqual(newDoc.arr, []);
assert.deepEqual(newDoc.arr2, [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>]);</code></pre>
<h2 id="with-mongoose-documents-and-save">With Mongoose Documents and <code>save()</code></h2>
<p>If you get a <a href="/docs/documents.html">Mongoose document</a> from <a href="/docs/api.html#findone_findOne"><code>findOne()</code></a>
or <a href="/docs/api.html#find_find"><code>find()</code></a> using a session, the document will
keep a reference to the session and use that session for <a href="/docs/api.html#document_Document-save"><code>save()</code></a>.</p>
<p>To get/set the session associated with a given document, use <a href="/docs/api.html#document_Document-$session"><code>doc.$session()</code></a>.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> User = db.model(<span class="hljs-string">'User'</span>, <span class="hljs-keyword">new</span> Schema({ <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span> }));
<span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> db.startSession();

<span class="hljs-keyword">await</span> session.withTransaction(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">await</span> User.create({ <span class="hljs-attr">name</span>: <span class="hljs-string">'foo'</span> });

  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">'foo'</span> }).session(session);
  <span class="hljs-comment">// Getter/setter for the session associated with this document.</span>
  assert.ok(user.$session());
  user.name = <span class="hljs-string">'bar'</span>;
  <span class="hljs-comment">// By default, `save()` uses the associated session</span>
  <span class="hljs-keyword">await</span> user.save();

  <span class="hljs-comment">// Won't find the doc because `save()` is part of an uncommitted transaction</span>
  <span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">await</span> User.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">'bar'</span> });
  assert.ok(!doc);
});

session.endSession();

<span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">await</span> User.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">'bar'</span> });
assert.ok(doc);</code></pre>
<h2 id="with-the-aggregation-framework">With the Aggregation Framework</h2>
<p>The <code>Model.aggregate()</code> function also supports transactions. Mongoose
aggregations have a <a href="/docs/api.html#aggregate_Aggregate-session"><code>session()</code> helper</a>
that sets the <a href="/docs/api.html#aggregate_Aggregate-option"><code>session</code> option</a>.
Below is an example of executing an aggregation within a transaction.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> Event = db.model(<span class="hljs-string">'Event'</span>, <span class="hljs-keyword">new</span> Schema({ <span class="hljs-attr">createdAt</span>: <span class="hljs-built_in">Date</span> }), <span class="hljs-string">'Event'</span>);
<span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> db.startSession();

<span class="hljs-keyword">await</span> session.withTransaction(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">await</span> Event.insertMany([
    { <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2018-06-01'</span>) },
    { <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2018-06-02'</span>) },
    { <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2017-06-01'</span>) },
    { <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2017-05-31'</span>) }
  ], { <span class="hljs-attr">session</span>: session });

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> Event.aggregate([
    {
      <span class="hljs-attr">$group</span>: {
        <span class="hljs-attr">_id</span>: {
          <span class="hljs-attr">month</span>: { <span class="hljs-attr">$month</span>: <span class="hljs-string">'$createdAt'</span> },
          <span class="hljs-attr">year</span>: { <span class="hljs-attr">$year</span>: <span class="hljs-string">'$createdAt'</span> }
        },
        <span class="hljs-attr">count</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-number">1</span> }
      }
    },
    { <span class="hljs-attr">$sort</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">-1</span>, <span class="hljs-string">'_id.year'</span>: <span class="hljs-number">-1</span>, <span class="hljs-string">'_id.month'</span>: <span class="hljs-number">-1</span> } }
  ]).session(session);

  assert.deepEqual(res, [
    { <span class="hljs-attr">_id</span>: { <span class="hljs-attr">month</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">2018</span> }, <span class="hljs-attr">count</span>: <span class="hljs-number">2</span> },
    { <span class="hljs-attr">_id</span>: { <span class="hljs-attr">month</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">2017</span> }, <span class="hljs-attr">count</span>: <span class="hljs-number">1</span> },
    { <span class="hljs-attr">_id</span>: { <span class="hljs-attr">month</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">2017</span> }, <span class="hljs-attr">count</span>: <span class="hljs-number">1</span> }
  ]);
});

session.endSession();</code></pre>
<h2 id="advanced-usage">Advanced Usage</h2>
<p>Advanced users who want more fine-grained control over when they commit or abort transactions
can use <code>session.startTransaction()</code> to start a transaction:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> Customer = db.model(<span class="hljs-string">'Customer'</span>, <span class="hljs-keyword">new</span> Schema({ <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span> }));

<span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> db.startSession();
session.startTransaction();

<span class="hljs-comment">// This `create()` is part of the transaction because of the `session`</span>
<span class="hljs-comment">// option.</span>
<span class="hljs-keyword">await</span> Customer.create([{ <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span> }], { <span class="hljs-attr">session</span>: session });

<span class="hljs-comment">// Transactions execute in isolation, so unless you pass a `session`</span>
<span class="hljs-comment">// to `findOne()` you won't see the document until the transaction</span>
<span class="hljs-comment">// is committed.</span>
<span class="hljs-keyword">let</span> doc = <span class="hljs-keyword">await</span> Customer.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span> });
assert.ok(!doc);

<span class="hljs-comment">// This `findOne()` will return the doc, because passing the `session`</span>
<span class="hljs-comment">// means this `findOne()` will run as part of the transaction.</span>
doc = <span class="hljs-keyword">await</span> Customer.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span> }).session(session);
assert.ok(doc);

<span class="hljs-comment">// Once the transaction is committed, the write operation becomes</span>
<span class="hljs-comment">// visible outside of the transaction.</span>
<span class="hljs-keyword">await</span> session.commitTransaction();
doc = <span class="hljs-keyword">await</span> Customer.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span> });
assert.ok(doc);

session.endSession();</code></pre>
<p>You can also use <code>session.abortTransaction()</code> to abort a transaction:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> Customer.startSession();
session.startTransaction();

<span class="hljs-keyword">await</span> Customer.create([{ <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span> }], { <span class="hljs-attr">session</span>: session });
<span class="hljs-keyword">await</span> Customer.create([{ <span class="hljs-attr">name</span>: <span class="hljs-string">'Test2'</span> }], { <span class="hljs-attr">session</span>: session });

<span class="hljs-keyword">await</span> session.abortTransaction();

<span class="hljs-keyword">const</span> count = <span class="hljs-keyword">await</span> Customer.countDocuments();
assert.strictEqual(count, <span class="hljs-number">0</span>);

session.endSession();</code></pre>
</div></div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname,
  hash: window.location.hash
}));</script><script type="text/javascript" src="/docs/js/navbar-search.js"></script><script type="text/javascript">(function (window, document) {
  var layout   = document.getElementById('layout'),
      menu     = document.getElementById('menu'),
      menuLink = document.getElementById('menuLink'),
      content  = document.getElementById('content');

  function toggleClass(element, className) {
      var classes = element.className.split(/\s+/),
          length = classes.length,
          i = 0;

      for(; i < length; i++) {
        if (classes[i] === className) {
          classes.splice(i, 1);
          break;
        }
      }
      // The className is not found
      if (length === classes.length) {
          classes.push(className);
      }

      element.className = classes.join(' ');
  }

  function toggleAll(e) {
      var active = 'active';

      e.preventDefault();
      toggleClass(layout, active);
      toggleClass(menu, active);
      toggleClass(menuLink, active);
  }

  menuLink.onclick = function (e) {
      toggleAll(e);
  };

  content.onclick = function(e) {
      if (menu.className.indexOf('active') !== -1) {
          toggleAll(e);
      }
  };

}(this, this.document));</script></div></body></html>