<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Mongoose v9.1.5: Transactions</title><script>(function() {
  var theme = localStorage.getItem('mongoose-theme');
  if (theme) {
    document.documentElement.setAttribute('data-theme', theme);
  }
})();</script><link rel="apple-touch-icon" sizes="57x57" href="/docs/images/favicon/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/docs/images/favicon/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/docs/images/favicon/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/docs/images/favicon/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/docs/images/favicon/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/docs/images/favicon/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/docs/images/favicon/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/docs/images/favicon/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/docs/images/favicon/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/docs/images/favicon/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/docs/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/docs/images/favicon/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/docs/images/favicon/favicon-16x16.png"><link rel="manifest" href="/docs/images/favicon/manifest.json"><link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css" integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47" crossorigin="anonymous"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans"><link rel="stylesheet" href="/docs/css/mongoose5.css?v=1769713446213"><link rel="stylesheet" href="/docs/css/github.css?v=1769713446213"><link rel="stylesheet" href="/docs/css/carbonads.css"><link rel="stylesheet" href="/docs/css/copy-code.css"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/docs/images/favicon/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/docs/css/inlinecpc.css"><script type="text/javascript" src="/docs/js/native.js"></script><style>p { line-height: 1.5em }
</style></head><body><div id="layout"><div id="theme-toggle"><button id="theme-toggle-btn" aria-label="Toggle dark mode" title="Toggle dark/light theme"><svg id="theme-icon-light" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
<svg id="theme-icon-dark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button></div><div id="mobile-menu"><a class="menu-link" id="menuLink" href="#menu"><svg width="100%" height="100%" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></a><div id="mobile-logo-container"><a href="/"><span id="logo" role="img" aria-label="Mongoose logo"></span><span class="logo-text">mongoose</span></a></div></div><div id="menu"><nav class="pure-menu"><div class="pure-menu-heading" id="logo-container"><a href="/"><span id="logo" role="img" aria-label="Mongoose logo"></span><span class="logo-text">mongoose</span></a></div><ul class="pure-menu-list" id="navbar"><li class="pure-menu-horizontal pure-menu-item pure-menu-has-children pure-menu-allow-hover version"><a class="pure-menu-link" href="/docs/index.html">Version 9.1.5</a><ul class="pure-menu-children"><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/8.x/index.html">Version 8.22.0</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/7.x/index.html">Version 7.8.8</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/6.x/index.html">Version 6.13.8</a></li></ul></li><li class="pure-menu-item search"><input id="search-input-nav" type="text" placeholder="Search"><button id="search-button-nav"><img src="/docs/images/search.svg"></button></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/index.html">Quick Start</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/guides.html">Guides</a><ul class="pure-menu-list"><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/guide.html">Schemas</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/schematypes.html">SchemaTypes</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/connections.html">Connections</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/models.html">Models</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/documents.html">Documents</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/subdocs.html">Subdocuments</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/queries.html">Queries</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/validation.html">Validation</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/middleware.html">Middleware</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/populate.html">Populate</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/discriminators.html">Discriminators</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/plugins.html">Plugins</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/timestamps.html">Timestamps</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link selected" href="/docs/transactions.html">Transactions</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/typescript.html">TypeScript</a></li></ul></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/api/mongoose.html">API</a><ul class="pure-menu-list"><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/mongoose.html">Mongoose</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/schema.html">Schema</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/connection.html">Connection</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/document.html">Document</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/model.html">Model</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/query.html">Query</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/aggregate.html">Aggregate</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/schematype.html">SchemaType</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="/docs/api/virtualtype.html">VirtualType</a></li></ul></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/migrating_to_9.html">Migration Guide</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/compatibility.html">Version Compatibility</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/version-support.html">Version Support</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/faq.html">FAQ</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/further_reading.html">Further Reading</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/enterprise.html">For Enterprise</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/docs/sponsors.html" >Sponsors</a></li></ul><div class="cpc-ad"><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CKYIL27I&placement=mongoosejscom" id="_carbonads_js"></script></div></nav></div><div class="container"><div id="content"><a class="edit-docs-link" href="https://github.com/Automattic/mongoose/blob/master/docs/transactions.md" target="_blank">
<img src="/docs/images/pencil.svg" />
</a><h1 id="transactions-in-mongoose">
        <a href="#transactions-in-mongoose">
          Transactions in Mongoose
        </a>
      </h1>
<div class="sponsored-ad">
  <a href="https://localizejs.com/?utm_campaign=Mongoose&utm_source=mongoose&utm_medium=banner">
    <img src="/docs/images/localize-mongoose-ad-banner-2x.jpg">
  </a>
</div>

<p><a href="https://www.mongodb.com/transactions">Transactions</a> let you execute multiple operations in isolation and potentially undo all the operations if one of them fails.
This guide will get you started using transactions with Mongoose.</p>
<h2 id="getting-started-with-transactions">
        <a href="#getting-started-with-transactions">
          Getting Started with Transactions 
        </a>
      </h2>
<p>If you haven&#39;t already, import mongoose:</p>
<pre><code lang="javascript"><span class="hljs-keyword">import</span> mongoose <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;mongoose&#x27;</span>;</code></pre><p>To create a transaction, you first need to create a session using <a href="api/mongoose.html#mongoose_Mongoose-startSession"><code>Mongoose#startSession</code></a>
or <a href="api/connection.html#connection_Connection-startSession"><code>Connection#startSession()</code></a>.</p>
<pre><code lang="javascript"><span class="hljs-comment">// Using Mongoose&#x27;s default connection</span>
<span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> mongoose.<span class="hljs-title function_">startSession</span>();

<span class="hljs-comment">// Using custom connection</span>
<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">await</span> mongoose.<span class="hljs-title function_">createConnection</span>(mongodbUri).<span class="hljs-title function_">asPromise</span>();
<span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">startSession</span>();</code></pre><p>In practice, you should use either the <a href="https://mongodb.github.io/node-mongodb-native/3.2/api/ClientSession.html#withTransaction"><code>session.withTransaction()</code> helper</a>
or Mongoose&#39;s <code>Connection#transaction()</code> function to run a transaction. The <code>session.withTransaction()</code> helper handles:</p>
<ul>
<li>Creating a transaction</li>
<li>Committing the transaction if it succeeds</li>
<li>Aborting the transaction if your operation throws</li>
<li>Retrying in the event of a <a href="https://stackoverflow.com/questions/52153538/what-is-a-transienttransactionerror-in-mongoose-or-mongodb">transient transaction error</a>.</li>
</ul>
<pre><code lang="javascript"><span class="hljs-keyword">let</span> session = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">return</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">createCollection</span>().
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">startSession</span>()).
  <span class="hljs-comment">// The `withTransaction()` function&#x27;s first parameter is a function</span>
  <span class="hljs-comment">// that returns a promise.</span>
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">_session</span> =&gt;</span> {
    session = _session;
    <span class="hljs-keyword">return</span> session.<span class="hljs-title function_">withTransaction</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">create</span>([{ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Test&#x27;</span> }], { <span class="hljs-attr">session</span>: session });
    });
  }).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">countDocuments</span>()).
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> assert.<span class="hljs-title function_">strictEqual</span>(count, <span class="hljs-number">1</span>)).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> session.<span class="hljs-title function_">endSession</span>());</code></pre><p>For more information on the <code>ClientSession#withTransaction()</code> function, please see
<a href="https://mongodb.github.io/node-mongodb-native/3.2/api/ClientSession.html#withTransaction">the MongoDB Node.js driver docs</a>.</p>
<p>Mongoose&#39;s <code>Connection#transaction()</code> function is a wrapper around <code>withTransaction()</code> that
integrates Mongoose change tracking with transactions.
For example, suppose you <code>save()</code> a document in a transaction that later fails.
The changes in that document are not persisted to MongoDB.
The <code>Connection#transaction()</code> function informs Mongoose change tracking that the <code>save()</code> was rolled back, and marks all fields that were changed in the transaction as modified.</p>
<pre><code lang="javascript"><span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Will Riker&#x27;</span> });

<span class="hljs-keyword">await</span> db.<span class="hljs-title function_">transaction</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setRank</span>(<span class="hljs-params">session</span>) {
  doc.<span class="hljs-property">name</span> = <span class="hljs-string">&#x27;Captain&#x27;</span>;
  <span class="hljs-keyword">await</span> doc.<span class="hljs-title function_">save</span>({ session });
  doc.<span class="hljs-property">isNew</span>; <span class="hljs-comment">// false</span>

  <span class="hljs-comment">// Throw an error to abort the transaction</span>
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Oops!&#x27;</span>);
}, { <span class="hljs-attr">readPreference</span>: <span class="hljs-string">&#x27;primary&#x27;</span> }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {});

<span class="hljs-comment">// true, `transaction()` reset the document&#x27;s state because the</span>
<span class="hljs-comment">// transaction was aborted.</span>
doc.<span class="hljs-property">isNew</span>;</code></pre><h2 id="note-about-parallelism-in-transactions">
        <a href="#note-about-parallelism-in-transactions">
          Note About Parallelism in Transactions 
        </a>
      </h2>
<p>Running operations in parallel is <strong>not supported</strong> during a transaction.
The use of <code>Promise.all</code>, <code>Promise.allSettled</code>, <code>Promise.race</code>, etc. to parallelize operations inside a transaction is undefined behaviour and should be avoided.</p>
<p>MongoDB also does not support multiple transactions on the same session in parallel.
This also means MongoDB does not support nested transactions on the same session.
The following code will throw a <code>Transaction already in progress</code> error.</p>
<pre><code lang="javascript"><span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Will Riker&#x27;</span> });

<span class="hljs-keyword">await</span> db.<span class="hljs-title function_">transaction</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setRank</span>(<span class="hljs-params">session</span>) {
  <span class="hljs-comment">// This throws `Transaction already in progress` because there is already a transaction</span>
  <span class="hljs-comment">// in progress for this session.</span>
  <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">withTransaction</span>(<span class="hljs-title function_">async</span> () =&gt; {});
});</code></pre><h2 id="with-mongoose-documents-and-save">
        <a href="#with-mongoose-documents-and-save">
          With Mongoose Documents and <code>save()</code> 
        </a>
      </h2>
<p>If you get a <a href="documents.html">Mongoose document</a> from <a href="api/model.html#model_Model-findOne"><code>findOne()</code></a>
or <a href="api/model.html#model_Model-find"><code>find()</code></a> using a session, the document will
keep a reference to the session and use that session for <a href="api/document.html#document_Document-save"><code>save()</code></a>.</p>
<p>To get/set the session associated with a given document, use <a href="api/document.html#document_Document-$session"><code>doc.$session()</code></a>.</p>
<pre><code lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">User</span> = db.<span class="hljs-title function_">model</span>(<span class="hljs-string">&#x27;User&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({ <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span> }));

<span class="hljs-keyword">let</span> session = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">return</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">createCollection</span>().
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> db.<span class="hljs-title function_">startSession</span>()).
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">_session</span> =&gt;</span> {
    session = _session;
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">create</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;foo&#x27;</span> });
  }).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    session.<span class="hljs-title function_">startTransaction</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;foo&#x27;</span> }).<span class="hljs-title function_">session</span>(session);
  }).
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
    <span class="hljs-comment">// Getter/setter for the session associated with this document.</span>
    assert.<span class="hljs-title function_">ok</span>(user.$session());
    user.<span class="hljs-property">name</span> = <span class="hljs-string">&#x27;bar&#x27;</span>;
    <span class="hljs-comment">// By default, `save()` uses the associated session</span>
    <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">save</span>();
  }).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;bar&#x27;</span> })).
  <span class="hljs-comment">// Won&#x27;t find the doc because `save()` is part of an uncommitted transaction</span>
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">doc</span> =&gt;</span> assert.<span class="hljs-title function_">ok</span>(!doc)).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> session.<span class="hljs-title function_">commitTransaction</span>()).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> session.<span class="hljs-title function_">endSession</span>()).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;bar&#x27;</span> })).
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">doc</span> =&gt;</span> assert.<span class="hljs-title function_">ok</span>(doc));</code></pre><h2 id="with-the-aggregation-framework">
        <a href="#with-the-aggregation-framework">
          With the Aggregation Framework 
        </a>
      </h2>
<p>The <code>Model.aggregate()</code> function also supports transactions. Mongoose
aggregations have a <a href="api/aggregate.html#aggregate_Aggregate-session"><code>session()</code> helper</a>
that sets the <a href="api/aggregate.html#aggregate_Aggregate-option"><code>session</code> option</a>.
Below is an example of executing an aggregation within a transaction.</p>
<pre><code lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Event</span> = db.<span class="hljs-title function_">model</span>(<span class="hljs-string">&#x27;Event&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({ <span class="hljs-attr">createdAt</span>: <span class="hljs-title class_">Date</span> }), <span class="hljs-string">&#x27;Event&#x27;</span>);

<span class="hljs-keyword">let</span> session = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">return</span> <span class="hljs-title class_">Event</span>.<span class="hljs-title function_">createCollection</span>().
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> db.<span class="hljs-title function_">startSession</span>()).
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">_session</span> =&gt;</span> {
    session = _session;
    session.<span class="hljs-title function_">startTransaction</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Event</span>.<span class="hljs-title function_">insertMany</span>([
      { <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&#x27;2018-06-01&#x27;</span>) },
      { <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&#x27;2018-06-02&#x27;</span>) },
      { <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&#x27;2017-06-01&#x27;</span>) },
      { <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">&#x27;2017-05-31&#x27;</span>) }
    ], { <span class="hljs-attr">session</span>: session });
  }).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Event</span>.<span class="hljs-title function_">aggregate</span>([
    {
      <span class="hljs-attr">$group</span>: {
        <span class="hljs-attr">_id</span>: {
          <span class="hljs-attr">month</span>: { <span class="hljs-attr">$month</span>: <span class="hljs-string">&#x27;$createdAt&#x27;</span> },
          <span class="hljs-attr">year</span>: { <span class="hljs-attr">$year</span>: <span class="hljs-string">&#x27;$createdAt&#x27;</span> }
        },
        <span class="hljs-attr">count</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-number">1</span> }
      }
    },
    { <span class="hljs-attr">$sort</span>: { <span class="hljs-attr">count</span>: -<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;_id.year&#x27;</span>: -<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;_id.month&#x27;</span>: -<span class="hljs-number">1</span> } }
  ]).<span class="hljs-title function_">session</span>(session)).
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> assert.<span class="hljs-title function_">deepEqual</span>(res, [
    { <span class="hljs-attr">_id</span>: { <span class="hljs-attr">month</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">2018</span> }, <span class="hljs-attr">count</span>: <span class="hljs-number">2</span> },
    { <span class="hljs-attr">_id</span>: { <span class="hljs-attr">month</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">2017</span> }, <span class="hljs-attr">count</span>: <span class="hljs-number">1</span> },
    { <span class="hljs-attr">_id</span>: { <span class="hljs-attr">month</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">2017</span> }, <span class="hljs-attr">count</span>: <span class="hljs-number">1</span> }
  ])).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> session.<span class="hljs-title function_">commitTransaction</span>()).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> session.<span class="hljs-title function_">endSession</span>());</code></pre><h2 id="asynclocalstorage">
        <a href="#asynclocalstorage">
          Using AsyncLocalStorage 
        </a>
      </h2>
<p>One major pain point with transactions in Mongoose is that you need to remember to set the <code>session</code> option on every operation.
If you don&#39;t, your operation will execute outside of the transaction.
Mongoose 8.4 is able to set the <code>session</code> operation on all operations within a <code>Connection.prototype.transaction()</code> executor function using Node&#39;s <a href="https://nodejs.org/api/async_context.html#class-asynclocalstorage">AsyncLocalStorage API</a>.
Set the <code>transactionAsyncLocalStorage</code> option using <code>mongoose.set(&#39;transactionAsyncLocalStorage&#39;, true)</code> to enable this feature.</p>
<pre><code lang="javascript">mongoose.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;transactionAsyncLocalStorage&#x27;</span>, <span class="hljs-literal">true</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title class_">Test</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">&#x27;Test&#x27;</span>, mongoose.<span class="hljs-title class_">Schema</span>({ <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span> }));

<span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;test&#x27;</span> });

<span class="hljs-comment">// Save a new doc in a transaction that aborts</span>
<span class="hljs-keyword">await</span> connection.<span class="hljs-title function_">transaction</span>(<span class="hljs-title function_">async</span>() =&gt; {
  <span class="hljs-keyword">await</span> doc.<span class="hljs-title function_">save</span>(); <span class="hljs-comment">// Notice no session here</span>
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Oops&#x27;</span>);
}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {});

<span class="hljs-comment">// false, `save()` was rolled back</span>
<span class="hljs-keyword">await</span> <span class="hljs-title class_">Test</span>.<span class="hljs-title function_">exists</span>({ <span class="hljs-attr">_id</span>: doc.<span class="hljs-property">_id</span> });</code></pre><p>With <code>transactionAsyncLocalStorage</code>, you no longer need to pass sessions to every operation.
Mongoose will add the session by default under the hood.</p>
<p><code>transactionAsyncLocalStorage</code> creates a new session each time you call <code>connection.transaction()</code>.
This means each transaction will have its own session and be independent of other transactions.
This also means that nested transactions are also independent of each other.</p>
<pre><code lang="javascript"><span class="hljs-keyword">await</span> mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">transaction</span>(<span class="hljs-title function_">async</span> () =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">create</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;John&#x27;</span> });
  <span class="hljs-comment">// This starts an independent transaction - this transaction will **NOT**</span>
  <span class="hljs-comment">// be rolled back even though it is within another `transaction()` call</span>
  <span class="hljs-keyword">await</span> mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">transaction</span>(<span class="hljs-title function_">async</span> () =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">create</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Jane&#x27;</span> });
  });
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Fail the top-level transaction&#x27;</span>);
});</code></pre><p>However, if the nested transaction fails, the top-level transaction will still be rolled back because <code>await mongoose.connection.transaction()</code> throws.</p>
<pre><code lang="javascript"><span class="hljs-keyword">await</span> mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">transaction</span>(<span class="hljs-title function_">async</span> () =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">create</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;John&#x27;</span> });
  <span class="hljs-keyword">await</span> mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">transaction</span>(<span class="hljs-title function_">async</span> () =&gt; {
    <span class="hljs-comment">// This causes both transactions to roll back, but only because this error bubbles up.</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Fail the nested transaction&#x27;</span>);
  });
});</code></pre><h2 id="advanced-usage">
        <a href="#advanced-usage">
          Advanced Usage 
        </a>
      </h2>
<p>Advanced users who want more fine-grained control over when they commit or abort transactions
can use <code>session.startTransaction()</code> to start a transaction:</p>
<pre><code lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Customer</span> = db.<span class="hljs-title function_">model</span>(<span class="hljs-string">&#x27;Customer&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({ <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span> }));

<span class="hljs-keyword">let</span> session = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">return</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">createCollection</span>().
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> db.<span class="hljs-title function_">startSession</span>()).
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">_session</span> =&gt;</span> {
    session = _session;
    <span class="hljs-comment">// Start a transaction</span>
    session.<span class="hljs-title function_">startTransaction</span>();
    <span class="hljs-comment">// This `create()` is part of the transaction because of the `session`</span>
    <span class="hljs-comment">// option.</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">create</span>([{ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Test&#x27;</span> }], { <span class="hljs-attr">session</span>: session });
  }).
  <span class="hljs-comment">// Transactions execute in isolation, so unless you pass a `session`</span>
  <span class="hljs-comment">// to `findOne()` you won&#x27;t see the document until the transaction</span>
  <span class="hljs-comment">// is committed.</span>
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Test&#x27;</span> })).
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">doc</span> =&gt;</span> assert.<span class="hljs-title function_">ok</span>(!doc)).
  <span class="hljs-comment">// This `findOne()` will return the doc, because passing the `session`</span>
  <span class="hljs-comment">// means this `findOne()` will run as part of the transaction.</span>
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Test&#x27;</span> }).<span class="hljs-title function_">session</span>(session)).
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">doc</span> =&gt;</span> assert.<span class="hljs-title function_">ok</span>(doc)).
  <span class="hljs-comment">// Once the transaction is committed, the write operation becomes</span>
  <span class="hljs-comment">// visible outside of the transaction.</span>
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> session.<span class="hljs-title function_">commitTransaction</span>()).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Test&#x27;</span> })).
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">doc</span> =&gt;</span> assert.<span class="hljs-title function_">ok</span>(doc)).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> session.<span class="hljs-title function_">endSession</span>());</code></pre><p>You can also use <code>session.abortTransaction()</code> to abort a transaction:</p>
<pre><code lang="javascript"><span class="hljs-keyword">let</span> session = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">return</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">createCollection</span>().
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">startSession</span>()).
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">_session</span> =&gt;</span> {
    session = _session;
    session.<span class="hljs-title function_">startTransaction</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">create</span>([{ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Test&#x27;</span> }], { <span class="hljs-attr">session</span>: session });
  }).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">create</span>([{ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Test2&#x27;</span> }], { <span class="hljs-attr">session</span>: session })).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> session.<span class="hljs-title function_">abortTransaction</span>()).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Customer</span>.<span class="hljs-title function_">countDocuments</span>()).
  <span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> assert.<span class="hljs-title function_">strictEqual</span>(count, <span class="hljs-number">0</span>)).
  <span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> session.<span class="hljs-title function_">endSession</span>());</code></pre></div></div><div id="jobs"><div class="button jobs-view-more"><a href="/docs/jobs.html">View more jobs!</a></div></div><script type="text/javascript" src="/docs/js/navbar-search.js"></script><script type="text/javascript" src="/docs/js/mobile-navbar-toggle.js"></script><script type="text/javascript" src="/docs/js/theme-toggle.js"></script><script type="text/javascript" src="/docs/js/copy-code.js"></script></div></body></html>